cscope 15 $HOME/Image/dongles/Micromax/Linux -q 0000001176 0000146952
	@driver/doshift/lcdoshift.c

1 *
	gv”siÚ
="1.0.0";

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

6 
	~<as£¹.h
>

7 
	~<sigÇl.h
>

8 
	~<ùy³.h
>

9 
	~<g‘İt.h
>

10 
	~<sy¦og.h
>

12 
	~<usb.h
>

13 
	~"lcdoshiá.h
"

15 
	#LINE_DIM
 1024

	)

16 
	#BUF_SIZE
 4096

	)

17 
	#DESCR_MAX
 129

	)

19 
	#SHOW_PROGRESS
 ià(
show_´og»ss
è
´štf


	)

21 
wr™e_bulk
(
’dpošt
, *
mes§ge
, 
Ëngth
);

22 
»ad_bulk
(
’dpošt
, *
bufãr
, 
Ëngth
);

24 
fšd_fœ¡_bulk_ouut_’dpošt
(
usb_deviû
 *
dev
);

25 
fšd_fœ¡_bulk_šput_’dpošt
(
usb_deviû
 *
dev
);

27 *
	gTempPP
=
NULL
;

29 
usb_deviû
 *
	gdev
;

30 
usb_dev_hªdË
 *
	gdevh
;

32 
	gDeçuÉV’dÜ
=0x1c9e, 
	gDeçuÉProduù
=0, 
	gT¬g‘V’dÜ
=0, 
	gT¬g‘Produù
=0, 
	gT¬g‘CÏss
=0;

33 
	gMes§geEndpošt
=0, 
	gRe¥Ú£Endpošt
=0, 
	gdeçuÉCÏss
=0;

34 
	grg‘DeviûCouÁ
=0;

35 
	gdevnum
=-1, 
	gbu¢um
=-1;

36 
	g»t
;

38 
	gD‘achStÜageOÆy
=0, 
	gHuaweiMode
=0, 
	gS›¼aMode
=0, 
	gSÚyMode
=0, 
	gGCTMode
=0;

39 
	gv”bo£
=0, 
	gshow_´og»ss
=1, 
	gRe£tUSB
=0, 
	gCheckSucûss
=0, 
	gcÚfig_»ad
=0;

40 
	gN“dRe¥Ú£
=0, 
	gInquœeDeviû
=0, 
	gsysmode
=0;

42 
	gimªuçù
[
DESCR_MAX
], 
	groduù
[DESCR_MAX], 
	gi£rŸl
[DESCR_MAX];

44 
	gMes§geCÚ‹Á
[
LINE_DIM
] = "55534243123456780000000080000606f50402527000000000000000000000";

45 
	gT¬g‘ProduùLi¡
[
LINE_DIM
];

46 
	gBy‹SŒšg
[
LINE_DIM
/2];

47 
	gbufãr
[
BUF_SIZE
];

50 
	gIÁ”çû
 = 0, 
	gCÚfigu¿tiÚ
 = -1, 
	gAÉS‘tšg
 = -1;

53 
İtiÚ
 
	glÚg_İtiÚs
[] = {

54 {"h–p", 
no_¬gum’t
, 0, 'h'},

55 {"v”siÚ", 
no_¬gum’t
, 0, 'e'},

56 {"deçuÉ-v’dÜ", 
»quœed_¬gum’t
, 0, 'v'},

57 {"deçuÉ-´oduù", 
»quœed_¬gum’t
, 0, 'p'},

58 {"rg‘-v’dÜ", 
»quœed_¬gum’t
, 0, 'V'},

59 {"rg‘-´oduù", 
»quœed_¬gum’t
, 0, 'P'},

60 {"rg‘-şass", 
»quœed_¬gum’t
, 0, 'C'},

61 {"mes§ge-’dpošt", 
»quœed_¬gum’t
, 0, 'm'},

62 {"mes§ge-cÚ‹Á", 
»quœed_¬gum’t
, 0, 'M'},

63 {"»¥Ú£-’dpošt", 
»quœed_¬gum’t
, 0, 'r'},

64 {"d‘ach-Úly", 
no_¬gum’t
, 0, 'd'},

65 {"huawei-mode", 
no_¬gum’t
, 0, 'H'},

66 {"s›¼a-mode", 
no_¬gum’t
, 0, 'S'},

67 {"sÚy-mode", 
no_¬gum’t
, 0, 'O'},

68 {"gù-mode", 
no_¬gum’t
, 0, 'G'},

69 {"Ãed-»¥Ú£", 
no_¬gum’t
, 0, 'n'},

70 {"»£t-usb", 
no_¬gum’t
, 0, 'R'},

71 {"cÚfig", 
»quœed_¬gum’t
, 0, 'c'},

72 {"v”bo£", 
no_¬gum’t
, 0, 'W'},

73 {"qu›t", 
no_¬gum’t
, 0, 'Q'},

74 {"sysmode", 
no_¬gum’t
, 0, 'D'},

75 {"no-šquœe", 
no_¬gum’t
, 0, 'I'},

76 {"check-sucûss", 
»quœed_¬gum’t
, 0, 's'},

77 {"š‹rçû", 
»quœed_¬gum’t
, 0, 'i'},

78 {"cÚfigu¿tiÚ", 
»quœed_¬gum’t
, 0, 'u'},

79 {"®t£‰šg", 
»quœed_¬gum’t
, 0, 'a'},

84 
	$»adCÚfigFe
(cÚ¡ *
cÚfigF’ame
)

86 ià(
v”bo£
è
	`´štf
("R—dšg cÚfig fe: %s\n", 
cÚfigF’ame
);

87 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
T¬g‘V’dÜ
);

88 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
T¬g‘Produù
);

89 
	`P¬£P¬amSŒšg
(
cÚfigF’ame
, 
T¬g‘ProduùLi¡
);

90 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
T¬g‘CÏss
);

91 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
DeçuÉV’dÜ
);

92 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
DeçuÉProduù
);

93 
	`P¬£P¬amBoŞ
(
cÚfigF’ame
, 
D‘achStÜageOÆy
);

94 
	`P¬£P¬amBoŞ
(
cÚfigF’ame
, 
HuaweiMode
);

95 
	`P¬£P¬amBoŞ
(
cÚfigF’ame
, 
S›¼aMode
);

96 
	`P¬£P¬amBoŞ
(
cÚfigF’ame
, 
SÚyMode
);

97 
	`P¬£P¬amBoŞ
(
cÚfigF’ame
, 
GCTMode
);

98 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
Mes§geEndpošt
);

99 
	`P¬£P¬amSŒšg
(
cÚfigF’ame
, 
Mes§geCÚ‹Á
);

100 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
N“dRe¥Ú£
);

101 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
Re¥Ú£Endpošt
);

102 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
Re£tUSB
);

103 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
InquœeDeviû
);

104 
	`P¬£P¬amIÁ
(
cÚfigF’ame
, 
CheckSucûss
);

105 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
IÁ”çû
);

106 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
CÚfigu¿tiÚ
);

107 
	`P¬£P¬amHex
(
cÚfigF’ame
, 
AÉS‘tšg
);

110 ià(
	`¡¾’
(
T¬g‘ProduùLi¡
))

111 
T¬g‘Produù
 = 0;

113 
cÚfig_»ad
 = 1;

114 
	}
}

117 
	$´štCÚfig
()

119 
	`´štf
 ("DeçuÉV’dÜğ 0x%04x\n", 
DeçuÉV’dÜ
);

120 
	`´štf
 ("DeçuÉProduùğ0x%04x\n", 
DeçuÉProduù
);

121 iàĞ
T¬g‘V’dÜ
 )

122 
	`´štf
 ("T¬g‘V’dÜğ 0x%04x\n", 
T¬g‘V’dÜ
);

124 
	`´štf
 ("TargetVendor=‚ot set\n");

125 iàĞ
T¬g‘Produù
 )

126 
	`´štf
 ("T¬g‘Produùğ 0x%04x\n", 
T¬g‘Produù
);

128 
	`´štf
 ("TargetProduct=‚ot set\n");

129 iàĞ
	`¡¾’
(
T¬g‘ProduùLi¡
) )

130 
	`´štf
 ("T¬g‘ProduùLi¡=%s\n", 
T¬g‘ProduùLi¡
);

133 iàĞ
T¬g‘CÏss
 )

134 
	`´štf
 ("T¬g‘CÏssğ 0x%02x\n", 
T¬g‘CÏss
);

136 
	`´štf
 ("TargetClass=‚ot set\n");

137 
	`´štf
 ("\nD‘achStÜageOÆy=%i\n", ()
D‘achStÜageOÆy
);

138 
	`´štf
 ("HuaweiMode=%i\n", ()
HuaweiMode
);

139 
	`´štf
 ("S›¼aMode=%i\n", ()
S›¼aMode
);

140 
	`´štf
 ("SÚyMode=%i\n", ()
SÚyMode
);

141 
	`´štf
 ("GCTMode=%i\n", ()
GCTMode
);

142 iàĞ
Mes§geEndpošt
 )

143 
	`´štf
 ("Mes§geEndpošt=0x%02x\n", 
Mes§geEndpošt
);

145 
	`´štf
 ("MessageEndpoint=‚ot set\n");

146 iàĞ
	`¡¾’
(
Mes§geCÚ‹Á
) )

147 
	`´štf
 ("Mes§geCÚ‹Á=\"%s\"\n", 
Mes§geCÚ‹Á
);

149 
	`´štf
 ("MessageContent=‚ot set\n");

150 
	`´štf
 ("N“dRe¥Ú£=%i\n", ()
N“dRe¥Ú£
);

151 iàĞ
Re¥Ú£Endpošt
 )

152 
	`´štf
 ("Re¥Ú£Endpošt=0x%02x\n", 
Re¥Ú£Endpošt
);

154 
	`´štf
 ("ResponseEndpoint=‚ot set\n");

155 
	`´štf
 ("IÁ”çû=0x%02x\n", 
IÁ”çû
);

156 iàĞ
CÚfigu¿tiÚ
 > -1 )

157 
	`´štf
 ("CÚfigu¿tiÚ=0x%02x\n", 
CÚfigu¿tiÚ
);

158 iàĞ
AÉS‘tšg
 > -1 )

159 
	`´štf
 ("AÉS‘tšg=0x%02x\n", 
AÉS‘tšg
);

160 iàĞ
InquœeDeviû
 )

161 
	`´štf
 ("\nInquireDeviceƒnabled (default)\n");

163 
	`´štf
 ("\nInquireDevice disabled\n");

164 iàĞ
CheckSucûss
 )

165 
	`´štf
 ("Sucûs checkƒÇbËd, max. wa™im%d secÚds\n", 
CheckSucûss
);

167 
	`´štf
 ("Success check disabled\n");

168 iàĞ
sysmode
 )

169 
	`´štf
 ("System integration modeƒnabled\n");

171 
	`´štf
 ("System integration mode disabled\n");

172 
	`´štf
 ("\n");

173 
	}
}

176 
	$»adArgum’ts
(
¬gc
, **
¬gv
)

178 
c
, 
İtiÚ_šdex
 = 0, 
couÁ
=0;

179 if(
¬gc
==1)  0;

183 
c
 = 
	`g‘İt_lÚg
 (
¬gc
, 
¬gv
, "heWQDndHSOGRIv:p:V:P:C:m:M:r:c:i:u:a:s:",

184 
lÚg_İtiÚs
, &
İtiÚ_šdex
);

187 ià(
c
 == -1)

189 
couÁ
++;

190 
c
)

192 'R': 
Re£tUSB
 = 1; ;

193 'v': 
DeçuÉV’dÜ
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

194 'p': 
DeçuÉProduù
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

195 'V': 
T¬g‘V’dÜ
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

196 'P': 
T¬g‘Produù
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

197 'C': 
T¬g‘CÏss
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

198 'm': 
Mes§geEndpošt
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

199 'M': 
	`¡rıy
(
Mes§geCÚ‹Á
, 
İrg
); ;

200 'n': 
N“dRe¥Ú£
 = 1; ;

201 'r': 
Re¥Ú£Endpošt
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

202 'd': 
D‘achStÜageOÆy
 = 1; ;

203 'H': 
HuaweiMode
 = 1; ;

204 'S': 
S›¼aMode
 = 1; ;

205 'O': 
SÚyMode
 = 1; ;

206 'G': 
GCTMode
 = 1; ;

207 'c': 
	`»adCÚfigFe
(
İrg
); ;

208 'W': 
v”bo£
 = 1; 
show_´og»ss
 = 1; 
couÁ
--; ;

209 'Q': 
show_´og»ss
 = 0; 
v”bo£
 = 0; 
couÁ
--; ;

210 'D': 
sysmode
 = 1; 
couÁ
--; ;

211 's': 
CheckSucûss
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); 
couÁ
--; ;

212 'I': 
InquœeDeviû
 = 0; ;

214 'i': 
IÁ”çû
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

215 'u': 
CÚfigu¿tiÚ
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

216 'a': 
AÉS‘tšg
 = 
	`¡¹Ş
(
İrg
, 
NULL
, 16); ;

219 
	`´štV”siÚ
();

220 
	`ex™
(0);

223 
	`´štV”siÚ
();

224 
	`´štf
 ("Usage: usb-modeswitch [-hvpVPmMrdHn] [-c filename]\n\n");

225 
	`´štf
 (" -h, --helphis help\n");

226 
	`´štf
 (" -e, --version…rint version‚umber‡ndƒxit\n");

227 
	`´štf
 (" -v, --default-vendor NUM vendor IDo†ook for (mandatory)\n");

228 
	`´štf
 (" -p, --default-product NUM…roduct IDo†ook for (mandatory)\n");

229 
	`´štf
 (" -V, --target-vendor NUMarget vendor (optional, for success check)\n");

230 
	`´štf
 (" -P, --target-product NUMarget model (optional, for success check)\n");

231 
	`´štf
 (" -C, --target-class NUMarget device class\n");

232 
	`´štf
 (" -m, --message-endpoint NUM whereo directhe message (optional)\n");

233 
	`´štf
 (" -M, --message-content <msg> commando send (hex‚umber‡s string)\n");

234 
	`´štf
 (" -n, --need-response„ead‡„esponseohe messageransfer\n");

235 
	`´štf
 (" -r, --response-endpoint NUM where from„eadhe„esponse (optional)\n");

236 
	`´štf
 (" -d, --detach-only just detachhe storage driver\n");

237 
	`´štf
 (" -H, --huawei-mode‡pply‡ special…rocedure\n");

238 
	`´štf
 (" -S, --sierra-mode‡pply‡ special…rocedure\n");

239 
	`´štf
 (" -O, --sony-mode‡pply‡ special…rocedure\n");

240 
	`´štf
 (" -G, --gct-mode‡pply‡ special…rocedure\n");

241 
	`´štf
 (" -R, --reset-usb„esethe device inheƒnd\n");

242 
	`´štf
 (" -c, --config <filename>†oad different config file\n");

243 
	`´štf
 (" -Q, --quiet don't show…rogress orƒrror messages\n");

244 
	`´štf
 (" -W, --verbose…rint‡ll settings before„unning\n");

245 
	`´štf
 (" -D, --sysmode specific„esult‡nd syslog message\n");

246 
	`´štf
 (" -s, --success NUM check switching„esult‡fter NUM secs\n");

247 
	`´štf
 (" -I, --no-inquire do‚ot get device details (default on)\n\n");

248 
	`´štf
 (" -i, --interface NUM select initial USB interface (default 0)\n");

249 
	`´štf
 (" -u, --configuration NUM select USB configuration\n");

250 
	`´štf
 (" -a, --altsetting NUM select‡lternative USB interface setting\n\n");

251 
	`ex™
(0);

255 
	`´štf
 ("\n");

256 
	`ex™
(1);

260  
couÁ
;

261 
	}
}

264 
	$maš
(
¬gc
, **
¬gv
)

266 
numDeçuÉs
 = 0, 
¥ecŸlMode
 = 0, 
sÚySucûss
 = 0;

273 
	`»adArgum’ts
(
¬gc
, 
¬gv
)) {

275 
	`»adCÚfigFe
("/etc/usb-modeswitch.conf");

278 ià(!
cÚfig_»ad
)

279 ià(
v”bo£
è
	`´štf
("Taking‡ll…arameters fromhe command†ine\n\n");

282 ià(
v”bo£
)

283 
	`´štV”siÚ
();

285 
	`¦“p
(1);

286 ià(
v”bo£
)

287 
	`´štCÚfig
();

290 
	`usb_š™
();

292 ià(
v”bo£
)

293 
	`usb_£t_debug
(15);

295 
	`usb_fšd_bus£s
();

296 
	`usb_fšd_deviûs
();

299 ià(!(
DeçuÉV’dÜ
 && 
DeçuÉProduù
)) {

300 
	`SHOW_PROGRESS
("No default vendor/product ID given. Aborting.\n\n");

301 
	`ex™
(1);

303 ià(
	`¡¾’
(
Mes§geCÚ‹Á
)) {

304 ià(
	`¡¾’
(
Mes§geCÚ‹Á
) % 2 != 0) {

305 
	`årštf
(
¡d”r
, "Error: MessageContent hex string has uneven†ength. Aborting.\n\n");

306 
	`ex™
(1);

308 iàĞ
	`hex¡r2bš
(
Mes§geCÚ‹Á
, 
By‹SŒšg
, 
	`¡¾’
(MessageContent)/2) == -1) {

309 
	`årštf
(
¡d”r
, "E¼Ü: Mes§geCÚ‹Á %s\Ài nÙ‡ hex sŒšg. AbÜtšg.\n\n", 
Mes§geCÚ‹Á
);

310 
	`ex™
(1);

313 
	`SHOW_PROGRESS
("\n");

315 ià(
show_´og»ss
)

316 ià(
CheckSucûss
 && !(
T¬g‘V’dÜ
 || 
T¬g‘Produù
 || 
	`¡¾’
(
T¬g‘ProduùLi¡
)è&& !
T¬g‘CÏss
)

317 
	`´štf
("Note:arget…arameter missing; success check†imited\n");

320 ià(
T¬g‘V’dÜ
 || 
T¬g‘CÏss
) {

321 
	`SHOW_PROGRESS
("Looking forarget devices ...\n");

322 
	`£¬ch_deviûs
(&
rg‘DeviûCouÁ
, 
T¬g‘V’dÜ
, 
T¬g‘Produù
, 
T¬g‘ProduùLi¡
, 
T¬g‘CÏss
);

323 ià(
rg‘DeviûCouÁ
) {

324 
	`SHOW_PROGRESS
(" Found deviû š¬g‘ modÜ cÏs (%d)\n", 
rg‘DeviûCouÁ
);

326 
	`SHOW_PROGRESS
(" No devices inarget mode or class found\n");

330 
	`SHOW_PROGRESS
("Looking for default devices ...\n");

331 
dev
 = 
	`£¬ch_deviûs
(&
numDeçuÉs
, 
DeçuÉV’dÜ
, 
DeçuÉProduù
, "\0", 
T¬g‘CÏss
);

332 ià(
numDeçuÉs
) {

333 
	`SHOW_PROGRESS
(" Found deçuÉ deviû (%d)\n", 
numDeçuÉs
);

334 ià(
T¬g‘CÏss
 && !(
T¬g‘V’dÜ
 || 
T¬g‘Produù
)) {

335 iàĞ
dev
 !ğ
NULL
 ) {

336 
	`SHOW_PROGRESS
(" Found‡ default device NOT inarget class mode\n");

338 
	`SHOW_PROGRESS
(" All devices inarget class mode. Nothingo do. Bye.\n\n");

339 
	`ex™
(0);

343 ià(
dev
 !ğ
NULL
) {

344 
devnum
 = 
dev
->devnum;

345 
bu¢um
 = ()
	`¡¹Ş
(
dev
->
bus
->
dœÇme
,
NULL
,10);

346 
	`SHOW_PROGRESS
("Acûssšg deviû %03d oÀbu %03d ...\n", 
devnum
, 
bu¢um
);

347 
devh
 = 
	`usb_İ’
(
dev
);

349 
	`SHOW_PROGRESS
(" No default device found. Is it connected? Bye.\n\n");

350 
	`ex™
(0);

354 
deçuÉCÏss
 = 
dev
->
desütÜ
.
bDeviûCÏss
;

355 ià(
deçuÉCÏss
 == 0)

356 
deçuÉCÏss
 = 
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0].
bIÁ”çûCÏss
;

358 ià(
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0].
bIÁ”çûCÏss
 =ğ8 && 
deçuÉCÏss
 != 8) {

360 
	`SHOW_PROGRESS
("Ambiguou CÏss/IÁ”çûCÏss: 0x%02x/0x08", 
deçuÉCÏss
);

361 
deçuÉCÏss
 = 8;

365 ià(!
Mes§geEndpošt
 && (
	`¡¾’
(
Mes§geCÚ‹Á
è|| 
InquœeDeviû
) ) {

367 
Mes§geEndpošt
 = 
	`fšd_fœ¡_bulk_ouut_’dpošt
(
dev
);

368 ià(!
Mes§geEndpošt
 && 
	`¡¾’
(
Mes§geCÚ‹Á
)) {

369 
	`årštf
(
¡d”r
,"Error: messageƒndpoint‚ot given or found. Aborting.\n\n");

370 
	`ex™
(1);

373 ià(!
Re¥Ú£Endpošt
 && (
N“dRe¥Ú£
 || 
InquœeDeviû
) ) {

374 
Re¥Ú£Endpošt
 = 
	`fšd_fœ¡_bulk_šput_’dpošt
(
dev
);

375 ià(!
Re¥Ú£Endpošt
 && 
N“dRe¥Ú£
) {

376 
	`årštf
(
¡d”r
,"Error:„esponseƒndpoint‚ot given or found. Aborting.\n\n");

377 
	`ex™
(1);

380 ià(
Mes§geEndpošt
 && 
Re¥Ú£Endpošt
) {

381 
	`SHOW_PROGRESS
("Usšgƒndpošt 0x%02x (outèªd 0x%02x (š)\n", 
Mes§geEndpošt
, 
Re¥Ú£Endpošt
);

383 ià(
InquœeDeviû
 && 
deçuÉCÏss
 == 0x08) {

384 
	`SHOW_PROGRESS
("Endpoints‚ot found, skipping SCSI inquiry\n");

385 
InquœeDeviû
 = 0;

388 ià(
InquœeDeviû
 && 
show_´og»ss
) {

389 ià(
deçuÉCÏss
 == 0x08) {

390 
	`SHOW_PROGRESS
("Inquiring device details; driver will be detached ...\n");

391 
	`d‘achDriv”
();

392 ià(
	`deviûInquœe
() >= 0)

393 
InquœeDeviû
 = 2;

395 
	`SHOW_PROGRESS
("Not‡ storage device, skipping SCSI inquiry\n");

398 
	`deviûDesütiÚ
();

399 ià(
show_´og»ss
) {

400 
	`´štf
("\nUSB description data (for identification)\n");

401 
	`´štf
("-------------------------\n");

402 
	`´štf
("Mªuçùu»r: %s\n", 
imªuçù
);

403 
	`´štf
(" Produù: %s\n", 
roduù
);

404 
	`´štf
(" S”ŸÈNo.: %s\n", 
i£rŸl
);

405 
	`´štf
("-------------------------\n");

409 
¥ecŸlMode
 = 
D‘achStÜageOÆy
 + 
HuaweiMode
 + 
S›¼aMode
 + 
SÚyMode
;

410 iàĞ
¥ecŸlMode
 > 1 ) {

411 
	`SHOW_PROGRESS
("Invalid mode combination. Check your configuration. Aborting.\n\n");

412 
	`ex™
(1);

415 iàĞ!
¥ecŸlMode
 && !
	`¡¾’
(
Mes§geCÚ‹Á
) )

416 
	`SHOW_PROGRESS
("Warning:‚o switching method given.\n");

422 ià(
sysmode
) {

423 
	`İ’log
("usb-modesw™ch", 0, 
LOG_SYSLOG
);

424 
	`sy¦og
(
LOG_NOTICE
, "sw™chšg %04x:%04x (%s: %s)", 
DeçuÉV’dÜ
, 
DeçuÉProduù
, 
imªuçù
, 
roduù
);

427 ià(
D‘achStÜageOÆy
) {

428 
	`SHOW_PROGRESS
("Only detaching storage driver for switching ...\n");

429 ià(
InquœeDeviû
 == 2) {

430 
	`SHOW_PROGRESS
(" Any driver was‡lready detached for inquiry\n");

432 
»t
 = 
	`d‘achDriv”
();

433 ià(
»t
 == 2)

434 
	`SHOW_PROGRESS
(" You may wanto„emovehe storage driver manually\n");

438 ià(
	`¡¾’
(
Mes§geCÚ‹Á
è&& 
Mes§geEndpošt
) {

439 ià(
¥ecŸlMode
 == 0) {

440 ià(
InquœeDeviû
 != 2)

441 
	`d‘achDriv”
();

442 
	`sw™chS’dMes§ge
();

444 
	`SHOW_PROGRESS
("Warning: ignoring MessageContent. Can't combine with special mode\n");

447 ià(
CÚfigu¿tiÚ
 != -1) {

448 
	`sw™chCÚfigu¿tiÚ
 ();

451 ià(
AÉS‘tšg
 != -1) {

452 
	`sw™chAÉS‘tšg
();

455 ià(
Re£tUSB
) {

456 
	`»£tUSB
();

459 ià(
CheckSucûss
) {

460 
	`sigÇl
(
SIGTERM
, 
»Ëa£_usb_deviû
);

461 ià(
	`checkSucûss
()) {

462 ià(
sysmode
)

463 
	`´štf
("ok:%04x:%04x\n", 
T¬g‘V’dÜ
, 
T¬g‘Produù
);

464 
	`ex™
(0);

466 ià(
sysmode
)

467 
	`´štf
("fail:\n");

468 
	`ex™
(0);

471 ià(
SÚyMode
)

472 ià(
sÚySucûss
) {

473 ià(
sysmode
) {

474 
	`sy¦og
(
LOG_NOTICE
, "switched S.E. MD400o modem mode");

475 
	`´štf
("ok:\n");

477 
	`SHOW_PROGRESS
("-> device should be stable‚ow. Bye.\n\n");

479 ià(
sysmode
)

480 
	`´štf
("fail:\n");

481 
	`SHOW_PROGRESS
("-> switching was…robably‚ot completed. Bye.\n\n");

484 
	`SHOW_PROGRESS
("-> Run†susbo‚ote‡ny changes. Bye.\n\n");

485 ià(
sysmode
)

486 
	`şo£log
();

487 
	`ex™
(0);

490 ià(
devh
)

491 
	`usb_şo£
(
devh
);

494 
	}
}

498 
	$deviûDesütiÚ
 ()

500 
»t
;

501 * 
c
;

502 
	`mem£t
 (
imªuçù
, ' ', 
DESCR_MAX
);

503 
	`mem£t
 (
roduù
, ' ', 
DESCR_MAX
);

504 
	`mem£t
 (
i£rŸl
, ' ', 
DESCR_MAX
);

506 ià(
dev
->
desütÜ
.
iMªuçùu»r
) {

507 
»t
 = 
	`usb_g‘_¡ršg_sim¶e
(
devh
, 
dev
->
desütÜ
.
iMªuçùu»r
, 
imªuçù
, 
DESCR_MAX
);

508 ià(
»t
 < 0)

509 
	`årštf
(
¡d”r
, "Error: could‚ot get description string \"manufacturer\"\n");

511 
	`¡rıy
(
imªuçù
, "not…rovided");

512 
c
 = 
	`¡r¡r
(
imªuçù
, " ");

513 ià(
c
)

514 
	`mem£t
((*)
c
, '\0', 1);

516 ià(
dev
->
desütÜ
.
iProduù
) {

517 
»t
 = 
	`usb_g‘_¡ršg_sim¶e
(
devh
, 
dev
->
desütÜ
.
iProduù
, 
roduù
, 
DESCR_MAX
);

518 ià(
»t
 < 0)

519 
	`årštf
(
¡d”r
, "Error: could‚ot get description string \"product\"\n");

521 
	`¡rıy
(
roduù
, "not…rovided");

522 
c
 = 
	`¡r¡r
(
roduù
, " ");

523 ià(
c
)

524 
	`mem£t
((*)
c
, '\0', 1);

526 ià(
dev
->
desütÜ
.
iS”ŸlNumb”
) {

527 
»t
 = 
	`usb_g‘_¡ršg_sim¶e
(
devh
, 
dev
->
desütÜ
.
iS”ŸlNumb”
, 
i£rŸl
, 
DESCR_MAX
);

528 ià(
»t
 < 0)

529 
	`årštf
(
¡d”r
, "Error: could‚ot get description string \"serial‚umber\"\n");

531 
	`¡rıy
(
i£rŸl
, "not…rovided");

532 
c
 = 
	`¡r¡r
(
i£rŸl
, " ");

533 ià(
c
)

534 
	`mem£t
((*)
c
, '\0', 1);

536 
	}
}

539 
	$deviûInquœe
 ()

541 cÚ¡ 
šquœe_msg
[] = {

547 *
commªd
;

548 
d©a
[36];

549 
i
, 
»t
;

551 
commªd
 = 
	`m®loc
(31);

552 ià(
commªd
 =ğ
NULL
) {

553 
»t
 = 1;

554 
out
;

557 
	`memıy
(
commªd
, 
šquœe_msg
,  (inquire_msg));

559 
»t
 = 
	`usb_şaim_š‹rçû
(
devh
, 
IÁ”çû
);

560 ià(
»t
 != 0) {

561 
	`SHOW_PROGRESS
(" Could‚Ù cÏim iÁ”çû (”rÜ %d). Skpšg deviû inquœy\n", 
»t
);

562 
out
;

564 
	`usb_ş—r_h®t
(
devh
, 
Mes§geEndpošt
);

566 
»t
 = 
	`usb_bulk_wr™e
(
devh
, 
Mes§geEndpošt
, (*)
commªd
, 31, 0);

567 ià(
»t
 < 0) {

568 
	`SHOW_PROGRESS
(" Could‚Ù s’d INQUIRY mes§gÓ¼Ü %d)\n", 
»t
);

569 
out
;

572 
»t
 = 
	`usb_bulk_»ad
(
devh
, 
Re¥Ú£Endpošt
, 
d©a
, 36, 0);

573 ià(
»t
 < 0) {

574 
	`SHOW_PROGRESS
(" Could‚Ù g‘ INQUIRY„e¥Ú£ (”rÜ %d)\n", 
»t
);

575 
out
;

578 
i
 = 
	`usb_bulk_»ad
(
devh
, 
Re¥Ú£Endpošt
, 
commªd
, 13, 0);

580 
	`´štf
("\nSCSI inquiry data (for identification)\n");

581 
	`´štf
("-------------------------\n");

583 
	`´štf
(" Vendor String: ");

584 
i
 = 8; i < 16; i++è
	`´štf
("%c",
d©a
[i]);

585 
	`´štf
("\n");

587 
	`´štf
(" Model String: ");

588 
i
 = 16; i < 32; i++è
	`´štf
("%c",
d©a
[i]);

589 
	`´štf
("\n");

591 
	`´štf
("Revision String: ");

592 
i
 = 32; i < 36; i++è
	`´štf
("%c",
d©a
[i]);

594 
	`´štf
("\n-------------------------\n");

596 
out
:

597 ià(
	`¡¾’
(
Mes§geCÚ‹Á
) == 0)

598 
	`usb_ş—r_h®t
(
devh
, 
Mes§geEndpošt
);

599 
	`usb_»Ëa£_š‹rçû
(
devh
, 
IÁ”çû
);

600 
	`ä“
(
commªd
);

601  
»t
;

602 
	}
}

605 
	$»£tUSB
 ()

607 
sucûss
;

608 
bpošt
 = 0;

610 ià(
show_´og»ss
) {

611 
	`´štf
("Resetting usb device ");

612 
	`fæush
(
¡dout
);

615 
	`¦“p
( 1 );

617 
sucûss
 = 
	`usb_»£t
(
devh
);

618 iàĞ((
bpošt
 % 10è=ğ0è&& 
show_´og»ss
 ) {

619 
	`´štf
(".");

620 
	`fæush
(
¡dout
);

622 
bpošt
++;

623 ià(
bpošt
 > 100)

624 
sucûss
 = 1;

625 } 
sucûss
 < 0);

627 iàĞ
sucûss
 ) {

628 
	`SHOW_PROGRESS
("\n Reset failed. Can be ignored if device switched OK.\n");

630 
	`SHOW_PROGRESS
("\n OK, device was„eset\n");

631 
	}
}

634 
	$sw™chS’dMes§ge
 ()

636 
mes§ge_Ëngth
, 
»t
;

638 
	`SHOW_PROGRESS
("S‘tšg u°communiÿtiÚ w™h iÁ”çû %d ...\n", 
IÁ”çû
);

639 ià(
InquœeDeviû
 != 2) {

640 
»t
 = 
	`usb_şaim_š‹rçû
(
devh
, 
IÁ”çû
);

641 ià(
»t
 != 0) {

642 
	`SHOW_PROGRESS
(" Could‚Ù cÏim iÁ”çû (”rÜ %d). Skpšg mes§g£ndšg\n", 
»t
);

646 
	`usb_ş—r_h®t
(
devh
, 
Mes§geEndpošt
);

647 
	`SHOW_PROGRESS
("TryšgØ£ndhmes§gtØ’dpošˆ0x%02x ...\n", 
Mes§geEndpošt
);

648 
	`fæush
(
¡dout
);

650 
mes§ge_Ëngth
 = 
	`¡¾’
(
Mes§geCÚ‹Á
) / 2;

651 
»t
 = 
	`wr™e_bulk
(
Mes§geEndpošt
, 
By‹SŒšg
, 
mes§ge_Ëngth
);

652 ià(
»t
 == -19)

653 
sk
;

655 ià(
N“dRe¥Ú£
) {

656 
	`SHOW_PROGRESS
("Readinghe„esponseohe message ...\n");

657 
»t
 = 
	`»ad_bulk
(
Re¥Ú£Endpošt
, 
By‹SŒšg
, 
LINE_DIM
/2);

658 ià(
»t
 == -19)

659 
sk
;

662 
»t
 = 
	`usb_ş—r_h®t
(
devh
, 
Mes§geEndpošt
);

663 ià(
»t
)

664 
sk
;

665 
»t
 = 
	`usb_»Ëa£_š‹rçû
(
devh
, 
IÁ”çû
);

666 ià(
»t
)

667 
sk
;

670 
sk
:

671 
	`SHOW_PROGRESS
(" Device is gone, skipping‡ny further commands\n");

672 
	`usb_şo£
(
devh
);

673 
devh
 = 0;

675 
	}
}

678 
	$sw™chCÚfigu¿tiÚ
 ()

680 
»t
;

682 
	`SHOW_PROGRESS
("Chªgšg cÚfigu¿tiÚØ%˜...\n", 
CÚfigu¿tiÚ
);

683 
»t
 = 
	`usb_£t_cÚfigu¿tiÚ
(
devh
, 
CÚfigu¿tiÚ
);

684 ià(
»t
 == 0 ) {

685 
	`SHOW_PROGRESS
(" OK, configuration set\n");

688 
	`SHOW_PROGRESS
(" S‘tšghcÚfigu¿tiÚ„‘uºedƒ¼Ü %d. TryšgØcÚtšue\n", 
»t
);

690 
	}
}

693 
	$sw™chAÉS‘tšg
 ()

695 
»t
;

697 
	`SHOW_PROGRESS
("ChªgšgØ®ˆ£‰šg %˜...\n", 
AÉS‘tšg
);

698 
»t
 = 
	`usb_şaim_š‹rçû
(
devh
, 
IÁ”çû
);

699 
»t
 = 
	`usb_£t_®tš‹rçû
(
devh
, 
AÉS‘tšg
);

700 
	`usb_»Ëa£_š‹rçû
(
devh
, 
IÁ”çû
);

701 ià(
»t
 != 0) {

702 
	`SHOW_PROGRESS
(" ChªgšgØ®ˆ£‰šg„‘uºedƒ¼Ü %d. TryšgØcÚtšue\n", 
»t
);

705 
	`SHOW_PROGRESS
(" OK, changedo‡lt setting\n");

708 
	}
}

711 
	$d‘achDriv”
()

713 
»t
;

715 #iâdeà
LIBUSB_HAS_GET_DRIVER_NP


716 
	`´štf
(" Cant't do driver detection‡nd detaching onhis…latform.\n");

720 
	`SHOW_PROGRESS
("Looking for‡ctive driver ...\n");

721 
»t
 = 
	`usb_g‘_driv”_Å
(
devh
, 
IÁ”çû
, 
bufãr
, 
BUF_SIZE
);

722 ià(
»t
 != 0) {

723 
	`SHOW_PROGRESS
(" No driver found. Either detached before or‚ever‡ttached\n");

726 
	`SHOW_PROGRESS
(" OK, driv” found (\"%s\")\n", 
bufãr
);

727 ià(
D‘achStÜageOÆy
 && 
	`¡rcmp
(
bufãr
,"usb-storage")) {

728 
	`SHOW_PROGRESS
(" Warning: driver is‚ot usb-storage\n");

732 #iâdeà
LIBUSB_HAS_DETACH_KERNEL_DRIVER_NP


733 
	`SHOW_PROGRESS
(" Can't do driver detaching onhis…latform\n");

738 
»t
 = 
	`usb_d‘ach_k”Ãl_driv”_Å
(
devh
, 
IÁ”çû
);

739 ià(
»t
 == 0) {

740 
	`SHOW_PROGRESS
(" OK, driv” \"%s\" d‘ached\n", 
bufãr
);

744 
	`SHOW_PROGRESS
(" Driv” \"%s\" d‘ach faed w™hƒ¼Ü %d. TryšgØcÚtšue\n", 
bufãr
, 
»t
);

746 
	}
}

749 
	$checkSucûss
()

751 
i
=0, 
»t
;

752 
ÃwT¬g‘CouÁ
, 
sucûss
=0;

754 
	`SHOW_PROGRESS
("\nCheckšg fÜ modsw™ch (max. %dimes, onû…” secÚdè...\n", 
CheckSucûss
);

755 
	`¦“p
(1);

757 ià(
devh
)

758 
i
=0; i < 
CheckSucûss
; i++) {

762 
	`SHOW_PROGRESS
(" Waiting for original deviceo vanish ...\n");

764 
»t
 = 
	`usb_şaim_š‹rçû
(
devh
, 
IÁ”çû
);

765 ià(
»t
 < 0) {

766 
	`SHOW_PROGRESS
(" Original device can't be‡ccessed‡nymore. Good.\n");

767 ià(
i
 =ğ
CheckSucûss
-1)

768 
	`SHOW_PROGRESS
(" If you wantarget checking, increase 'CheckSuccess' value.\n");

769 
	`usb_şo£
(
devh
);

770 
devh
 = 
NULL
;

773 
	`usb_»Ëa£_š‹rçû
(
devh
, 
IÁ”çû
);

775 ià(
i
 =ğ
CheckSucûss
-1) {

776 
	`SHOW_PROGRESS
(" Original device still…resent‡fterheimeout\n\nMode switch most†ikely failed. Bye.\n\n");

778 
	`¦“p
(1);

781 
	`SHOW_PROGRESS
(" Original device is gone‡lready,‚ot checking\n");

784 iàĞ(
T¬g‘V’dÜ
 && (
T¬g‘Produù
 || 
	`¡¾’
(
T¬g‘ProduùLi¡
))è|| 
T¬g‘CÏss
 )

789 
i
=i; i < 
CheckSucûss
; i++) {

790 
	`SHOW_PROGRESS
(" Searching forarget devices ...\n");

791 
	`usb_fšd_deviûs
();

792 
dev
 = 
	`£¬ch_deviûs
(&
ÃwT¬g‘CouÁ
, 
T¬g‘V’dÜ
, 
T¬g‘Produù
, 
T¬g‘ProduùLi¡
, 
T¬g‘CÏss
);

793 ià(
dev
 && (
ÃwT¬g‘CouÁ
 > 
rg‘DeviûCouÁ
)) {

794 
devh
 = 
	`usb_İ’
(
dev
);

795 
	`deviûDesütiÚ
();

796 
	`usb_şo£
(
devh
);

797 ià(
v”bo£
) {

798 
	`´štf
("\nFoundarget device %03d on bus %03d\n", \

799 
dev
->
devnum
, ()
	`¡¹Ş
(dev->
bus
->
dœÇme
,
NULL
,10));

800 
	`´štf
("\nTarget device description data\n");

801 
	`´štf
("-------------------------\n");

802 
	`´štf
("Mªuçùu»r: %s\n", 
imªuçù
);

803 
	`´štf
(" Produù: %s\n", 
roduù
);

804 
	`´štf
(" S”ŸÈNo.: %s\n", 
i£rŸl
);

805 
	`´štf
("-------------------------\n");

807 
	`SHOW_PROGRESS
(" Found correctarget device\n\nMode switch succeeded. Bye.\n\n");

808 
sucûss
 = 2;

811 ià(
i
 =ğ
CheckSucûss
-1) {

812 
	`SHOW_PROGRESS
(" No‚ew devices inarget mode or class found\n\nMode switch has failed. Bye.\n\n");

814 
	`¦“p
(1);

818 ià(!
devh
) {

819 
	`SHOW_PROGRESS
(" (For‡ better success check…rovidearget IDs or class)\n");

820 
	`SHOW_PROGRESS
(" Original device vanished‡fter switching\n\nMode switch most†ikely succeeded. Bye.\n\n");

821 
sucûss
 = 1;

824 
sucûss
) {

826 ià(
sysmode
)

827 
	`sy¦og
(
LOG_NOTICE
, "sw™chedØ%04x:%04x (%s: %s)", 
T¬g‘V’dÜ
, 
T¬g‘Produù
, 
imªuçù
, 
roduù
);

828 
sucûss
 = 1;

831 ià(
sysmode
)

832 
	`sy¦og
(
LOG_NOTICE
, "device seemso have switched");

836 ià(
sysmode
)

837 
	`şo£log
();

839  
sucûss
;

841 
	}
}

844 
	$wr™e_bulk
(
’dpošt
, *
mes§ge
, 
Ëngth
)

846 
»t
;

847 
»t
 = 
	`usb_bulk_wr™e
(
devh
, 
’dpošt
, 
mes§ge
, 
Ëngth
, 100);

848 ià(
»t
 >= 0 ) {

849 
	`SHOW_PROGRESS
(" OK, message successfully sent\n");

851 ià(
»t
 == -19) {

852 
	`SHOW_PROGRESS
(" Device seemso have vanished„ight‡fter sending. Good.\n");

854 
	`SHOW_PROGRESS
(" S’dšghmes§g»tuºedƒ¼Ü %d. TryšgØcÚtšue\n", 
»t
);

855  
»t
;

857 
	}
}

859 
	$»ad_bulk
(
’dpošt
, *
bufãr
, 
Ëngth
)

861 
»t
;

862 
»t
 = 
	`usb_bulk_»ad
(
devh
, 
’dpošt
, 
bufãr
, 
Ëngth
, 100);

863 
	`usb_bulk_»ad
(
devh
, 
’dpošt
, 
bufãr
, 13, 100);

864 ià(
»t
 >= 0 ) {

865 
	`SHOW_PROGRESS
(" OK,„e¥Ú£ sucûssfuÎy„—d (%d by‹s).\n", 
»t
);

867 ià(
»t
 == -19) {

868 
	`SHOW_PROGRESS
(" Device seemso have vanished‡fter„eading. Good.\n");

870 
	`SHOW_PROGRESS
(" Re¥Ú£„—dšg gÙƒ¼Ü %d, cª…robably bignÜed\n", 
»t
);

871  
»t
;

873 
	}
}

875 
	$»Ëa£_usb_deviû
(
dummy
) {

876 
	`SHOW_PROGRESS
("Program cancelled by system. Bye.\n\n");

877 
	`usb_»Ëa£_š‹rçû
(
devh
, 
IÁ”çû
);

878 
	`usb_şo£
(
devh
);

879 ià(
sysmode
)

880 
	`şo£log
();

881 
	`ex™
(0);

883 
	}
}

888 
usb_deviû
* 
	$£¬ch_deviûs
Ğ*
numFound
, 
v’dÜ
, 
´oduù
, * 
´oduùLi¡
, 
rg‘CÏss
)

890 
usb_bus
 *
bus
;

891 *
li¡cİy
, *
tok’
, 
bufãr
[2];

892 
devCÏss
;

893 
usb_deviû
* 
right_dev
 = 
NULL
;

895 iàĞ
rg‘CÏss
 && !(
v’dÜ
 || 
´oduù
) ) {

896 
v’dÜ
 = 
DeçuÉV’dÜ
;

897 
´oduù
 = 
DeçuÉProduù
;

899 *
numFound
 = 0;

900 ià(!
v’dÜ
 || (!
´oduù
 && 
´oduùLi¡
==
NULL
))

901  
NULL
;

902 ià(
´oduùLi¡
 !ğ
NULL
)

903 
li¡cİy
 = 
	`m®loc
(
	`¡¾’
(
´oduùLi¡
)+1);

905 
bus
 = 
	`usb_g‘_bus£s
(); bus; bu ğbus->
Ãxt
) {

906 
usb_deviû
 *
dev
;

907 
dev
 = 
bus
->
deviûs
; dev; dev = dev->
Ãxt
) {

908 ià(
v”bo£
)

909 
	`´štf
 (" s—rchšg deviûs, found USB ID %04x:%04x\n", 
dev
->
desütÜ
.
idV’dÜ
, dev->desütÜ.
idProduù
);

910 ià(
dev
->
desütÜ
.
idV’dÜ
 !ğ
v’dÜ
)

912 ià(
v”bo£
)

913 
	`´štf
 (" found matching vendor ID\n");

915 iàĞ
	`¡¾’
(
´oduùLi¡
) ) {

916 
	`¡rıy
(
li¡cİy
, 
´oduùLi¡
);

917 
tok’
 = 
	`¡¹ok
(
li¡cİy
, ",");

918 
tok’
 !ğ
NULL
) {

919 ià(
	`¡¾’
(
tok’
) != 4) {

920 
	`SHOW_PROGRESS
("E¼Ü:ƒÁry iÀ´oduù ID†i¡ ha wrÚg†’gth: %s. IgnÜšg\n", 
tok’
);

921 
NextTok’
;

923 iàĞ
	`hex¡r2bš
(
tok’
, 
bufãr
, 
	`¡¾’
(token)/2) == -1) {

924 
	`SHOW_PROGRESS
("E¼Ü:ƒÁry iÀ´oduù ID†i¡ i nÙ‡ hex sŒšg: %s. IgnÜšg\n", 
tok’
);

925 
NextTok’
;

927 
´oduù
 = 0;

928 
´oduù
 +ğ()
bufãr
[0];

929 
´oduù
 <<= 8;

930 
´oduù
 +ğ()
bufãr
[1];

931 ià(
´oduù
 =ğ
dev
->
desütÜ
.
idProduù
) {

932 ià(
v”bo£
)

933 
	`´štf
 (" found matching…roduct ID from†ist\n");

934 (*
numFound
)++;

935 ià(
bu¢um
 == -1)

936 
right_dev
 = 
dev
;

938 ià(
dev
->
devnum
 >ğdevnum && ()
	`¡¹Ş
(dev->
bus
->
dœÇme
,
NULL
,10è=ğ
bu¢um
) {

939 
right_dev
 = 
dev
;

940 
T¬g‘Produù
 = 
dev
->
desütÜ
.
idProduù
;

945 
NextTok’
:

946 
tok’
 = 
	`¡¹ok
(
NULL
, ",");

950 ià(
´oduù
 =ğ
dev
->
desütÜ
.
idProduù
) {

951 ià(
v”bo£
)

952 
	`´štf
 (" found matching…roduct ID\n");

953 (*
numFound
)++;

954 
devCÏss
 = 
dev
->
desütÜ
.
bDeviûCÏss
;

955 ià(
devCÏss
 == 0)

956 
devCÏss
 = 
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0].
bIÁ”çûCÏss
;

958 ià(
devCÏss
 !ğ
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0].
bIÁ”çûCÏss
)

959 
devCÏss
 = 
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0].
bIÁ”çûCÏss
;

960 ià(
bu¢um
 == -1) {

961 ià(
devCÏss
 !ğ
rg‘CÏss
 ||argetClass == 0)

962 
right_dev
 = 
dev
;

964 ià(
devCÏss
 =ğ
rg‘CÏss
 ||argetClass == 0)

965 ià(
dev
->
devnum
 >ğdevnum && ()
	`¡¹Ş
(dev->
bus
->
dœÇme
,
NULL
,10è=ğ
bu¢um
)

966 
right_dev
 = 
dev
;

968 ià(
right_dev
 && 
bu¢um
 != -1)

971 ià(
right_dev
 && 
bu¢um
 != -1)

974 ià(
´oduùLi¡
 !ğ
NULL
)

975 
	`ä“
(
li¡cİy
);

976  
right_dev
;

977 
	}
}

980 
	#USB_DIR_OUT
 0x00

	)

981 
	#USB_DIR_IN
 0x80

	)

985 
	$fšd_fœ¡_bulk_ouut_’dpošt
(
usb_deviû
 *
dev
)

987 
i
;

988 
usb_š‹rçû_desütÜ
 *
®t
 = &(
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0]);

989 
usb_’dpošt_desütÜ
 *
•
;

991 
i
=0;˜< 
®t
->
bNumEndpošts
;i++) {

992 
•
=&(
®t
->
’dpošt
[
i
]);

993 ifĞĞ(
•
->
bmA‰ribu‹s
 & 
USB_ENDPOINT_TYPE_MASK
è=ğ
USB_ENDPOINT_TYPE_BULK
) &&

994 Ğ(
•
->
bEndpoštAdd»ss
 & 
USB_ENDPOINT_DIR_MASK
è=ğ
USB_DIR_OUT
 ) ) {

995  
•
->
bEndpoštAdd»ss
;

1000 
	}
}

1003 
	$fšd_fœ¡_bulk_šput_’dpošt
(
usb_deviû
 *
dev
)

1005 
i
;

1006 
usb_š‹rçû_desütÜ
 *
®t
 = &(
dev
->
cÚfig
[0].
š‹rçû
[0].
®t£‰šg
[0]);

1007 
usb_’dpošt_desütÜ
 *
•
;

1009 
i
=0;˜< 
®t
->
bNumEndpošts
;i++) {

1010 
•
=&(
®t
->
’dpošt
[
i
]);

1011 ifĞĞ(
•
->
bmA‰ribu‹s
 & 
USB_ENDPOINT_TYPE_MASK
è=ğ
USB_ENDPOINT_TYPE_BULK
) &&

1012 Ğ(
•
->
bEndpoštAdd»ss
 & 
USB_ENDPOINT_DIR_MASK
è=ğ
USB_DIR_IN
 ) ) {

1013  
•
->
bEndpoštAdd»ss
;

1018 
	}
}

1024 * 
	$R—dP¬£P¬am
(cÚ¡ * 
FeName
, *
V¬ŸbËName
)

1026 
SŒ
[
LINE_DIM
];

1027 *
V¬Name
, *
Comm’t
=
NULL
, *
Equ®
=NULL;

1028 *
Fœ¡QuÙe
, *
La¡QuÙe
, *
P1
, *
P2
;

1029 
Lše
=0, 
L’
=0, 
Pos
=0;

1030 
FILE
 *
fe
=
	`fİ’
(
FeName
, "r");

1032 ià(
fe
==
NULL
) {

1033 
	`årštf
(
¡d”r
, "E¼Ü: Could‚Ù fšd f%s\n\n", 
FeName
);

1034 
	`ex™
(1);

1037 
	`fg‘s
(
SŒ
, 
LINE_DIM
-1, 
fe
è!ğ
NULL
) {

1038 
Lše
++;

1039 
L’
=
	`¡¾’
(
SŒ
);

1040 ià(
L’
==0è
Next
;

1041 ià(
SŒ
[
L’
-1]=='\n' 
Ü
 Str[Len-1]=='\r') Str[--Len]='\0';

1042 
Equ®
 = 
	`¡rchr
 (
SŒ
, '=');

1043 
Pos
 = 
	`¡rc¥n
 (
SŒ
, ";#!");

1044 
Comm’t
 = (
Pos
==
L’
è? 
NULL
 : 
SŒ
+Pos;

1045 ià(
Equ®
==
NULL
 
	`Ü
 ( 
Comm’t
!=NULL 
ªd
 Comm’t<=Equ®)è
Next
;

1046 *
Equ®
++ = '\0';

1047 ià(
Comm’t
!=
NULL
) *Comment='\0';

1050 
Fœ¡QuÙe
=
	`¡rchr
 (
Equ®
, '"');

1051 
La¡QuÙe
=
	`¡¼chr
 (
Equ®
, '"');

1052 ià(
Fœ¡QuÙe
!=
NULL
) {

1053 ià(
La¡QuÙe
==
NULL
) {

1054 
	`årštf
(
¡d”r
, "E¼Ü„—dšg…¬am‘” f% lš%d - Missšgƒnd quÙe.\n", 
FeName
, 
Lše
);

1055 
Next
;

1057 *
Fœ¡QuÙe
=*
La¡QuÙe
='\0';

1058 
Equ®
=
Fœ¡QuÙe
+1;

1062 
Pos
=
	`¡r¥n
 (
SŒ
, " \t");

1063 ià(
Pos
==
	`¡¾’
(
SŒ
)) {

1064 
	`årštf
(
¡d”r
, "E¼Ü„—dšg…¬am‘” f% lš%d - Missšg v¬ŸbË‚ame.\n", 
FeName
, 
Lše
);

1065 
Next
;

1067 (
P1
=
	`¡¼chr
(
SŒ
, ' '))!=
NULL
 
	`Ü
 (
P2
=strrchr(Str, '\t'))!=NULL)

1068 ià(
P1
!=
NULL
) *P1='\0';

1069 ià(
P2
!=
NULL
) *P2='\0';

1070 
V¬Name
=
SŒ
+
Pos
;

1073 
Pos
=
	`¡r¥n
 (
Equ®
, " \t");

1074 ià(
Pos
==
	`¡¾’
(
Equ®
)) {

1075 
	`årštf
(
¡d”r
, "E¼Ü„—dšg…¬am‘” f% lš%d - Missšg v®ue.\n", 
FeName
, 
Lše
);

1076 
Next
;

1078 
Equ®
+=
Pos
;

1080 ià(
	`¡rcmp
(
V¬Name
, 
V¬ŸbËName
)==0) {

1081 
	`fşo£
(
fe
);

1082  
Equ®
;

1084 
Next
:;

1090 
	`fşo£
(
fe
);

1091  
NULL
;

1092 
	}
}

1095 
	$hex2num
(
c
)

1097 ià(
c
 >= '0' && c <= '9')

1098  
c
 - '0';

1099 ià(
c
 >= 'a' && c <= 'f')

1100  
c
 - 'a' + 10;

1101 ià(
c
 >= 'A' && c <= 'F')

1102  
c
 - 'A' + 10;

1104 
	}
}

1107 
	$hex2by‹
(cÚ¡ *
hex
)

1109 
a
, 
b
;

1110 
a
 = 
	`hex2num
(*
hex
++);

1111 ià(
a
 < 0)

1113 
b
 = 
	`hex2num
(*
hex
++);

1114 ià(
b
 < 0)

1116  (
a
 << 4è| 
b
;

1117 
	}
}

1119 
	$hex¡r2bš
(cÚ¡ *
hex
, *
bufãr
, 
Ën
)

1121 
i
;

1122 
a
;

1123 cÚ¡ *
os
 = 
hex
;

1124 *
İos
 = 
bufãr
;

1127 
i
 = 0; i < 
Ën
; i++) {

1128 
a
 = 
	`hex2by‹
(
os
);

1130 ià(
a
 < 0)

1132 *
İos
++ = 
a
;

1133 
os
 += 2;

1137 
	}
}

1139 
	$´štV”siÚ
()

1141 
	`´štf
("\n * usb-modeswitch: handle USB devices with multiple modes\n");

1142 
	`´štf
(" * V”siÚ % (CèJosu¨D›tz2010\n", 
v”siÚ
);

1143 
	`´štf
(" * Based on†ibusb 0.1.12\n\n");

1144 
	`´štf
(" ! PLEASE REPORT NEW CONFIGURATIONS !\n\n");

1145 
	}
}

	@driver/doshift/lcdoshift.h

29 
	~<¡dlib.h
>

30 
	~<usb.h
>

32 
»adCÚfigFe
(cÚ¡ *
cÚfigF’ame
);

33 
´štCÚfig
();

34 
sw™chS’dMes§ge
();

35 
sw™chCÚfigu¿tiÚ
();

36 
sw™chAÉS‘tšg
();

37 
sw™chHuaweiMode
();

38 
sw™chS›¼aMode
();

39 
sw™chGCTMode
();

40 
sw™chAVMMode
();

41 
sw™chSÚyMode
();

42 
d‘achDriv”
();

43 
checkSucûss
();

44 
wr™e_bulk
(
’dpošt
, *
mes§ge
, 
Ëngth
);

45 
»ad_bulk
(
’dpošt
, *
bufãr
, 
Ëngth
);

46 
»Ëa£_usb_deviû
(
dummy
);

47 
usb_deviû
* 
£¬ch_deviûs
Ğ*
numFound
, 
v’dÜ
, 
´oduù
, * 
´oduùLi¡
, 
rg‘CÏss
);

48 
fšd_fœ¡_bulk_ouut_’dpošt
(
usb_deviû
 *
dev
);

49 
fšd_fœ¡_bulk_šput_’dpošt
(
usb_deviû
 *
dev
);

50 * 
R—dP¬£P¬am
(cÚ¡ * 
FeName
, *
V¬ŸbËName
);

51 
hex2num
(
c
);

52 
hex2by‹
(cÚ¡ *
hex
);

53 
hex¡r2bš
(cÚ¡ *
hex
, *
bufãr
, 
Ën
);

54 
´štV”siÚ
();

55 
»adArgum’ts
(
¬gc
, **
¬gv
);

56 
deviûDesütiÚ
();

57 
deviûInquœe
();

58 
»£tUSB
();

62 
	#ªd
 &&

	)

63 
	#Ü
 ||

	)

64 
	#nÙ
 !

	)

67 
	#b™ªd
 &

	)

68 
	#b™Ü
 |

	)

69 
	#com¶
 ~

	)

70 
	#xÜ
 ^

	)

73 
	#ªd_eq
 &=

	)

74 
	#nÙ_eq
 !=

	)

75 
	#Ü_eq
 |=

	)

76 
	#xÜ_eq
 ^=

	)

78 * 
R—dP¬£P¬am
(cÚ¡ * 
FeName
, *
V¬ŸbËName
);

80 *
TempPP
;

82 
	#P¬£P¬amSŒšg
(
P¬amFeName
, 
SŒ
) \

83 ià((
TempPP
=
	`R—dP¬£P¬am
((
P¬amFeName
), #SŒ))!=
NULL
) \

84 
	`¡rıy
(
SŒ
, 
TempPP
); SŒ[0]='\0'

	)

86 
	#P¬£P¬amIÁ
(
P¬amFeName
, 
IÁ
) \

87 ià((
TempPP
=
	`R—dP¬£P¬am
((
P¬amFeName
), #IÁ))!=
NULL
) \

88 
IÁ
=
	`©oi
(
TempPP
)

	)

90 
	#P¬£P¬amHex
(
P¬amFeName
, 
IÁ
) \

91 ià((
TempPP
=
	`R—dP¬£P¬am
((
P¬amFeName
), #IÁ))!=
NULL
) \

92 
IÁ
=
	`¡¹Ş
(
TempPP
, 
NULL
, 16)

	)

94 
	#P¬£P¬amFlßt
(
P¬amFeName
, 
FÉ
) \

95 ià((
TempPP
=
	`R—dP¬£P¬am
((
P¬amFeName
), #FÉ))!=
NULL
) \

96 
FÉ
=
	`©of
(
TempPP
)

	)

98 
	#P¬£P¬amBoŞ
(
P¬amFeName
, 
B
) \

99 ià((
TempPP
=
	`R—dP¬£P¬am
((
P¬amFeName
), #B))!=
NULL
) \

100 
B
=(
	`touµ”
(
TempPP
[0])=='Y' ||ouµ”(TempPP[0])=='T'|| TempPP[0]=='1'); B=0

	)

103 
»Ëa£_usb_deviû
(
dummy
);

105 
usb_deviû
* 
£¬ch_deviûs
(*
numFound
, 
v’dÜ
, 
´oduù
, *
´oduùLi¡
, 
rg‘CÏss
);

107 
hex¡r2bš
(cÚ¡ *
hex
, *
buf
, 
Ën
);

	@driver/lctserial.c

12 
	~<lšux/k”Ãl.h
>

13 
	~<lšux/š™.h
>

14 
	~<lšux/‰y.h
>

15 
	~<lšux/moduË.h
>

16 
	~<lšux/usb.h
>

17 
	~<lšux/usb/£rŸl.h
>

18 
	~<lšux/v”siÚ.h
>

23 
	#LCT_DRIVER_VERSION
 "v0.03"

	)

24 
	#LCT_DRIVER_DESC
 "LÚgch“¸usb modem driv”"

	)

25 
	#LCT_DRIVER_NAME
 "LÚgch“r"

	)

26 
	#LCT_DEVICE_DESC
 "LÚgch“¸usb modem"

	)

28 
	#LCT_VENDOR_ID
 0x1c9e

	)

29 
	#LCT_CM55_PID
 0x9e00

	)

30 
	#LCT_WM6100_PID
 0x9604

	)

31 
	#LCT_WM71_PID
 0x9603

	)

32 
	#LCT_WM7608_PID
 0x9800

	)

33 
	#LCT_WM7211_PID
 0x9605

	)

34 
	#LCT_WM7211_TATA_PID
 0x9803

	)

36 
usb_deviû_id
 
	glù_id_bË
 [] = {

37 { 
USB_DEVICE
(
LCT_VENDOR_ID
,
LCT_CM55_PID
) },

38 { 
USB_DEVICE
(
LCT_VENDOR_ID
,
LCT_WM6100_PID
)},

39 { 
USB_DEVICE
(
LCT_VENDOR_ID
,
LCT_WM7608_PID
)},

40 { 
USB_DEVICE
(
LCT_VENDOR_ID
,
LCT_WM71_PID
)},

41 { 
USB_DEVICE
(
LCT_VENDOR_ID
,
LCT_WM7211_PID
)},

42 { 
USB_DEVICE
(
LCT_VENDOR_ID
,
LCT_WM7211_TATA_PID
)},

46 
MODULE_DEVICE_TABLE
(
usb
, 
lù_id_bË
);

48 #if 
LINUX_VERSION_CODE
 <ğ
KERNEL_VERSION
(2,6,31)

49 
	$lù_£rŸl_İ’
(
‰y_¡ruù
 *
‰y
,

50 
usb_£rŸl_pÜt
 *
pÜt
, 
fe
 *
fp
)

52 
	$lù_£rŸl_İ’
(
‰y_¡ruù
 *
‰y
,

53 
usb_£rŸl_pÜt
 *
pÜt
)

56 
usb_£rŸl
 *
£rŸl
 = 
pÜt
->serial;

57 
	`usb_cÚŒŞ_msg
(
£rŸl
->
dev
, 
	`usb_rcvù¾pe
(£rŸl->dev, 0), 0x22, 0x21, 3, 0, 
NULL
, 0, 
USB_CTRL_SET_TIMEOUT
);

58 #if 
LINUX_VERSION_CODE
 <ğ
	`KERNEL_VERSION
(2,6,31)

59  
	`usb_£rŸl_g’”ic_İ’
(
‰y
,
pÜt
,
fp
);

61  
	`usb_£rŸl_g’”ic_İ’
(
‰y
,
pÜt
);

63 
	}
}

64 #ià
LINUX_VERSION_CODE
 <ğ
KERNEL_VERSION
(2,6,30)

65 
	$lù_£rŸl_şo£
(
‰y_¡ruù
 *
‰y
,

66 
usb_£rŸl_pÜt
 *
pÜt
, 
fe
 *
fp
)

68 
	$lù_£rŸl_şo£
(
usb_£rŸl_pÜt
 *
pÜt
)

71 
usb_£rŸl
 *
£rŸl
 = 
pÜt
->serial;

72 
	`usb_cÚŒŞ_msg
(
£rŸl
->
dev
, 
	`usb_rcvù¾pe
(£rŸl->dev, 0), 0x22, 0x21, 0, 0, 
NULL
, 0, 
USB_CTRL_SET_TIMEOUT
);

74 ià(
£rŸl
->
dev
)

76 ià(
£rŸl
->
num_bulk_out
)

77 
	`usb_kl_urb
(
pÜt
->
wr™e_urb
);

78 ià(
£rŸl
->
num_bulk_š
)

79 
	`usb_kl_urb
(
pÜt
->
»ad_urb
);

81 
	}
}

85 
usb_driv”
 
	glù_modem_driv”
 = {

86 .
Çme
 = 
LCT_DRIVER_NAME
,

87 .
	g´obe
 = 
usb_£rŸl_´obe
,

88 .
	gdiscÚÃù
 = 
usb_£rŸl_discÚÃù
,

89 .
	gno_dyÇmic_id
 = 1,

90 .
	gid_bË
 = 
lù_id_bË
,

94 
usb_£rŸl_driv”
 
	glù_modem_deviû
 = {

95 .
driv”
 = {

96 .
owÃr
 = 
THIS_MODULE
,

97 .
	gÇme
 = 
LCT_DRIVER_NAME
,

99 .
	gdesütiÚ
 = 
LCT_DEVICE_DESC
,

100 .
	gid_bË
 = 
lù_id_bË
,

101 .
	gusb_driv”
 = &
lù_modem_driv”
,

102 .
	gnum_pÜts
 = 1,

104 .
	gİ’
 = 
lù_£rŸl_İ’
,

105 .
	gşo£
 = 
lù_£rŸl_şo£
,

109 
__š™
 
	$lù_modem_š™
()

111 
»tv®
;

113 
»tv®
 = 
	`usb_£rŸl_»gi¡”
(&
lù_modem_deviû
);

115 ià(
»tv®
)

117  
»tv®
;

120 
»tv®
 = 
	`usb_»gi¡”
(&
lù_modem_driv”
);

122 ià(
»tv®
)

124 
	`usb_£rŸl_d”egi¡”
(&
lù_modem_deviû
);

125  
»tv®
;

128 
	`´štk
(
LCT_DRIVER_VERSION
": "
LCT_DRIVER_DESC
"\n");

131 
	}
}

133 
__ex™
 
	$lù_modem_ex™
()

135 
	`usb_d”egi¡”
(&
lù_modem_driv”
);

136 
	`usb_£rŸl_d”egi¡”
(&
lù_modem_deviû
);

137 
	}
}

139 
moduË_š™
(
lù_modem_š™
);

140 
moduË_ex™
(
lù_modem_ex™
);

142 
MODULE_DESCRIPTION
(
LCT_DRIVER_DESC
);

143 
MODULE_VERSION
(
LCT_DRIVER_VERSION
);

144 
MODULE_LICENSE
("GPL");

	@driver/ndis/src/lc_cdc_ether.c

21 
	~<lšux/moduË.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/Ãtdeviû.h
>

24 
	~<lšux/‘h”deviû.h
>

25 
	~<lšux/‘htoŞ.h
>

26 
	~<lšux/wÜkqueue.h
>

27 
	~<lšux/mii.h
>

28 
	~<lšux/usb.h
>

29 
	~<lšux/sched.h
>

30 
	~<lšux/ùy³.h
>

31 
	~<lšux/usb/cdc.h
>

32 
	~<lšux/usbdeviû_fs.h
>

34 
	~<lšux/v”siÚ.h
>

35 
	~"qmi_h—d”.h
"

36 
	~"qmi_İ”.h
"

38 
	#DRIVER_VERSION
 "v2.07.00.00"

	)

39 
	#DRIVER_AUTHOR
 "kahÀqŸØ<kahn.qŸo@LÚgch“r.com>"

	)

40 
	#DRIVER_DESC
 "LÚgch“¸‘h” driv” fÜ 3G d©¨ÿrdƒth” deviû"

	)

42 
	#RX_MAX_QUEUE_MEMORY
 (60 * 1518)

	)

43 
	#RX_QLEN
(
dev
è(((dev)->
udev
->
¥“d
 =ğ
USB_SPEED_HIGH
) ? \

44 (
RX_MAX_QUEUE_MEMORY
/(
dev
)->
rx_urb_size
è: 4)

	)

45 
	#TX_QLEN
(
dev
è(((dev)->
udev
->
¥“d
 =ğ
USB_SPEED_HIGH
) ? \

46 (
RX_MAX_QUEUE_MEMORY
/(
dev
)->
h¬d_mtu
è: 4)

	)

49 
	#TX_TIMEOUT_JIFFIES
 (5*
HZ
)

	)

53 
	#THROTTLE_JIFFIES
 (
HZ
/8)

	)

56 
	#UNLINK_TIMEOUT_MS
 3

	)

57 
	#PROCESS_ARP_PACKAGE


	)

58 
	#NDIS_INIT_STATUS


	)

61 
u8
 
	gnode_id
 [
ETH_ALEN
];

63 cÚ¡ 
	gdriv”_Çme
 [] = "lc_ether";

66 
	gmsg_Ëv–
 = -1;

67 
moduË_·¿m
 (
msg_Ëv–
, , 0);

68 
MODULE_PARM_DESC
 (
msg_Ëv–
, "Override default message†evel");

70 #´agm¨
·ck
(
push
, 1)

73 
	#ETH_TYPE_ARP
 0x0806

	)

74 
	#ETH_TYPE_IPV4
 0x0800

	)

75 
	#ETH_TYPE_IPV6
 0x86DD

	)

77 
	#ETH_LENGTH_OF_ADDRESS
 6

	)

79 
	#LC_INTERFACE_INDEX
 0X04

	)

81 
QC_ETH_HDR
 
	gfEth”ÃtH—d”
;

84 
	#lc_USB_RECEIVE_BUFFER_SIZE
 1600L

	)

86 
	#lc_USB_MRECEIVE_BUFFER_SIZE
 4096L

	)

88 
	#lc_USB_MRECEIVE_MAX_BUFFER_SIZE
 (1024*16)

	)

91 
	#EVENT_TX_HALT
 0

	)

92 
	#EVENT_RX_HALT
 1

	)

93 
	#EVENT_RX_MEMORY
 2

	)

94 
	#EVENT_STS_SPLIT
 3

	)

95 
	#EVENT_LINK_RESET
 4

	)

97 
	g¹_debug
 = 0;

98 
moduË_·¿m
(
¹_debug
, 
boŞ
, 
S_IRUGO
|
S_IWUSR
);

101 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,26)

102 
	~<lšux/uÇligÃd/acûss_ok.h
>

104 
šlše
 
u16
 
	$g‘_uÇligÃd_Ë16
(cÚ¡ *
p
)

106  
	`Ë16_to_ıup
((
__Ë16
 *)
p
);

107 
	}
}

109 
šlše
 
u32
 
	$g‘_uÇligÃd_Ë32
(cÚ¡ *
p
)

111  
	`Ë32_to_ıup
((
__Ë32
 *)
p
);

112 
	}
}

114 
šlše
 
	$put_uÇligÃd_Ë16
(
u16
 
v®
, *
p
)

116 *((
__Ë16
 *)
p
èğ
	`ıu_to_Ë16
(
v®
);

117 
	}
}

119 
šlše
 
	$put_uÇligÃd_Ë32
(
u32
 
v®
, *
p
)

121 *((
__Ë32
 *)
p
èğ
	`ıu_to_Ë32
(
v®
);

122 
	}
}

126 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,37)

127 
	#LINUX_VERSION37_LATER
 1

	)

129 
	#LINUX_VERSION37_LATER
 0

	)

132 
UIÁ8
 
	gfCurMacAdd»ss
[6]=

134 
UIÁ8
 
	gfD¡MacAdd»ss
[6]=

137 #ifdeà
INIT_NDP16_OPTS


138 #undeà
INIT_NDP16_OPTS


140 #ifdeà
INIT_NDP32_OPTS


141 #undeà
INIT_NDP32_OPTS


144 
NDIS_QMI_STATUS
 
	gndis_¡©us
;

146 #iâdeà
max


147 
	#max
(
_a
, 
_b
è(((_aè> (_b)è? (_aè: (_b))

	)

150 #iâdeà
mš


151 
	#mš
(
_a
, 
_b
è(((_aè< (_b)è? (_aè: (_b))

	)

154 
	slc_cdc_Ãt
{

156 
usb_deviû
 *
	mudev
;

157 
usb_š‹rçû
 *
	mštf
;

158 cÚ¡ *
	mdriv”_Çme
;

159 cÚ¡ *
	mdriv”_desc
;

160 *
	mdriv”_´iv
;

161 
wa™_queue_h—d_t
 *
	mwa™
;

162 
mu‹x
 
	mphy_mu‹x
;

165 
	mš
, 
	mout
;

166 
usb_ho¡_’dpošt
 *
	m¡©us
;

167 
	mmax·ck‘
;

168 
tim”_li¡
 
	md–ay
;

171 
Ãt_deviû
 *
	mÃt
;

172 
Ãt_deviû_¡©s
 
	m¡©s
;

173 
	mmsg_’abË
;

174 
	md©a
 [5];

175 
u32
 
	mxid
;

176 
u32
 
	mh¬d_mtu
;

177 
size_t
 
	mrx_urb_size
;

178 
mii_if_šfo
 
	mmii
;

181 
sk_buff_h—d
 
	mrxq
;

182 
sk_buff_h—d
 
	mtxq
;

183 
sk_buff_h—d
 
	mdÚe
;

184 
urb
 *
	mš‹¼u±
;

185 
skËt_¡ruù
 
	mbh
;

187 
wÜk_¡ruù
 
	mkev’t
;

188 
d–ayed_wÜk
 
	m¡©us_wÜk
;

189 
	mqmi_sync
;

190 
	mæags
;

191 
	msu¥’d_couÁ
;

192 }
__©Œibu‹__
((
·cked
)) ;

194 
šlše
 
usb_driv”
 *
	$driv”_of
(
usb_š‹rçû
 *
štf
)

196  
	`to_usb_driv”
(
štf
->
dev
.
driv”
);

197 
	}
}

204 
	slc_dev_¡©e
 {

205 
usb_cdc_h—d”_desc
 *
	mh—d”
;

206 
usb_cdc_uniÚ_desc
 *
	mu
;

207 
usb_cdc_‘h”_desc
 *
	m‘h”
;

208 
usb_š‹rçû
 *
	mcÚŒŞ
;

209 
usb_š‹rçû
 *
	md©a
;

214 
	eskb_¡©e
 {

215 
	mËg®
 = 0,

216 
	mtx_¡¬t
, 
	mtx_dÚe
,

217 
	mrx_¡¬t
, 
	mrx_dÚe
, 
	mrx_ş—nup


220 
	sskb_d©a
 {

221 
urb
 *
	murb
;

222 
lc_cdc_Ãt
 *
	mdev
;

223 
skb_¡©e
 
	m¡©e
;

224 
size_t
 
	mËngth
;

227 
	#devdbg
(
lc_cdc_Ãt
, 
fmt
, 
¬g
...) \

228 (()(
¹_debug
 && 
	`´štk
(
KERN_ERR
 "lc_cdc_driv”######: " 
fmt
 "\n" , ## 
¬g
)))

	)

231 
	#dev”r
(
lc_cdc_Ãt
, 
fmt
, 
¬g
...) \

232 
	`´štk
(
KERN_ERR
 "%s: " 
fmt
 "\n" , (
lc_cdc_Ãt
)->
Ãt
->
Çme
 , ## 
¬g
)

	)

233 
	#devw¬n
(
lc_cdc_Ãt
, 
fmt
, 
¬g
...) \

234 
	`´štk
(
KERN_WARNING
 "%s: " 
fmt
 "\n" , (
lc_cdc_Ãt
)->
Ãt
->
Çme
 , ## 
¬g
)

	)

236 
	#devšfo
(
lc_cdc_Ãt
, 
fmt
, 
¬g
...) \

237 
	`´štk
(
KERN_INFO
 "%s: " 
fmt
 "\n" , (
lc_cdc_Ãt
)->
Ãt
->
Çme
 , ## 
¬g
); \

238 

	)

241 #ifdeà
NDIS_INIT_STATUS


242 
lc_cdc_¡©us
(
lc_cdc_Ãt
 *
dev
, 
urb
 *urb);

244 
šlše
 
lc_g‘_‘h”Ãt_addr
(
lc_cdc_Ãt
 *
dev
);

245 
lc_cdc_bšd
(
lc_cdc_Ãt
 *
dev
, 
usb_š‹rçû
 *
štf
);

246 
lc_cdc_unbšd
(
lc_cdc_Ãt
 *
dev
, 
usb_š‹rçû
 *
štf
);

248 
lc_cdc_check_¡©us_wÜk
();

253 
lc_cdc_Ãt
 *
	gg_cdc_dev
 = 
NULL
;

254 
ndis_g‘_ş›Á_ID
(
lc_cdc_Ãt
 *
dev
);

255 
ndis_g‘_v”siÚ_šfo
(
lc_cdc_Ãt
 *
dev
);

256 
ndis_£t_š¡ªû_ID
(
lc_cdc_Ãt
 *
dev
);

257 
ndis_£t_d©a_fÜm©
(
lc_cdc_Ãt
 *
dev
);

258 
ndis_»Ëa£_ş›Á_ID
(
lc_cdc_Ãt
 *
dev
);

259 
ndis_cÚÃù
(
lc_cdc_Ãt
 *
dev
,*
acûssSŒšg
,

260 *
u£rName
,

261 *
·ssWÜd
,

262 
UIÁ8
 
com´essiÚ
,

263 
UIÁ32
 
CÚÃùIpMode
);

265 
ndis_g‘__addr
(
lc_cdc_Ãt
 *
dev
);

266 
ndis_discÚÃù
(
lc_cdc_Ãt
 *
dev
);

267 
lc_g‘_qmi_¡©us
(
usb_š‹rçû
 *
štf
);

269 #ifdeà
PROCESS_ARP_PACKAGE


270 
lc_skb_»tuº_¬p
 (
lc_cdc_Ãt
 *
dev
, 
sk_buff
 *
skb
);

271 
ProûssA½Pack‘
(
UIÁ8
 *
pD©a
, 
UIÁ32
 
·ck‘Ëngth
);

272 
Re¥Ú£A½Pack‘
(
UIÁ8
 *
pD©a
, 
UIÁ32
 
·ck‘Ëngth
);

273 
boŞ
 
F‹rA½Pack‘
(
UIÁ8
 *
pD©a
, 
UIÁ32
 
·ck‘Ëngth
);

276 
	mNDIS_CMD_CONNECT_CMD
 = 0xA0,

277 
	mNDIS_CMD_DISCONN_CMD
,

278 
	mNDIS_CMD_GET_VERSION
,

279 
	mNDIS_CMD_GET_STATUS
,

280 
	mNDIS_CMD_INIT_STATUS


282 
¥šlock_t
 
	gqmi_»que¡_lock
;

283 
	s__ndis_commªd_t
{

284 
	mcmd
;

285 
UIÁ8
 
	md©a
[
WWAN_STRING_LEN
*3+(
UIÁ32
)*2];

286 } 
	tndis_commªd_t
;

290 
	mcÚÃùiÚ_¡©us
;

291 
UIÁ32
 
	m_add»ss
;

292 } 
	tWWAN_STATUS
;

295 
	$lc_g‘_’dpošts
(
lc_cdc_Ãt
 *
dev
, 
usb_š‹rçû
 *
štf
)

297 
tmp
;

298 
usb_ho¡_š‹rçû
 *
®t
 = 
NULL
;

299 
usb_ho¡_’dpošt
 *
š
 = 
NULL
, *
out
 = NULL;

300 
usb_ho¡_’dpošt
 *
¡©us
 = 
NULL
;

302 
tmp
 = 0;m°< 
štf
->
num_®t£‰šg
;mp++) {

303 
•
;

305 
š
 = 
out
 = 
¡©us
 = 
NULL
;

306 
®t
 = 
štf
->
®t£‰šg
 + 
tmp
;

312 
•
 = 0;ƒ°< 
®t
->
desc
.
bNumEndpošts
;ƒp++) {

314 
usb_ho¡_’dpošt
 *
e
;

315 
šŒ
 = 0;

317 
e
 = 
®t
->
’dpošt
 + 
•
;

318 
e
->
desc
.
bmA‰ribu‹s
) {

319 
USB_ENDPOINT_XFER_INT
:

320 ià(!
	`usb_’dpošt_dœ_š
(&
e
->
desc
))

322 
šŒ
 = 1;

324 
USB_ENDPOINT_XFER_BULK
:

329 ià(
	`usb_’dpošt_dœ_š
(&
e
->
desc
)) {

330 ià(!
šŒ
 && !
š
)

331 
š
 = 
e
;

332 ià(
šŒ
 && !
¡©us
)

333 
¡©us
 = 
e
;

335 ià(!
out
)

336 
out
 = 
e
;

339 ià(
š
 && 
out
)

342 ià(!
®t
 || !
š
 || !
out
)

343  -
EINVAL
;

344 ià(
®t
->
desc
.
bAÉ”Ç‹S‘tšg
 != 0) {

345 
tmp
 = 
	`usb_£t_š‹rçû
 (
dev
->
udev
, 
®t
->
desc
.
bIÁ”çûNumb”
,

346 
®t
->
desc
.
bAÉ”Ç‹S‘tšg
);

347 ià(
tmp
 < 0)

348  
tmp
;

351 
dev
->
š
 = 
	`usb_rcvbulkpe
 (dev->
udev
,

352 
š
->
desc
.
bEndpoštAdd»ss
 & 
USB_ENDPOINT_NUMBER_MASK
);

353 
dev
->
out
 = 
	`usb_¢dbulkpe
 (dev->
udev
,

354 
out
->
desc
.
bEndpoštAdd»ss
 & 
USB_ENDPOINT_NUMBER_MASK
);

355 
dev
->
¡©us
 = status;

357 
	}
}

358 
EXPORT_SYMBOL_GPL
(
lc_g‘_’dpošts
);

359 #ifdeà 
NDIS_INIT_STATUS


360 
šŒ_com¶‘e
 (
urb
 *urb);

362 
	$š™_¡©us
 (
lc_cdc_Ãt
 *
dev
, 
usb_š‹rçû
 *
štf
)

364 *
buf
 = 
NULL
;

365 
pe
 = 0;

366 
maxp
;

367 
³riod
;

370 
pe
 = 
	`usb_rcvše
 (
dev
->
udev
,

371 
dev
->
¡©us
->
desc
.
bEndpoštAdd»ss


372 & 
USB_ENDPOINT_NUMBER_MASK
);

373 
maxp
 = 
	`usb_max·ck‘
 (
dev
->
udev
, 
pe
, 0);

376 
³riod
 = 
	`max
 ((è
dev
->
¡©us
->
desc
.
bIÁ”v®
,

377 (
dev
->
udev
->
¥“d
 =ğ
USB_SPEED_HIGH
) ? 7 : 3);

379 
buf
 = 
	`km®loc
 (
maxp
, 
GFP_KERNEL
);

380 ià(
buf
) {

381 
dev
->
š‹¼u±
 = 
	`usb_®loc_urb
 (0, 
GFP_KERNEL
);

382 ià(!
dev
->
š‹¼u±
) {

383 
	`kä“
 (
buf
);

384  -
ENOMEM
;

386 
	`usb_fl_št_urb
(
dev
->
š‹¼u±
, dev->
udev
, 
pe
,

387 
buf
, 
maxp
, 
šŒ_com¶‘e
, 
dev
, 
³riod
);

388 
	`devdbg
(
g_cdc_dev
,"statusƒp%din, %d bytes…eriod %d\n",

389 
	`usb_p“ndpošt
(
pe
), 
maxp
, 
³riod
);

393 
	}
}

396 #ifdeà
PROCESS_ARP_PACKAGE


398 
	$ProûssA½Pack‘
(
UIÁ8
 *
pD©a
, 
UIÁ32
 
·ck‘Ëngth
)

401 
QC_ARP_HDR
* 
pARPHdr
 = (QC_ARP_HDR*)(
pD©a
 + (
QC_ETH_HDR
));

402 
UIÁ8
 
‹mpHA
[
ETH_LENGTH_OF_ADDRESS
] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

403 
UIÁ32
 
sz
 = 0;

406 ià(
	`Áohs
(
pARPHdr
->
H¬dw¬eTy³
) != 1

407 || 
	`Áohs
(
pARPHdr
->
O³¿tiÚ
) != 1)

409 
	`devdbg
(
g_cdc_dev
,"%s : drop‡rp without hwype‡nd„equest,HardwareType=%u,Operation=%u.\n",

410 
__func__
, 
pARPHdr
->
H¬dw¬eTy³
,…ARPHdr->
O³¿tiÚ
);

415 ià(
	`Áohs
(
pARPHdr
->
PrÙocŞTy³
è!ğ
ETH_TYPE_IPV4
)

417 
	`devdbg
(
g_cdc_dev
,"%s : ignore…acket‚ot using ip v4,ProtocolType=%u.\n",

418 
__func__
, 
pARPHdr
->
PrÙocŞTy³
);

423 ià(
pARPHdr
->
HLEN
 !ğ
ETH_LENGTH_OF_ADDRESS
)

425 
	`devdbg
(
g_cdc_dev
,"ProûssA½Pack‘ : inv®id HLEN=%u,\n", 
pARPHdr
->
HLEN
);

429 ià(
pARPHdr
->
PLEN
 != 4)

431 
	`devdbg
(
g_cdc_dev
,"ProûssA½Pack‘ : inv®id PLEN=%u.\n", 
pARPHdr
->
PLEN
);

436 ià(
pARPHdr
->
S’d”IP
 =ğpARPHdr->
T¬g‘IP
)

438 
	`devdbg
(
g_cdc_dev
,"ProcessArpPacket : ignore gratuitous‡rp.\n");

442 
sz
 = 
	`memcmp
(
pARPHdr
->
T¬g‘HA
, 
‹mpHA
, 
ETH_LENGTH_OF_ADDRESS
);

444 ià(
pARPHdr
->
S’d”IP
 !ğ0 &&…ARPHdr->
T¬g‘IP
 !ğ
ndis_¡©us
.
fIPAdd»ss
)

446 
	`devdbg
(
g_cdc_dev
, "ProcessArpPacket :…rocess sender ip is‚ot‚ull,SenderIP=%u,fIPAddress=%u,TargetIP=%u.\n",

447 
pARPHdr
->
S’d”IP
, 
ndis_¡©us
.
fIPAdd»ss
,…ARPHdr->
T¬g‘IP
);

448 
	`Re¥Ú£A½Pack‘
(
pD©a
, 
·ck‘Ëngth
);

450 ià(
pARPHdr
->
S’d”IP
 =ğ0 && 
ETH_LENGTH_OF_ADDRESS
 =ğ
sz
)

452 
	`devdbg
(
g_cdc_dev
,"ProûssA½Pack‘ :…roûs £nd” i°i nuÎ,£nd”IP=%u,T¬g‘IP=%u.\n", 
pARPHdr
->
S’d”IP
,…ARPHdr->
T¬g‘IP
);

453 
	`Re¥Ú£A½Pack‘
(
pD©a
, 
·ck‘Ëngth
);

457 
	`devdbg
(
g_cdc_dev
,"ProcessArpPacket : drop other‡rp.\n");

459 
	}
}

461 
	$Re¥Ú£A½Pack‘
(
UIÁ8
 *
pD©a
, 
UIÁ32
 
·ck‘Ëngth
)

463 
QC_ETH_HDR
* 
pHdr
 = (QC_ETH_HDR*)
pD©a
;

464 
QC_ARP_HDR
* 
pARPHdr
 = (QC_ARP_HDR*)(
pD©a
 + (
QC_ETH_HDR
));

466 
QC_ETH_HDR
* 
pSkbHdr
 = 
NULL
;

467 
QC_ARP_HDR
* 
pSkbARPHdr
 = 
NULL
;

469 
sk_buff
 *
skb
;

470 
skb_d©a
 *
’Œy
;

473 ià((
skb
 = 
	`®loc_skb
 (
·ck‘Ëngth
 + 
NET_IP_ALIGN
, 
GFP_ATOMIC
)è=ğ
NULL
) {

474 
	`dev”r
 (
g_cdc_dev
, "no„x skb");

478 
skb
->
Ën
 = 
·ck‘Ëngth
;

479 
’Œy
 = (
skb_d©a
 *è
skb
->
cb
;

480 
’Œy
->
dev
 = 
g_cdc_dev
;

481 
’Œy
->
¡©e
 = 
rx_¡¬t
;

482 
’Œy
->
Ëngth
 = 0;

484 
pSkbHdr
 = (
QC_ETH_HDR
*)(
skb
->
d©a
);

485 
pSkbARPHdr
 = (
QC_ARP_HDR
*)((
UIÁ8
*)
pSkbHdr
 + (
QC_ETH_HDR
));

487 
	`memıy
(
pSkbHdr
,
pD©a
,
·ck‘Ëngth
);

490 
	`memıy
(
pSkbHdr
->
D¡MacAdd»ss
, 
pHdr
->
SrcMacAdd»ss
, 
ETH_LENGTH_OF_ADDRESS
);

492 
	`memıy
(
pSkbHdr
->
SrcMacAdd»ss
, 
fD¡MacAdd»ss
, 
ETH_LENGTH_OF_ADDRESS
);

495 
	`memıy
(
pSkbARPHdr
->
T¬g‘HA
, 
pARPHdr
->
S’d”HA
, 
ETH_LENGTH_OF_ADDRESS
);

496 
pSkbARPHdr
->
S’d”IP
 = 
pARPHdr
->
T¬g‘IP
;

498 
	`memıy
(
pSkbARPHdr
->
S’d”HA
, 
fD¡MacAdd»ss
, 
ETH_LENGTH_OF_ADDRESS
);

499 
pSkbARPHdr
->
T¬g‘IP
 = 
ndis_¡©us
.
fIPAdd»ss
;

502 
pSkbARPHdr
->
O³¿tiÚ
 =
	`Áohs
(0x0002);

505 
	`devdbg
(
g_cdc_dev
,"ResponseArpPacket : send backhe…acket.\n");

506 
	`lc_skb_»tuº_¬p
(
g_cdc_dev
, 
skb
);

509 
	}
}

511 
boŞ
 
	$F‹rA½Pack‘
(
UIÁ8
 *
pD©a
, 
UIÁ32
 
·ck‘Ëngth
)

513 
QC_ETH_HDR
* 
pHdr
 = (QC_ETH_HDR*)
pD©a
;

515 if(
ETH_TYPE_ARP
==
	`Áohs
(
pHdr
->
Eth”Ty³
))

517 
	`devdbg
 (
g_cdc_dev
, "ETH_TYPE_ARP.");

518 ià(
ndis_¡©us
.
fIPAdd»ss
 != 0)

520 
	`ProûssA½Pack‘
(
pD©a
, 
·ck‘Ëngth
);

522  
Œue
;

525 
	`devdbg
 (
g_cdc_dev
, "not‡‡rp…ackage.");

527  
çl£
;

528 
	}
}

534 
	$lc_skb_»tuº
 (
lc_cdc_Ãt
 *
dev
, 
sk_buff
 *
skb
)

536 
¡©us
;

537 
u32
 
¢
;

539 
	`devdbg
(
dev
,"%s:......¡¬t.",
__func__
);

540 if(
skb
->
Ën
 > 128)

542 
¢
 = 
	`be32_to_ıu
(*(
u32
 *)(
skb
->
d©a
 + 0x26));

543 
	`devdbg
(
dev
,"lc_skb_»tuº,Ën:%d„eûiv¢:%x,ime:%ld-%ld",
skb
->
Ën
,
¢
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

547 
¢
 = 
	`be32_to_ıu
(*(
u32
 *)(
skb
->
d©a
 + 0x2a));

548 
	`devdbg
(
dev
,"lc_skb_»tuº,Ën:%d„eûivack sn:%x,ime:%ld-%ld",
skb
->
Ën
,
¢
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

550 #ià
LINUX_VERSION_CODE
 <ğ
	`KERNEL_VERSION
(2,6,26)

551 
skb
->
dev
 = dev->
Ãt
;

553 
skb
->
d©a
 = skb->data -14;

554 
	`memıy
(
skb
->
d©a
,&
fEth”ÃtH—d”
,(fEthernetHeader));

555 
skb
->
Ën
 = skb->len +14;

557 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
 (skb, 
dev
->
Ãt
);

558 
dev
->
¡©s
.
rx_·ck‘s
++;

559 
dev
->
¡©s
.
rx_by‹s
 +ğ
skb
->
Ën
;

561 ià(
	`Ãtif_msg_rx_¡©us
 (
dev
))

562 
	`devdbg
(
g_cdc_dev
,"<„x,†en %zu,ype 0x%x.\n",

563 
skb
->
Ën
 +  (
‘hhdr
), skb->
´ÙocŞ
);

564 
	`mem£t
 (
skb
->
cb
, 0,  (
skb_d©a
));

565 
¡©us
 = 
	`Ãtif_rx
 (
skb
);

566 ià(
¡©us
 !ğ
NET_RX_SUCCESS
 && 
	`Ãtif_msg_rx_”r
 (
dev
))

567 
	`devdbg
(
g_cdc_dev
,"Ãtif_rx stu %d.\n", 
¡©us
);

568 
	}
}

569 #ifdeà
PROCESS_ARP_PACKAGE


570 
	$lc_skb_»tuº_¬p
 (
lc_cdc_Ãt
 *
dev
, 
sk_buff
 *
skb
)

572 
¡©us
;

573 
u32
 
¢
;

575 
	`devdbg
(
dev
,"%s:......¡¬t.",
__func__
);

576 #ià
LINUX_VERSION_CODE
 <ğ
	`KERNEL_VERSION
(2,6,26)

577 
skb
->
dev
 = dev->
Ãt
;

579 if(
skb
->
Ën
 > 128)

581 
¢
 = 
	`be32_to_ıu
(*(
u32
 *)(
skb
->
d©a
 + 0x26));

582 
	`devdbg
(
dev
,"lc_skb_»tuº,Ën:%d„eûiv¢:%x,ime:%ld-%ld",
skb
->
Ën
,
¢
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

586 
¢
 = 
	`be32_to_ıu
(*(
u32
 *)(
skb
->
d©a
 + 0x2a));

587 
	`devdbg
(
dev
,"lc_skb_»tuº,Ën:%d„eûivack sn:%x,ime:%ld-%ld",
skb
->
Ën
,
¢
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

589 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
 (skb, 
dev
->
Ãt
);

590 
dev
->
¡©s
.
rx_·ck‘s
++;

591 
dev
->
¡©s
.
rx_by‹s
 +ğ
skb
->
Ën
;

593 ià(
	`Ãtif_msg_rx_¡©us
 (
dev
))

594 
	`devdbg
(
g_cdc_dev
,"<„x,†en %zu,ype 0x%x.\n",

595 
skb
->
Ën
 +  (
‘hhdr
), skb->
´ÙocŞ
);

596 
	`mem£t
 (
skb
->
cb
, 0,  (
skb_d©a
));

597 
¡©us
 = 
	`Ãtif_rx
 (
skb
);

598 ià(
¡©us
 !ğ
NET_RX_SUCCESS
 && 
	`Ãtif_msg_rx_”r
 (
dev
))

599 
	`devdbg
(
g_cdc_dev
,"Ãtif_rx stu %d.\n", 
¡©us
);

600 
	}
}

602 
EXPORT_SYMBOL_GPL
(
lc_skb_»tuº
);

606 
	$uÆšk_urbs
 (
lc_cdc_Ãt
 *
dev
, 
sk_buff_h—d
 *
q
)

608 
æags
;

609 
sk_buff
 *
skb
, *
skbÃxt
;

610 
couÁ
 = 0;

612 
	`¥š_lock_œq§ve
 (&
q
->
lock
, 
æags
);

613 
skb
 = 
q
->
Ãxt
; skb !ğ(
sk_buff
 *èq; skb = 
skbÃxt
) {

614 
skb_d©a
 *
’Œy
;

615 
urb
 *urb;

616 
»tv®
;

618 
’Œy
 = (
skb_d©a
 *è
skb
->
cb
;

619 
urb
 = 
’Œy
->urb;

620 
skbÃxt
 = 
skb
->
Ãxt
;

624 
»tv®
 = 
	`usb_uÆšk_urb
 (
urb
);

625 ià(
»tv®
 !ğ-
EINPROGRESS
 &&„etval != 0)

626 
	`devdbg
 (
dev
, "uÆšk urbƒ¼, %d", 
»tv®
);

628 
couÁ
++;

630 
	`¥š_uÆock_œq»¡Üe
 (&
q
->
lock
, 
æags
);

631  
couÁ
;

632 
	}
}

638 
	$lc_uÆšk_rx_urbs
(
lc_cdc_Ãt
 *
dev
)

640 ià(
	`Ãtif_ruÂšg
(
dev
->
Ãt
)) {

641 (è
	`uÆšk_urbs
 (
dev
, &dev->
rxq
);

642 
	`skËt_scheduË
(&
dev
->
bh
);

644 
	}
}

645 
EXPORT_SYMBOL_GPL
(
lc_uÆšk_rx_urbs
);

653 
	$lc_chªge_mtu
 (
Ãt_deviû
 *
Ãt
, 
Ãw_mtu
)

655 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

656 
Î_mtu
 = 
Ãw_mtu
 + 
Ãt
->
h¬d_h—d”_Ën
;

657 
Şd_h¬d_mtu
 = 
dev
->
h¬d_mtu
;

658 
Şd_rx_urb_size
 = 
dev
->
rx_urb_size
;

661 ià(
Ãw_mtu
 <= 0)

662  -
EINVAL
;

664 ià((
Î_mtu
 % 
dev
->
max·ck‘
) == 0)

665  -
EDOM
;

666 
Ãt
->
mtu
 = 
Ãw_mtu
;

668 
dev
->
h¬d_mtu
 = 
Ãt
->
mtu
 +‚‘->
h¬d_h—d”_Ën
;

669 ià(
dev
->
rx_urb_size
 =ğ
Şd_h¬d_mtu
) {

670 
dev
->
rx_urb_size
 = dev->
h¬d_mtu
;

671 ià(
dev
->
rx_urb_size
 > 
Şd_rx_urb_size
)

672 
	`lc_uÆšk_rx_urbs
(
dev
);

675 
	`devdbg
(
g_cdc_dev
,"chªgmtu :%d, urb_size:%d",
Ãw_mtu
,
dev
->
rx_urb_size
);

678 
	}
}

682 
Ãt_deviû_¡©s
 *
	$lc_g‘_¡©s
 (
Ãt_deviû
 *
Ãt
)

684 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

685  &
dev
->
¡©s
;

686 
	}
}

690 
	$tx_deãr_bh
(
lc_cdc_Ãt
 *
dev
, 
sk_buff
 *
skb
, 
sk_buff_h—d
 *
li¡
)

692 
æags
;

694 
	`¥š_lock_œq§ve
(&
li¡
->
lock
, 
æags
);

695 
	`__skb_uÆšk
(
skb
, 
li¡
);

696 
	`¥š_uÆock
(&
li¡
->
lock
);

697 
	`¥š_lock
(&
dev
->
dÚe
.
lock
);

698 
	`__skb_queue_
(&
dev
->
dÚe
, 
skb
);

699 ià(1 <ğ
dev
->
dÚe
.
qËn
)

700 
	`skËt_scheduË
(&
dev
->
bh
);

701 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
dÚe
.
lock
, 
æags
);

702 
	}
}

703 
	$rx_deãr_bh
(
lc_cdc_Ãt
 *
dev
, 
sk_buff
 *
skb
, 
sk_buff_h—d
 *
li¡
)

705 
æags
;

706 
	`¥š_lock_œq§ve
(&
li¡
->
lock
, 
æags
);

707 
	`__skb_uÆšk
(
skb
, 
li¡
);

708 
	`¥š_uÆock_œq»¡Üe
(&
li¡
->
lock
, 
æags
);

711 
	`¥š_lock_œq§ve
(&
dev
->
dÚe
.
lock
, 
æags
);

712 
	`__skb_queue_
(&
dev
->
dÚe
, 
skb
);

713 ià(1 <ğ
dev
->
dÚe
.
qËn
){

714 
	`skËt_scheduË
(&
dev
->
bh
);

716 
	`¥š_uÆock_œq»¡Üe
(&
dev
->
dÚe
.
lock
, 
æags
);

718 
	}
}

726 
	$lc_deãr_kev’t
 (
lc_cdc_Ãt
 *
dev
, 
wÜk
)

728 
	`£t_b™
 (
wÜk
, &
dev
->
æags
);

729 ià(!
	`scheduË_wÜk
 (&
dev
->
kev’t
))

730 
	`dev”r
 (
dev
, "kev’ˆ%d may havb“Àdrİ³d", 
wÜk
);

732 
	`devdbg
 (
dev
, "kev’ˆ%d scheduËd", 
wÜk
);

733 
	}
}

734 
EXPORT_SYMBOL_GPL
(
lc_deãr_kev’t
);

741 
rx_com¶‘e
 (
urb
 *urb);

742 
	$rx_subm™
 (
lc_cdc_Ãt
 *
dev
, 
urb
 *urb, 
gå_t
 
æags
)

744 
sk_buff
 *
skb
;

745 
skb_d©a
 *
’Œy
;

746 
»tv®
 = 0;

747 
lockæags
;

748 
size_t
 
size
 = 
dev
->
rx_urb_size
;

751 
	`devdbg
(
dev
,"%s.....¡¬‹d.",
__func__
);

752 ià((
skb
 = 
	`®loc_skb
 (
size
 +14+ 
NET_IP_ALIGN
, 
æags
)è=ğ
NULL
) {

753 
	`dev”r
 (
dev
, "no„x skb");

754 
	`lc_deãr_kev’t
 (
dev
, 
EVENT_RX_MEMORY
);

755 
	`usb_ä“_urb
 (
urb
);

759 
	`skb_»£rve
 (
skb
, 14+
NET_IP_ALIGN
);

761 
’Œy
 = (
skb_d©a
 *è
skb
->
cb
;

762 
’Œy
->
urb
 = urb;

763 
’Œy
->
dev
 = dev;

764 
’Œy
->
¡©e
 = 
rx_¡¬t
;

765 
’Œy
->
Ëngth
 = 0;

767 
	`devdbg
(
dev
,"%s:g‘ d©¨size=%d.",
__func__
,
size
);

770 
	`usb_fl_bulk_urb
 (
urb
, 
dev
->
udev
, dev->
š
,

771 
skb
->
d©a
, 
size
, 
rx_com¶‘e
, skb);

774 
	`¥š_lock_œq§ve
 (&
dev
->
rxq
.
lock
, 
lockæags
);

777 ià(
	`Ãtif_ruÂšg
 (
dev
->
Ãt
)

778 && 
	`Ãtif_deviû_´e£Á
 (
dev
->
Ãt
)

779 && !
	`‹¡_b™
 (
EVENT_RX_HALT
, &
dev
->
æags
)) {

780 
»tv®
 = 
	`usb_subm™_urb
 (
urb
, 
GFP_ATOMIC
)) {

783 
	`__skb_queue_
 (&
dev
->
rxq
, 
skb
);

785 -
EPIPE
:

786 
	`lc_deãr_kev’t
 (
dev
, 
EVENT_RX_HALT
);

788 -
ENOMEM
:

789 
	`lc_deãr_kev’t
 (
dev
, 
EVENT_RX_MEMORY
);

791 -
ENODEV
:

792 ià(
	`Ãtif_msg_ifdown
 (
dev
))

793 
	`´štk
 ("%s:deviû gÚe.",
__func__
);

794 
	`Ãtif_deviû_d‘ach
 (
dev
->
Ãt
);

797 ià(
	`Ãtif_msg_rx_”r
 (
dev
))

798 
	`´štk
 ("%s:rx subm™, %d",
__func__
, 
»tv®
);

799 
	`skËt_scheduË
 (&
dev
->
bh
);

803 ià(
	`Ãtif_msg_ifdown
 (
dev
))

804 
	`´štk
 ("%s:rx: stİ³d",
__func__
);

805 
»tv®
 = -
ENOLINK
;

807 
	`¥š_uÆock_œq»¡Üe
 (&
dev
->
rxq
.
lock
, 
lockæags
);

809 
	`devdbg
(
dev
,"usb_subm™_urb stus:%x,ime:%ld-%ld.",
»tv®
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

811 ià(
»tv®
) {

813 
	`dev_kä“_skb_ªy
 (
skb
);

814 
	`usb_ä“_urb
 (
urb
);

816 
	}
}

820 
šlše
 
	$rx_´oûss
 (
lc_cdc_Ãt
 *
dev
, 
sk_buff
 *
skb
)

825 
	`devdbg
(
dev
,"%s: stk->Ën=%d.",
__func__
,
skb
->
Ën
);

830 ià(
skb
->
Ën
){

831 
	`lc_skb_»tuº
 (
dev
, 
skb
);

834 ià(
	`Ãtif_msg_rx_”r
 (
dev
))

835 
	`devdbg
 (
dev
, "drop");

836 
dev
->
¡©s
.
rx_”rÜs
++;

837 
	`skb_queue_
 (&
dev
->
dÚe
, 
skb
);

839 
	}
}

842 
	$rx_com¶‘e
 (
urb
 *urb)

844 
sk_buff
 *
skb
 = (sk_bufà*è
urb
->
cÚ‹xt
;

845 
skb_d©a
 *
’Œy
 = (skb_d©¨*è
skb
->
cb
;

846 
lc_cdc_Ãt
 *
dev
 = 
’Œy
->dev;

847 
urb_¡©us
 = 
urb
->
¡©us
;

849 
	`devdbg
(
g_cdc_dev
,"rx_com¶‘e,urb:%p,rx†’gth %d,im%ld-%ld.\n",
urb
, urb->
aùu®_Ëngth
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

850 
	`skb_put
 (
skb
, 
urb
->
aùu®_Ëngth
);

851 
’Œy
->
¡©e
 = 
rx_dÚe
;

852 
’Œy
->
urb
 = 
NULL
;

854 
urb_¡©us
) {

857 ià(
skb
->
Ën
 < 
dev
->
Ãt
->
h¬d_h—d”_Ën
) {

858 
’Œy
->
¡©e
 = 
rx_ş—nup
;

859 
dev
->
¡©s
.
rx_”rÜs
++;

860 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

861 ià(
	`Ãtif_msg_rx_”r
 (
dev
))

862 
	`devdbg
 (
dev
, "rx†’gth %d", 
skb
->
Ën
);

871 -
EPIPE
:

872 
dev
->
¡©s
.
rx_”rÜs
++;

873 
	`lc_deãr_kev’t
 (
dev
, 
EVENT_RX_HALT
);

877 -
ECONNRESET
:

878 -
ESHUTDOWN
:

879 ià(
	`Ãtif_msg_ifdown
 (
dev
))

880 
	`devdbg
 (
dev
, "rx shutdown, cod%d", 
urb_¡©us
);

881 
block
;

887 -
EPROTO
:

888 -
ETIME
:

889 -
EILSEQ
:

890 
dev
->
¡©s
.
rx_”rÜs
++;

891 ià(!
	`tim”_³ndšg
 (&
dev
->
d–ay
)) {

892 
	`mod_tim”
 (&
dev
->
d–ay
, 
jiff›s
 + 
THROTTLE_JIFFIES
);

893 ià(
	`Ãtif_msg_lšk
 (
dev
))

894 
	`devdbg
 (
dev
, "rxhrÙ%d", 
urb_¡©us
);

896 
block
:

897 
’Œy
->
¡©e
 = 
rx_ş—nup
;

898 
’Œy
->
urb
 = urb;

899 
urb
 = 
NULL
;

903 -
EOVERFLOW
:

904 
dev
->
¡©s
.
rx_ov”_”rÜs
++;

908 
’Œy
->
¡©e
 = 
rx_ş—nup
;

909 
dev
->
¡©s
.
rx_”rÜs
++;

910 ià(
	`Ãtif_msg_rx_”r
 (
dev
))

911 
	`devdbg
 (
dev
, "rx stu %d", 
urb_¡©us
);

915 
	`rx_deãr_bh
(
dev
, 
skb
, &dev->
rxq
);

917 ià(
urb
) {

918 ià(
	`Ãtif_ruÂšg
 (
dev
->
Ãt
)

919 && !
	`‹¡_b™
 (
EVENT_RX_HALT
, &
dev
->
æags
)) {

920 
	`rx_subm™
 (
dev
, 
urb
, 
GFP_ATOMIC
);

923 
	`usb_ä“_urb
 (
urb
);

925 ià(
	`Ãtif_msg_rx_”r
 (
dev
))

926 
	`´štk
 ("no„ead„esubmitted.\n");

927 
	}
}

928 #ifdeà
NDIS_INIT_STATUS


929 
	$šŒ_com¶‘e
 (
urb
 *urb)

931 
lc_cdc_Ãt
 *
dev
 = 
urb
->
cÚ‹xt
;

932 
¡©us
 = 
urb
->status;

934 
	`devdbg
(
g_cdc_dev
,"%s:...š™ stu com¶‘e.\n",
__func__
);

935 
¡©us
) {

938 
	`lc_cdc_¡©us
(
dev
, 
urb
);

942 -
ENOENT
:

943 -
ESHUTDOWN
:

944 ià(
	`Ãtif_msg_ifdown
 (
dev
))

945 
	`devdbg
 (
dev
, "šŒ shutdown, cod%d", 
¡©us
);

952 
	`devdbg
(
g_cdc_dev
,"šŒ stu %d.\n", 
¡©us
);

956 ià(!
	`Ãtif_ruÂšg
 (
dev
->
Ãt
))

959 
	`mem£t
(
urb
->
Œªsãr_bufãr
, 0, urb->
Œªsãr_bufãr_Ëngth
);

960 
¡©us
 = 
	`usb_subm™_urb
 (
urb
, 
GFP_ATOMIC
);

961 ià(
¡©us
 !ğ0 && 
	`Ãtif_msg_tim”
 (
dev
))

962 
	`devdbg
(
g_cdc_dev
,"šŒ„esubm™ --> %d.\n", 
¡©us
);

963 
	}
}

970 
	$lc_¡İ
 (
Ãt_deviû
 *
Ãt
)

972 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

973 
‹mp
;

974 
	`DECLARE_WAIT_QUEUE_HEAD_ONSTACK
 (
uÆšk_wakeup
);

975 
	`DECLARE_WAITQUEUE
 (
wa™
, 
cu¼’t
);

977 
	`Ãtif_¡İ_queue
 (
Ãt
);

979 ià(
	`Ãtif_msg_ifdown
 (
dev
))

980 
	`devdbg
(
g_cdc_dev
,"stop stats:„x/tx %ld/%ld,ƒrrs %ld/%ld",

981 
dev
->
¡©s
.
rx_·ck‘s
, dev->¡©s.
tx_·ck‘s
,

982 
dev
->
¡©s
.
rx_”rÜs
, dev->¡©s.
tx_”rÜs


986 
	`add_wa™_queue
 (&
uÆšk_wakeup
, &
wa™
);

987 
dev
->
wa™
 = &
uÆšk_wakeup
;

988 
‹mp
 = 
	`uÆšk_urbs
 (
dev
, &dev->
txq
è+ uÆšk_urb (dev, &dev->
rxq
);

991 !
	`skb_queue_em±y
(&
dev
->
rxq
)

992 && !
	`skb_queue_em±y
(&
dev
->
txq
)

993 && !
	`skb_queue_em±y
(&
dev
->
dÚe
)) {

994 
	`m¦“p
(
UNLINK_TIMEOUT_MS
);

995 ià(
	`Ãtif_msg_ifdown
 (
dev
))

996 
	`devdbg
(
g_cdc_dev
,"wa™ed fÜ %d urb com¶‘iÚs", 
‹mp
);

998 
dev
->
wa™
 = 
NULL
;

999 
	`»move_wa™_queue
 (&
uÆšk_wakeup
, &
wa™
);

1001 
	`usb_kl_urb
(
dev
->
š‹¼u±
);

1007 
dev
->
æags
 = 0;

1008 
	`d–_tim”_sync
 (&
dev
->
d–ay
);

1009 
	`skËt_kl
 (&
dev
->
bh
);

1010 
	`usb_autİm_put_š‹rçû
(
dev
->
štf
);

1013 
	}
}

1021 
	$lc_İ’
 (
Ãt_deviû
 *
Ãt
)

1023 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1024 
»tv®
;

1025 ià((
»tv®
 = 
	`usb_autİm_g‘_š‹rçû
(
dev
->
štf
)) < 0) {

1026 ià(
	`Ãtif_msg_ifup
 (
dev
))

1027 
	`devdbg
(
g_cdc_dev
,"resumption fail (%d)†c_cdc_net usb-%s-%s, %s",

1028 
»tv®
,

1029 
dev
->
udev
->
bus
->
bus_Çme
, dev->udev->
dev·th
,

1030 
dev
->
driv”_desc
);

1031 
dÚe_nİm
;

1035 ià(
dev
->
š‹¼u±
) {

1036 
»tv®
 = 
	`usb_subm™_urb
 (
dev
->
š‹¼u±
, 
GFP_KERNEL
);

1037 ià(
»tv®
 < 0) {

1038 ià(
	`Ãtif_msg_ifup
 (
dev
))

1039 
	`dev”r
 (
dev
, "šŒ subm™ %d", 
»tv®
);

1040 
dÚe
;

1044 
	`Ãtif_¡¬t_queue
 (
Ãt
);

1047 
	`skËt_scheduË
 (&
dev
->
bh
);

1048  
»tv®
;

1049 
dÚe
:

1050 
	`usb_autİm_put_š‹rçû
(
dev
->
štf
);

1051 
dÚe_nİm
:

1052  
»tv®
;

1053 
	}
}

1061 
	$lc_g‘_£‰šgs
 (
Ãt_deviû
 *
Ãt
, 
‘htoŞ_cmd
 *
cmd
)

1063 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1065 ià(!
dev
->
mii
.
mdio_»ad
)

1066  -
EOPNOTSUPP
;

1068  
	`mii_‘htoŞ_g£t
(&
dev
->
mii
, 
cmd
);

1069 
	}
}

1070 
EXPORT_SYMBOL_GPL
(
lc_g‘_£‰šgs
);

1072 
	$lc_£t_£‰šgs
 (
Ãt_deviû
 *
Ãt
, 
‘htoŞ_cmd
 *
cmd
)

1074 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1075 
»tv®
;

1077 ià(!
dev
->
mii
.
mdio_wr™e
)

1078  -
EOPNOTSUPP
;

1080 
»tv®
 = 
	`mii_‘htoŞ_s£t
(&
dev
->
mii
, 
cmd
);

1082  
»tv®
;

1084 
	}
}

1085 
EXPORT_SYMBOL_GPL
(
lc_£t_£‰šgs
);

1087 
u32
 
	$lc_g‘_lšk
 (
Ãt_deviû
 *
Ãt
)

1089 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1092 ià(
dev
->
mii
.
mdio_»ad
)

1093  
	`mii_lšk_ok
(&
dev
->
mii
);

1097 
	}
}

1098 
EXPORT_SYMBOL_GPL
(
lc_g‘_lšk
);

1100 
	$lc_nway_»£t
(
Ãt_deviû
 *
Ãt
)

1102 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1104 ià(!
dev
->
mii
.
mdio_wr™e
)

1105  -
EOPNOTSUPP
;

1107  
	`mii_nway_»¡¬t
(&
dev
->
mii
);

1108 
	}
}

1109 
EXPORT_SYMBOL_GPL
(
lc_nway_»£t
);

1111 
	$lc_g‘_drvšfo
 (
Ãt_deviû
 *
Ãt
, 
‘htoŞ_drvšfo
 *
šfo
)

1113 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1115 
	`¡ºıy
 (
šfo
->
driv”
, 
dev
->
driv”_Çme
,  info->driver);

1116 
	`¡ºıy
 (
šfo
->
v”siÚ
, 
DRIVER_VERSION
,  info->version);

1117 
	`¡ºıy
 (
šfo
->
fw_v”siÚ
, 
dev
->
driv”_desc
,

1118  
šfo
->
fw_v”siÚ
);

1119 
	`usb_make_·th
 (
dev
->
udev
, 
šfo
->
bus_šfo
,  info->bus_info);

1120 
	}
}

1121 
EXPORT_SYMBOL_GPL
(
lc_g‘_drvšfo
);

1123 
u32
 
	$lc_g‘_msgËv–
 (
Ãt_deviû
 *
Ãt
)

1125 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1127  
dev
->
msg_’abË
;

1128 
	}
}

1129 
EXPORT_SYMBOL_GPL
(
lc_g‘_msgËv–
);

1131 
	$lc_£t_msgËv–
 (
Ãt_deviû
 *
Ãt
, 
u32
 
Ëv–
)

1133 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1135 
dev
->
msg_’abË
 = 
Ëv–
;

1136 
	}
}

1137 
EXPORT_SYMBOL_GPL
(
lc_£t_msgËv–
);

1140 
‘htoŞ_İs
 
	glc_‘htoŞ_İs
 = {

1141 .
g‘_£‰šgs
 = 
lc_g‘_£‰šgs
,

1142 .
	g£t_£‰šgs
 = 
lc_£t_£‰šgs
,

1143 .
	gg‘_lšk
 = 
lc_g‘_lšk
,

1144 .
	gnway_»£t
 = 
lc_nway_»£t
,

1145 .
	gg‘_drvšfo
 = 
lc_g‘_drvšfo
,

1146 .
	gg‘_msgËv–
 = 
lc_g‘_msgËv–
,

1147 .
	g£t_msgËv–
 = 
lc_£t_msgËv–
,

1158 
	$kev’t
 (
wÜk_¡ruù
 *
wÜk
)

1160 
lc_cdc_Ãt
 *
dev
 =

1161 
	`cÚš”_of
(
wÜk
, 
lc_cdc_Ãt
, 
kev’t
);

1162 
¡©us
;

1165 
	`devdbg
(
dev
,"% ¡¬t.....",
__func__
);

1166 ià(
	`‹¡_b™
 (
EVENT_TX_HALT
, &
dev
->
æags
)) {

1167 
	`uÆšk_urbs
 (
dev
, &dev->
txq
);

1168 
¡©us
 = 
	`usb_ş—r_h®t
 (
dev
->
udev
, dev->
out
);

1169 ià(
¡©us
 < 0

1170 && 
¡©us
 !ğ-
EPIPE


1171 && 
¡©us
 !ğ-
ESHUTDOWN
) {

1172 ià(
	`Ãtif_msg_tx_”r
 (
dev
))

1173 
	`dev”r
 (
dev
, "can't clearx halt, status %d",

1174 
¡©us
);

1176 
	`ş—r_b™
 (
EVENT_TX_HALT
, &
dev
->
æags
);

1177 ià(
¡©us
 !ğ-
ESHUTDOWN
)

1178 
	`Ãtif_wake_queue
 (
dev
->
Ãt
);

1181 ià(
	`‹¡_b™
 (
EVENT_RX_HALT
, &
dev
->
æags
)) {

1182 
	`uÆšk_urbs
 (
dev
, &dev->
rxq
);

1183 
¡©us
 = 
	`usb_ş—r_h®t
 (
dev
->
udev
, dev->
š
);

1184 ià(
¡©us
 < 0

1185 && 
¡©us
 !ğ-
EPIPE


1186 && 
¡©us
 !ğ-
ESHUTDOWN
) {

1187 ià(
	`Ãtif_msg_rx_”r
 (
dev
))

1188 
	`dev”r
 (
dev
, "can't clear„x halt, status %d",

1189 
¡©us
);

1191 
	`ş—r_b™
 (
EVENT_RX_HALT
, &
dev
->
æags
);

1192 
	`skËt_scheduË
 (&
dev
->
bh
);

1197 ià(
	`‹¡_b™
 (
EVENT_RX_MEMORY
, &
dev
->
æags
)) {

1198 
urb
 *urb = 
NULL
;

1200 ià(
	`Ãtif_ruÂšg
 (
dev
->
Ãt
))

1201 
urb
 = 
	`usb_®loc_urb
 (0, 
GFP_KERNEL
);

1203 
	`ş—r_b™
 (
EVENT_RX_MEMORY
, &
dev
->
æags
);

1204 ià(
urb
 !ğ
NULL
) {

1205 
	`ş—r_b™
 (
EVENT_RX_MEMORY
, &
dev
->
æags
);

1206 
	`rx_subm™
 (
dev
, 
urb
, 
GFP_KERNEL
);

1207 
	`skËt_scheduË
 (&
dev
->
bh
);

1211 ià(
	`‹¡_b™
 (
EVENT_LINK_RESET
, &
dev
->
æags
)) {

1212 
	`ş—r_b™
 (
EVENT_LINK_RESET
, &
dev
->
æags
);

1215 ià(
dev
->
æags
)

1216 
	`devdbg
 (
dev
, "kevent done, flags = 0x%lx",

1217 
dev
->
æags
);

1218 
	}
}

1222 
	$tx_com¶‘e
 (
urb
 *urb)

1224 
sk_buff
 *
skb
 = (sk_bufà*è
urb
->
cÚ‹xt
;

1225 
skb_d©a
 *
’Œy
 = (skb_d©¨*è
skb
->
cb
;

1226 
lc_cdc_Ãt
 *
dev
 = 
’Œy
->dev;

1228 
	`devdbg
(
dev
,"tx_com¶‘e,¡©us:%d,Ën:%d, *********time:%ld-%ld.",
urb
->
¡©us
,
’Œy
->
Ëngth
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

1230 ià(
urb
->
¡©us
 == 0) {

1231 
dev
->
¡©s
.
tx_·ck‘s
++;

1232 
dev
->
¡©s
.
tx_by‹s
 +ğ
’Œy
->
Ëngth
;

1234 
dev
->
¡©s
.
tx_”rÜs
++;

1235 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1236 
urb
->
¡©us
) {

1237 -
EPIPE
:

1238 
	`lc_deãr_kev’t
 (
dev
, 
EVENT_TX_HALT
);

1239 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1243 -
ECONNRESET
:

1244 -
ESHUTDOWN
:

1245 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1250 -
EPROTO
:

1251 -
ETIME
:

1252 -
EILSEQ
:

1253 ià(!
	`tim”_³ndšg
 (&
dev
->
d–ay
)) {

1254 
	`mod_tim”
 (&
dev
->
d–ay
,

1255 
jiff›s
 + 
THROTTLE_JIFFIES
);

1256 ià(
	`Ãtif_msg_lšk
 (
dev
))

1257 
	`devdbg
(
dev
, "txhrottle %d",

1258 
urb
->
¡©us
);

1260 
	`Ãtif_¡İ_queue
 (
dev
->
Ãt
);

1261 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1264 ià(
	`Ãtif_msg_tx_”r
 (
dev
))

1265 
	`devdbg
(
dev
,"txƒ¼ %d.", 
’Œy
->
urb
->
¡©us
);

1270 
urb
->
dev
 = 
NULL
;

1271 
’Œy
->
¡©e
 = 
tx_dÚe
;

1272 
	`tx_deãr_bh
(
dev
, 
skb
, &dev->
txq
);

1273 
	}
}

1277 
	$lc_tx_timeout
 (
Ãt_deviû
 *
Ãt
)

1279 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1281 
	`uÆšk_urbs
 (
dev
, &dev->
txq
);

1282 
	`skËt_scheduË
 (&
dev
->
bh
);

1285 
	}
}

1289 
	$lc_¡¬t_xm™
 (
sk_buff
 *
skb
, 
Ãt_deviû
 *
Ãt
)

1291 
lc_cdc_Ãt
 *
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1292 
Ëngth
;

1293 
»tv®
 = 
NET_XMIT_SUCCESS
;

1294 
urb
 *urb = 
NULL
;

1295 
skb_d©a
 *
’Œy
;

1296 
æags
;

1299 
Ëngth
 = 
skb
->
Ën
;

1300 #ifdeà
PROCESS_ARP_PACKAGE


1301 if(
ndis_¡©us
.
fIPAdd»ss
!=0&&
	`F‹rA½Pack‘
(
skb
->
d©a
,skb->
Ën
))

1303 
drİ
;

1306 ià(!(
urb
 = 
	`usb_®loc_urb
 (0, 
GFP_ATOMIC
))) {

1307 ià(
	`Ãtif_msg_tx_”r
 (
dev
))

1308 
	`devdbg
 (
dev
, "no urb");

1309 
drİ
;

1312 
’Œy
 = (
skb_d©a
 *è
skb
->
cb
;

1313 
’Œy
->
urb
 = urb;

1314 
’Œy
->
dev
 = dev;

1315 
’Œy
->
¡©e
 = 
tx_¡¬t
;

1316 
’Œy
->
Ëngth
 =†ength;

1318 if(
ndis_¡©us
.
fIPAdd»ss
!=0)

1320 
	`usb_fl_bulk_urb
 (
urb
, 
dev
->
udev
, dev->
out
,

1321 
skb
->
d©a
+14, skb->
Ën
-14, 
tx_com¶‘e
, skb);

1324 
	`usb_fl_bulk_urb
 (
urb
, 
dev
->
udev
, dev->
out
,

1325 
skb
->
d©a
, skb->
Ën
, 
tx_com¶‘e
, skb);

1332 ià((
Ëngth
 % 
dev
->
max·ck‘
) == 0) {

1333 
urb
->
Œªsãr_bufãr_Ëngth
++;

1334 ià(
	`skb_room
(
skb
)) {

1335 
skb
->
d©a
[skb->
Ën
] = 0;

1336 
	`__skb_put
(
skb
, 1);

1340 
	`devdbg
(
dev
,"lc_¡¬t_xm™ ,usb_subm™_urb,Ën:%d,ime:%ld-%ld.",
skb
->
Ën
,
	`cu¼’t_k”Ãl_time
().
tv_£c
,cu¼’t_k”Ãl_time().
tv_n£c
);

1342 
	`¥š_lock_œq§ve
 (&
dev
->
txq
.
lock
, 
æags
);

1344 (
»tv®
 = 
	`usb_subm™_urb
 (
urb
, 
GFP_ATOMIC
))) {

1345 -
EPIPE
:

1346 
	`Ãtif_¡İ_queue
 (
Ãt
);

1347 
	`lc_deãr_kev’t
 (
dev
, 
EVENT_TX_HALT
);

1348 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1351 ià(
	`Ãtif_msg_tx_”r
 (
dev
))

1353 
	`´štk
 ("tx: subm™ urbƒ¼ %d.\n", 
»tv®
);

1355 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1358 
Ãt
->
Œªs_¡¬t
 = 
jiff›s
;

1359 
	`__skb_queue_
 (&
dev
->
txq
, 
skb
);

1360 ià(
dev
->
txq
.
qËn
 >ğ
	`TX_QLEN
 (dev))

1362 
	`Ãtif_¡İ_queue
 (
Ãt
);

1363 
	`devdbg
(
dev
,"%s:%d.",
__func__
,
__LINE__
);

1366 
	`¥š_uÆock_œq»¡Üe
 (&
dev
->
txq
.
lock
, 
æags
);

1368 ià(
»tv®
) {

1369 ià(
	`Ãtif_msg_tx_”r
 (
dev
))

1370 
	`devdbg
(
dev
,"drİ, cod%d", 
»tv®
);

1371 
drİ
:

1372 
»tv®
 = 
NET_XMIT_SUCCESS
;

1373 
dev
->
¡©s
.
tx_drİ³d
++;

1374 ià(
skb
)

1375 
	`dev_kä“_skb_ªy
 (
skb
);

1376 
	`usb_ä“_urb
 (
urb
);

1377 } ià(
	`Ãtif_msg_tx_queued
 (
dev
)) {

1378 
	`devdbg
 (
dev
, ">x,†en %d,ype 0x%x",

1379 
Ëngth
, 
skb
->
´ÙocŞ
);

1381  
»tv®
;

1382 
	}
}

1389 
	$lc_bh
 (
·¿m
)

1391 
lc_cdc_Ãt
 *
dev
 = (lc_cdc_Ãˆ*è
·¿m
;

1392 
sk_buff
 *
skb
;

1393 
skb_d©a
 *
’Œy
;

1395 
	`devdbg
(
dev
,"g‘ iÁØ..........%s.",
__func__
);

1396 (
skb
 = 
	`skb_dequeue
 (&
dev
->
dÚe
))) {

1397 
’Œy
 = (
skb_d©a
 *è
skb
->
cb
;

1398 
	`devdbg
(
dev
,"%s:’Œy->¡©e=%d.",
__func__
,
’Œy
->
¡©e
);

1399 
’Œy
->
¡©e
) {

1400 
rx_dÚe
:

1401 
’Œy
->
¡©e
 = 
rx_ş—nup
;

1402 
	`rx_´oûss
 (
dev
, 
skb
);

1404 
tx_dÚe
:

1405 
rx_ş—nup
:

1406 
	`usb_ä“_urb
 (
’Œy
->
urb
);

1407 
	`dev_kä“_skb
 (
skb
);

1410 
	`´štk
 ("%s:bogu skb s‹ %d.\n", 
__func__
,
’Œy
->
¡©e
);

1415 ià(
dev
->
wa™
) {

1416 
	`devdbg
(
dev
,"%s.............%d.",
__func__
,
__LINE__
);

1417 ià((
dev
->
txq
.
qËn
 + dev->
rxq
.qËÀ+ dev->
dÚe
.qlen) == 0) {

1418 
	`wake_up
 (
dev
->
wa™
);

1422 } ià(
	`Ãtif_ruÂšg
 (
dev
->
Ãt
)

1423 && 
	`Ãtif_deviû_´e£Á
 (
dev
->
Ãt
)

1424 && !
	`tim”_³ndšg
 (&
dev
->
d–ay
)

1425 && !
	`‹¡_b™
 (
EVENT_RX_HALT
, &
dev
->
æags
)) {

1426 
‹mp
 = 
dev
->
rxq
.
qËn
;

1427 
qËn
 = 
	`RX_QLEN
 (
dev
);

1428 
	`devdbg
(
dev
,"%s.............%d.",
__func__
,
__LINE__
);

1430 ià(
‹mp
 < 
qËn
) {

1431 
urb
 *urb;

1432 
i
;

1433 
	`devdbg
(
dev
,"%s.............%d.",
__func__
,
__LINE__
);

1435 
i
 = 0; i < 10 && 
dev
->
rxq
.
qËn
 < qlen; i++) {

1436 
	`devdbg
(
dev
,"%s.............%d.",
__func__
,
__LINE__
);

1437 
urb
 = 
	`usb_®loc_urb
 (0, 
GFP_ATOMIC
);

1438 ià(
urb
 !ğ
NULL
)

1439 
	`rx_subm™
 (
dev
, 
urb
, 
GFP_ATOMIC
);

1441 ià(
‹mp
 !ğ
dev
->
rxq
.
qËn
 && 
	`Ãtif_msg_lšk
 (dev))

1442 
	`´štk
 ("rxqlen %d --> %d.\n",

1443 
‹mp
, 
dev
->
rxq
.
qËn
);

1444 ià(
dev
->
rxq
.
qËn
 < qlen)

1445 
	`skËt_scheduË
 (&
dev
->
bh
);

1447 ià(
dev
->
txq
.
qËn
 < 
	`TX_QLEN
 (dev))

1448 
	`Ãtif_wake_queue
 (
dev
->
Ãt
);

1450 
	}
}

1461 
	$lc_discÚÃù
 (
usb_š‹rçû
 *
štf
)

1463 
lc_cdc_Ãt
 *
dev
;

1464 
usb_deviû
 *
xdev
;

1465 
Ãt_deviû
 *
Ãt
;

1467 
dev
 = 
	`usb_g‘_štfd©a
(
štf
);

1468 
	`usb_£t_štfd©a
(
štf
, 
NULL
);

1469 ià(!
dev
)

1472 
xdev
 = 
	`š‹rçû_to_usbdev
 (
štf
);

1474 ià(
	`Ãtif_msg_´obe
 (
dev
))

1475 
	`devšfo
 (
dev
, "unregister '%s' usb-%s-%s, %s",

1476 
štf
->
dev
.
driv”
->
Çme
,

1477 
xdev
->
bus
->
bus_Çme
, xdev->
dev·th
,

1478 
dev
->
driv”_desc
);

1480 
	`ndis_»Ëa£_ş›Á_ID
(
g_cdc_dev
);

1482 
	`ÿnûl_d–ayed_wÜk_sync
(&
dev
->
¡©us_wÜk
);

1484 
Ãt
 = 
dev
->net;

1487 
	`æush_scheduËd_wÜk
 ();

1489 
	`lc_cdc_unbšd
(
dev
, 
štf
);

1490 
	`uÄegi¡”_Ãtdev
 (
Ãt
);

1491 
	`ä“_Ãtdev
(
Ãt
);

1492 
	`usb_put_dev
 (
xdev
);

1493 
	}
}

1494 
EXPORT_SYMBOL_GPL
(
lc_discÚÃù
);

1496 
	$lc_ndis_ioùl
(
Ãt_deviû
 *
dev
,
iäeq
 *
»q
, 
cmd
)

1498 
ndis_commªd_t
* 
²dis_»q
 = 
NULL
;

1499 
»t
 = -1;

1501 
	`devdbg
(
dev
,"g‘ iÁØ%s,cmd=%d.",
__func__
,
cmd
);

1503 if(!
	`Ãtif_ruÂšg
(
dev
)||
cmd
!=
SIOCDEVPRIVATE
)

1504  -
EINVAL
;

1506 
²dis_»q
 = (
ndis_commªd_t
*)
»q
->
iä_d©a
;

1507 
²dis_»q
->
cmd
)

1509 
NDIS_CMD_INIT_STATUS
:

1511 
	`lc_g‘_qmi_¡©us
(
g_cdc_dev
->
štf
);

1512 if(
g_cdc_dev
->
qmi_sync
==0)

1514 
	`lc_cdc_check_¡©us_wÜk
();

1518 
NDIS_CMD_CONNECT_CMD
:

1520 
WWAN_CONNECT_PARAMS
* 
·rms
 = 
NULL
;

1522 
	`devdbg
(
dev
,"%s:cÚÃù ioùl.",
__func__
);

1524 
·rms
 = (
WWAN_CONNECT_PARAMS
*)
²dis_»q
->
d©a
;

1525 
	`devdbg
(
dev
,"%s:cÚÃù ioùl. cÚÃù mod%d",
__func__
,
·rms
->
CÚÃùIpMode
);

1526 
»t
 = 
	`ndis_cÚÃù
(
g_cdc_dev
,
·rms
->
AcûssSŒšg
,·rms->
U£rName
,

1527 
·rms
->
PasswÜd
,·rms->
Comm´essiÚ
,·rms->
CÚÃùIpMode
);

1529 
	`cİy_to_u£r
((*)
»q
->
iä_d©a
,&(
ndis_¡©us
.
fCÚÃùiÚE¼Ü
),(ndis_status.fConnectionError));

1532 
NDIS_CMD_DISCONN_CMD
:

1534 
	`devdbg
(
dev
,"%s:discÚÃù ioùl.",
__func__
);

1535 
	`ndis_discÚÃù
(
g_cdc_dev
);

1538 
NDIS_CMD_GET_VERSION
:

1540 
	`devdbg
(
dev
,"%s:g‘ v”siÚ ioùl.",
__func__
);

1541 
	`cİy_to_u£r
((*)
»q
->
iä_d©a
,
ndis_¡©us
.
fV”siÚ
,(ndis_status.fVersion));

1544 
NDIS_CMD_GET_STATUS
:

1546 
WWAN_STATUS
 
m_¡©us
;

1547 
	`devdbg
(
dev
,"%s:g‘ stu ioùl.",
__func__
);

1548 
	`lc_g‘_qmi_¡©us
(
g_cdc_dev
->
štf
);

1549 
m_¡©us
.
cÚÃùiÚ_¡©us
 = 
ndis_¡©us
.
fCÚÃùiÚStus
;

1550 
m_¡©us
.
_add»ss
 = 
ndis_¡©us
.
fIPAdd»ss
;

1551 
	`cİy_to_u£r
((*)
»q
->
iä_d©a
,&
m_¡©us
,(
WWAN_STATUS
));

1555 
	`devdbg
(
dev
,"unsuµÜˆcmmmªd%d.",
cmd
);

1558 
	}
}

1561 #ià!(
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 30))

1562 
	$lc_‘h_mac_addr
(
Ãt_deviû
 *
dev
, *
p
)

1564 
	`memıy
(
dev
->
dev_addr
,
fEth”ÃtH—d”
.
SrcMacAdd»ss
,
ETH_LENGTH_OF_ADDRESS
);

1567 
	}
}

1568 cÚ¡ 
Ãt_deviû_İs
 
	glc_Ãtdev_İs
 = {

1569 .
ndo_İ’
 = 
lc_İ’
,

1570 .
	gndo_¡İ
 = 
lc_¡İ
,

1571 .
	gndo_¡¬t_xm™
 = 
lc_¡¬t_xm™
,

1572 .
	gndo_tx_timeout
 = 
lc_tx_timeout
,

1573 .
	gndo_chªge_mtu
 = 
lc_chªge_mtu
,

1574 .
	gndo_do_ioùl
 = 
lc_ndis_ioùl
,

1575 .
	gndo_£t_mac_add»ss
 = 
lc_‘h_mac_addr
,

1576 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr
,

1577 .
	gndo_g‘_¡©s
 = 
lc_g‘_¡©s
,

1582 
lc_check_cÚn_¡©us
(
usb_š‹rçû
 *
štf
);

1586 
	$lc_cdc_´obe
 (
usb_š‹rçû
 *
udev
, cÚ¡ 
usb_deviû_id
 *
´od
)

1588 
lc_cdc_Ãt
 *
dev
;

1589 
Ãt_deviû
 *
Ãt
;

1590 
usb_ho¡_š‹rçû
 *
š‹rçû
;

1591 
usb_deviû
 *
xdev
;

1592 
¡©us
;

1593 cÚ¡ *
Çme
;

1595 
Çme
 = 
udev
->
dev
.
driv”
->name;

1596 
xdev
 = 
	`š‹rçû_to_usbdev
 (
udev
);

1597 
š‹rçû
 = 
udev
->
cur_®t£‰šg
;

1599 
	`usb_g‘_dev
 (
xdev
);

1601 
¡©us
 = -
ENOMEM
;

1604 
Ãt
 = 
	`®loc_‘h”dev
((*
dev
));

1605 ià(!
Ãt
) {

1606 
	`dbg
 ("can't kmalloc dev");

1607 
out
;

1610 
dev
 = 
	`Ãtdev_´iv
(
Ãt
);

1611 
g_cdc_dev
 = 
dev
;

1612 
dev
->
udev
 = 
xdev
;

1613 
dev
->
štf
 = 
udev
;

1616 #ifdeà 
CONFIG_PM_RUNTIME


1617 if(
LINUX_VERSION37_LATER
)

1619 
dev
->
štf
->dev.
pow”
.
di§bË_d•th
 = 0;

1624 
dev
->
driv”_Çme
 = 
Çme
;

1625 
dev
->
driv”_desc
 = "Longcheer Ethernet Device";

1626 
dev
->
msg_’abË
 = 
	`Ãtif_msg_š™
 (
msg_Ëv–
, 
NETIF_MSG_DRV


1627 | 
NETIF_MSG_PROBE
 | 
NETIF_MSG_LINK
);

1628 
	`skb_queue_h—d_š™
 (&
dev
->
rxq
);

1629 
	`skb_queue_h—d_š™
 (&
dev
->
txq
);

1630 
	`skb_queue_h—d_š™
 (&
dev
->
dÚe
);

1631 
dev
->
bh
.
func
 = 
lc_bh
;

1632 
dev
->
bh
.
d©a
 = () dev;

1633 
	`INIT_WORK
 (&
dev
->
kev’t
, kevent);

1634 
dev
->
d–ay
.
funùiÚ
 = 
lc_bh
;

1635 
dev
->
d–ay
.
d©a
 = () dev;

1636 
	`š™_tim”
 (&
dev
->
d–ay
);

1637 
	`mu‹x_š™
 (&
dev
->
phy_mu‹x
);

1639 
dev
->
Ãt
 =‚et;

1641 
	`memıy
 (
Ãt
->
dev_addr
, 
node_id
, ‚ode_id);

1646 
dev
->
h¬d_mtu
 = 
Ãt
->
mtu
 +‚‘->
h¬d_h—d”_Ën
;

1648 #ià!(
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 30))

1649 
Ãt
->
Ãtdev_İs
 = &
lc_Ãtdev_İs
;

1651 
Ãt
->
chªge_mtu
 = 
lc_chªge_mtu
;

1652 
Ãt
->
g‘_¡©s
 = 
lc_g‘_¡©s
;

1653 
Ãt
->
h¬d_¡¬t_xm™
 = 
lc_¡¬t_xm™
;

1654 
Ãt
->
İ’
 = 
lc_İ’
;

1655 
Ãt
->
¡İ
 = 
lc_¡İ
;

1656 
Ãt
->
do_ioùl
 = 
lc_ndis_ioùl
;

1657 
Ãt
->
tx_timeout
 = 
lc_tx_timeout
;

1659 
Ãt
->
w©chdog_timeo
 = 
TX_TIMEOUT_JIFFIES
;

1660 
Ãt
->
‘htoŞ_İs
 = &
lc_‘htoŞ_İs
;

1663 
¡©us
 = 
	`lc_cdc_bšd
 (
dev
, 
udev
);

1664 ià(
¡©us
 < 0)

1665 
out1
;

1668 
	`¡rıy
 (
Ãt
->
Çme
, "wan%d");

1672 ià(
Ãt
->
mtu
 > (
dev
->
h¬d_mtu
 -‚‘->
h¬d_h—d”_Ën
))

1673 
Ãt
->
mtu
 = 
dev
->
h¬d_mtu
 -‚‘->
h¬d_h—d”_Ën
;

1675 #ifdeà
NDIS_INIT_STATUS


1676 ià(
¡©us
 >ğ0 && 
dev
->status)

1677 
¡©us
 = 
	`š™_¡©us
 (
dev
, 
udev
);

1678 ià(
¡©us
 < 0)

1679 
out3
;

1682 
dev
->
rx_urb_size
 = 
Ãt
->
mtu
;

1684 
dev
->
max·ck‘
 = 
	`usb_max·ck‘
 (dev->
udev
, dev->
out
, 1);

1685 
	`devdbg
(
dev
,"%s:dev->rx_urb_size=%u,dev->max·ck‘=%u.\n",
__func__
,dev->
rx_urb_size
,dev->
max·ck‘
);

1686 
	`SET_NETDEV_DEV
(
Ãt
, &
udev
->
dev
);

1687 
¡©us
 = 
	`»gi¡”_Ãtdev
 (
Ãt
);

1688 ià(
¡©us
)

1689 
out3
;

1691 
	`usb_£t_štfd©a
 (
udev
, 
dev
);

1693 
	`Ãtif_deviû_©ch
 (
Ãt
);

1698 
	`Ãtif_ÿ¼›r_off
(
Ãt
);

1700 
dev
->
qmi_sync
 = 0;

1706 
	`mem£t
(&
ndis_¡©us
,0,(ndis_status));

1707 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_DISCONNECTED
;

1708 
	`¥š_lock_š™
(&
qmi_»que¡_lock
);

1711 
out3
:

1712 
	`lc_cdc_unbšd
 (
dev
, 
udev
);

1713 
out1
:

1714 
	`ä“_Ãtdev
(
Ãt
);

1715 
out
:

1716 
	`usb_put_dev
(
xdev
);

1717  
¡©us
;

1718 
	}
}

1719 
EXPORT_SYMBOL_GPL
(
lc_cdc_´obe
);

1728 
	$lc_su¥’d
 (
usb_š‹rçû
 *
štf
, 
pm_mes§ge_t
 
mes§ge
)

1730 
lc_cdc_Ãt
 *
dev
 = 
	`usb_g‘_štfd©a
(
štf
);

1732 ià(!
dev
->
su¥’d_couÁ
++) {

1737 
	`Ãtif_deviû_d‘ach
 (
dev
->
Ãt
);

1738 (è
	`uÆšk_urbs
 (
dev
, &dev->
rxq
);

1739 (è
	`uÆšk_urbs
 (
dev
, &dev->
txq
);

1744 
	`Ãtif_deviû_©ch
 (
dev
->
Ãt
);

1747 
	}
}

1748 
EXPORT_SYMBOL_GPL
(
lc_su¥’d
);

1750 
	$lc_»sume
 (
usb_š‹rçû
 *
štf
)

1752 
lc_cdc_Ãt
 *
dev
 = 
	`usb_g‘_štfd©a
(
štf
);

1754 ià(!--
dev
->
su¥’d_couÁ
)

1755 
	`skËt_scheduË
 (&
dev
->
bh
);

1758 
	}
}

1759 
EXPORT_SYMBOL_GPL
(
lc_»sume
);

1761 
	$lc_cdc_»£t_»sume
(
usb_š‹rçû
 *
štf
)

1763  
	`lc_»sume
 (
štf
);

1764 
	}
}

1772 
	#USB_DEVICE_LÚgch“r_DATA
 0xFF

	)

1773 
	$lc_cdc_bšd
(
lc_cdc_Ãt
 *
dev
, 
usb_š‹rçû
 *
štf
)

1778 
lc_dev_¡©e
 *
šfo
 = (*è&
dev
->
d©a
;

1779 
¡©us
;

1781 
	`devdbg
(
dev
,"lc_cdc_bindƒnter.");

1783 ià( 
dev
->
d©a
 <  *
šfo
)

1784  -
EDOM
;

1786 ià(
LC_INTERFACE_INDEX
 !ğ
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
)

1787  -
EDOM
;

1789 
	`memıy
(
fEth”ÃtH—d”
.
D¡MacAdd»ss
, 
fCurMacAdd»ss
, 
ETH_LENGTH_OF_ADDRESS
);

1790 
	`memıy
(
fEth”ÃtH—d”
.
SrcMacAdd»ss
, 
fD¡MacAdd»ss
, 
ETH_LENGTH_OF_ADDRESS
);

1791 
fEth”ÃtH—d”
.
Eth”Ty³
 = 
	`htÚs
(
ETH_TYPE_IPV4
);

1793 
	`mem£t
(
šfo
, 0,  *info);

1795 
šfo
->
d©a
 = 
	`usb_iâum_to_if
(
dev
->
udev
,
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
);

1797 
¡©us
 = 
	`lc_g‘_’dpošts
(
dev
, 
šfo
->
d©a
);

1798 ià(
¡©us
 < 0) {

1800 
”rÜ3
;

1803  
	`lc_g‘_‘h”Ãt_addr
(
dev
);

1805 
”rÜ3
:

1807 
	`usb_£t_štfd©a
(
šfo
->
d©a
, 
NULL
);

1808 
	`usb_driv”_»Ëa£_š‹rçû
(
	`driv”_of
(
štf
), 
šfo
->
d©a
);

1810  
¡©us
;

1812 
	`devšfo
(
dev
, "bad CDC descriptors\n");

1813  -
ENODEV
;

1814 
	}
}

1816 
	$lc_cdc_unbšd
(
lc_cdc_Ãt
 *
dev
, 
usb_š‹rçû
 *
štf
)

1818 
lc_dev_¡©e
 *
šfo
 = (*è&
dev
->
d©a
;

1819 
usb_driv”
 *
driv”
 = 
	`driv”_of
(
štf
);

1822 ià(
štf
 =ğ
šfo
->
cÚŒŞ
 && info->
d©a
) {

1824 
	`usb_£t_štfd©a
(
šfo
->
d©a
, 
NULL
);

1825 
	`usb_driv”_»Ëa£_š‹rçû
(
driv”
, 
šfo
->
d©a
);

1826 
šfo
->
d©a
 = 
NULL
;

1830 ià(
štf
 =ğ
šfo
->
d©a
 && info->
cÚŒŞ
) {

1832 
	`usb_£t_štfd©a
(
šfo
->
cÚŒŞ
, 
NULL
);

1833 
	`usb_driv”_»Ëa£_š‹rçû
(
driv”
, 
šfo
->
cÚŒŞ
);

1834 
šfo
->
cÚŒŞ
 = 
NULL
;

1837 
	}
}

1838 
EXPORT_SYMBOL_GPL
(
lc_cdc_unbšd
);

1853 #ifdeà
NDIS_INIT_STATUS


1854 
	$dump¥“d
(
lc_cdc_Ãt
 *
dev
, 
__Ë32
 *
¥“ds
)

1856 ià(
	`Ãtif_msg_tim”
(
dev
))

1857 
	`devšfo
(
dev
, "link speeds: %u kbps up, %u kbps down",

1858 
	`__Ë32_to_ıu
(
¥“ds
[0]) / 1000,

1859 
	`__Ë32_to_ıu
(
¥“ds
[1]) / 1000);

1860 
	}
}

1862 
šlše
 
	$lc_g‘_‘h”Ãt_addr
(
lc_cdc_Ãt
 *
dev
)

1873 
dev
->
Ãt
->
dev_addr
[0] = 0x00;

1874 
dev
->
Ãt
->
dev_addr
[1] = 0xA0;

1875 
dev
->
Ãt
->
dev_addr
[2] = 0xC6;

1876 
dev
->
Ãt
->
dev_addr
[3] = 0x00;

1877 
dev
->
Ãt
->
dev_addr
[4] = 0x00;

1878 
dev
->
Ãt
->
dev_addr
[5] = 0x00;

1881 
	}
}

1883 
	#lc_CDC_OK
 0

	)

1884 
	#lc_CDC_FAIL
 -1

	)

1886 
	#LONGCHEER_INTERFACE_VDF
 \

1887 .
bIÁ”çûCÏss
 = 0xFF, \

1888 .
bIÁ”çûSubCÏss
 = 0xFF, \

1889 .
bIÁ”çûPrÙocŞ
 = 0xFF

	)

1891 
	#LONGCHEER_INTERFACE_RMNET_VDF
 \

1892 .
bIÁ”çûCÏss
 = 0xFF, \

1893 .
bIÁ”çûSubCÏss
 = 0x06, \

1894 .
bIÁ”çûPrÙocŞ
 = 0x00

	)

1896 cÚ¡ 
usb_deviû_id
 
	glc_´oduùs
 [] = {

1898 .
m©ch_æags
 = 
USB_DEVICE_ID_MATCH_INT_INFO


1899 | 
USB_DEVICE_ID_MATCH_VENDOR
,

1900 .
	gidV’dÜ
 = 0X1C9E,

1901 
	gLONGCHEER_INTERFACE_VDF
,

1904 .
	gm©ch_æags
 = 
USB_DEVICE_ID_MATCH_INT_INFO


1905 | 
USB_DEVICE_ID_MATCH_VENDOR
,

1906 .
	gidV’dÜ
 = 0X05c6,

1907 
	gLONGCHEER_INTERFACE_VDF
,

1910 .
	gm©ch_æags
 = 
USB_DEVICE_ID_MATCH_INT_INFO


1911 | 
USB_DEVICE_ID_MATCH_VENDOR
,

1912 .
	gidV’dÜ
 = 0X1C9E,

1913 
	gLONGCHEER_INTERFACE_RMNET_VDF
,

1917 
MODULE_DEVICE_TABLE
(
usb
, 
lc_´oduùs
);

1919 
lc_cdc_»£t_»sume
(
usb_š‹rçû
 *
štf
);

1920 
usb_driv”
 
	glc_‘h”_driv”
 = {

1921 .
Çme
 = "lc_ether",

1922 .
	gid_bË
 = 
lc_´oduùs
,

1923 .
	g´obe
 = 
lc_cdc_´obe
,

1924 .
	gdiscÚÃù
 = 
lc_discÚÃù
,

1925 .
	gsu¥’d
 = 
lc_su¥’d
,

1926 .
	g»sume
 = 
lc_»sume
,

1927 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2,6,26)

1928 .
	g»£t_»sume
 = 
lc_cdc_»£t_»sume
,

1931 #ifdeà
NDIS_INIT_STATUS


1933 
	$lc_cdc_¡©us
(
lc_cdc_Ãt
 *
dev
, 
urb
 *urb)

1935 
usb_cdc_nÙifiÿtiÚ
 *
ev’t
;

1937 ià(
urb
->
aùu®_Ëngth
 <  *
ev’t
)

1941 ià(
	`‹¡_ªd_ş—r_b™
(
EVENT_STS_SPLIT
, &
dev
->
æags
)) {

1942 
	`devdbg
(
dev
, "The speed is changed by statusƒvent");

1943 
	`dump¥“d
(
dev
, (
__Ë32
 *è
urb
->
Œªsãr_bufãr
);

1947 
ev’t
 = 
urb
->
Œªsãr_bufãr
;

1948 
ev’t
->
bNÙifiÿtiÚTy³
) {

1949 
USB_CDC_NOTIFY_NETWORK_CONNECTION
:

1950 ià(
	`Ãtif_msg_tim”
(
dev
))

1951 
	`devdbg
(
dev
, "CDC: carrier %s",

1952 
ev’t
->
wV®ue
 ? "on" : "off");

1953 ià(
ev’t
->
wV®ue
)

1954 
	`Ãtif_ÿ¼›r_Ú
(
dev
->
Ãt
);

1956 
	`Ãtif_ÿ¼›r_off
(
dev
->
Ãt
);

1959 
USB_CDC_NOTIFY_SPEED_CHANGE
:

1960 ià(
	`Ãtif_msg_tim”
(
dev
))

1961 
	`devdbg
(
dev
, "CDC: speed change (len %d)",

1962 
urb
->
aùu®_Ëngth
);

1963 ià(
urb
->
aùu®_Ëngth
 !ğ( *
ev’t
 + 8))

1964 
	`£t_b™
(
EVENT_STS_SPLIT
, &
dev
->
æags
);

1966 
	`dump¥“d
(
dev
, (
__Ë32
 *è&
ev’t
[1]);

1969 
USB_CDC_NOTIFY_RESPONSE_AVAILABLE
:

1975 
	`devdbg
(
dev
, "%s: CDC: uÃx³ùed‚ÙifiÿtiÚ %02x!", 
__FUNCTION__
,

1976 
ev’t
->
bNÙifiÿtiÚTy³
);

1979 
	}
}

1982 
__š™
 
	$lc_cdc_š™
()

1984 
	`BUG_ON
(((((
lc_cdc_Ãt
 *)0)->
d©a
)

1985 < (
lc_dev_¡©e
)));

1987  
	`usb_»gi¡”
(&
lc_‘h”_driv”
);

1988 
	}
}

1989 
fs_š™ÿÎ
(
lc_cdc_š™
);

1991 
lc_£nd_qmi_»que¡
(
usb_š‹rçû
 *
štf
, 
UIÁ8
 
»qesy_ty³
,

1992 
UIÁ8
 *
¢d_»q
, 
¢d_Ën
,

1993 
UIÁ8
 *
»ad_»¥
, 
»¥_Ën
);

1995 
	$ndis_g‘_ş›Á_ID
(
lc_cdc_Ãt
 *
dev
)

1997 
UIÁ8
 
commªd_buf
[128] = {0};

1998 
UIÁ8
 
»¥_buf
[128] = {0};

1999 
»t
 = 0;

2000 
Ën
 = 0;

2002 
Ën
 = 
	`QCTL_G‘Cl›ÁID
(
commªd_buf
,(command_buf),0x01);

2003 if(
Ën
>0)

2005 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_GET_CLIENT_ID
,
commªd_buf
, 
Ën
, 
»¥_buf
, 64);

2008 ià(
QMI_GET_CLIENT_ID
 !ğ
»t
){

2009 
	`´štk
(
KERN_ERR
 "%s: G‘ cl›Á ID faed\n", 
__FUNCTION__
);

2013 
	}
}

2014 
	$ndis_g‘_v”siÚ_šfo
(
lc_cdc_Ãt
 *
dev
)

2016 
UIÁ8
 
commªd_buf
[128] = {0};

2017 
UIÁ8
 
»¥_buf
[128] = {0};

2018 
»t
 = 0;

2019 
Ën
 = 0;

2021 
	`mem£t
(
»¥_buf
, 0, (resp_buf));

2022 
Ën
 = 
	`QCTL_G‘V”siÚReq
(
commªd_buf
,(command_buf));

2023 if(
Ën
>0)

2025 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_GET_VERSION
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2028 ià(0 > 
»t
){

2029 
	`´štk
(
KERN_ERR
 "%s: G‘ v”siÚ faed\n", 
__FUNCTION__
);

2033 
	}
}

2034 
	$ndis_£t_š¡ªû_ID
(
lc_cdc_Ãt
 *
dev
)

2036 
UIÁ8
 
commªd_buf
[128] = {0};

2037 
UIÁ8
 
»¥_buf
[128] = {0};

2038 
»t
 = 0;

2039 
Ën
 = 0;

2041 
	`mem£t
(
»¥_buf
, 0, (resp_buf));

2042 
Ën
 = 
	`QCTL_S‘In¡ªûId
(
commªd_buf
,(command_buf));

2043 if(
Ën
>0)

2045 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_SET_INSTANCE
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2048 ià(0 > 
»t
){

2049 
	`´štk
(
KERN_ERR
 "%s: S‘ In¡ªû ID faed\n", 
__FUNCTION__
);

2053 
	}
}

2054 
	$ndis_£t_d©a_fÜm©
(
lc_cdc_Ãt
 *
dev
)

2056 
UIÁ8
 
commªd_buf
[128] = {0};

2057 
UIÁ8
 
»¥_buf
[128] = {0};

2058 
»t
 = 0;

2059 
Ën
 = 0;

2062 
Ën
 = 
	`QCTL_S‘D©aFÜm©Req
(
commªd_buf
,(command_buf));

2063 if(
Ën
>0)

2065 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_SET_DATA_FORMAT
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2068 ià(0 > 
»t
){

2069 
	`´štk
(
KERN_ERR
 "%s: s‘ d©¨fÜm© faed\n", 
__func__
);

2073 
	}
}

2075 
	$ndis_»Ëa£_ş›Á_ID
(
lc_cdc_Ãt
 *
dev
)

2077 
UIÁ8
 
commªd_buf
[128] = {0};

2078 
UIÁ8
 
»¥_buf
[128] = {0};

2079 
»t
 = 0;

2080 
Ën
 = 0;

2083 
Ën
 = 
	`QCTL_R–—£Cl›ÁID
(
commªd_buf
,(commªd_buf),&
ndis_¡©us
);

2084 if(
Ën
>0)

2086 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_RELEASE_CLIENT_ID
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2089 ià(0 > 
»t
){

2090 
	`´štk
(
KERN_ERR
 "%s:„–—£ cl›Á ID faed\n", 
__FUNCTION__
);

2094 
	}
}

2096 
	$ndis_cÚÃù
(
lc_cdc_Ãt
 *
dev
,*
acûssSŒšg
,

2097 *
u£rName
,

2098 *
·ssWÜd
,

2099 
UIÁ8
 
com´essiÚ
,

2100 
UIÁ32
 
CÚÃùIpMode
)

2102 
UIÁ8
 
commªd_buf
[128] = {0};

2103 
UIÁ8
 
»¥_buf
[256] = {0};

2104 
»t
 = 0;

2105 
Ën
 = 0;

2106 
ndis_¡©us
.
fCÚÃùiÚE¼Ü
 = -1;

2110 
	`mem£t
(
commªd_buf
, 0, (command_buf));

2111 
Ën
 = 
	`QC_WDS_ModifyProfe
(
commªd_buf
,(commªd_buf),&
ndis_¡©us
,

2112 
acûssSŒšg
,
u£rName
,
·ssWÜd
,
com´essiÚ
,

2113 
CÚÃùIpMode
);

2114 if(
Ën
>0)

2116 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_MODIFY_PRO
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2119 ifĞ
CÚÃùIpMode
 == 2)

2121 
	`mem£t
(
commªd_buf
, 0, 128);

2122 
	`mem£t
(
»¥_buf
, 0, 256);

2123 
	`devdbg
(
dev
,"%s:cÚÃù ioùl. cÚÃù ipv4",
__func__
);

2124 
Ën
 = 
	`QC_WDS_CÚÃù
(
commªd_buf
,(commªd_buf),
ndis_¡©us
.
fCl›ÁID
,

2125 
acûssSŒšg
,
u£rName
,
·ssWÜd
,
com´essiÚ
,
IPv4
);

2126 if(
Ën
>0)

2128 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_CONNECT
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2131 
	`mem£t
(
commªd_buf
, 0, 128);

2132 
	`mem£t
(
»¥_buf
, 0, 256);

2133 
	`devdbg
(
dev
,"%s:cÚÃù ioùl. cÚÃù ipv6",
__func__
);

2134 
Ën
 = 
	`QC_WDS_CÚÃù
(
commªd_buf
,(commªd_buf),
ndis_¡©us
.
fCl›ÁID
,

2135 
acûssSŒšg
,
u£rName
,
·ssWÜd
,
com´essiÚ
,
IPv6
);

2136 if(
Ën
>0)

2138 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_CONNECT
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2146 
	`devdbg
(
dev
,"%s:cÚÃù ioùl. cÚÃù ipv4 o¸v6",
__func__
);

2147 
Ën
 = 
	`QC_WDS_CÚÃù
(
commªd_buf
,(commªd_buf),
ndis_¡©us
.
fCl›ÁID
,

2148 
acûssSŒšg
,
u£rName
,
·ssWÜd
,
com´essiÚ
,
CÚÃùIpMode
);

2149 if(
Ën
>0)

2151 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_CONNECT
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2156 ià(
»t
 < 0)

2160 
»t
 = 
	`ndis_g‘__addr
(
dev
);

2161  
»t
;

2162 
	}
}

2164 
	$ndis_g‘__addr
(
lc_cdc_Ãt
 *
dev
)

2166 
UIÁ8
 
commªd_buf
[128] = {0};

2167 
UIÁ8
 
»¥_buf
[256] = {0};

2168 
»t
 = 0;

2169 
Ën
 = 0;

2171 
ndis_¡©us
.
fIPAdd»ss
 = 0;

2172 
ndis_¡©us
.
fCÚÃùiÚE¼Ü
 = 0;

2174 
Ën
 = 
	`QC_WDS_G‘IPAdd»ss
(
commªd_buf
,(commªd_buf),
ndis_¡©us
.
fCl›ÁID
);

2175 if(
Ën
>0)

2177 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_GET_IP_ADDR
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2180 ià(
»t
 < 0)

2182 
	`´štk
("failedo get ip‡ddress.\n");

2187 
	`´štk
(
KERN_ERR
 "%s: c¬r›¸Ú\n", 
__func__
);

2188 
	`Ãtif_ÿ¼›r_Ú
(
dev
->
Ãt
);

2191 
	}
}

2192 
	$ndis_discÚÃù
(
lc_cdc_Ãt
 *
dev
)

2194 
UIÁ8
 
commªd_buf
[128] = {0};

2195 
UIÁ8
 
»¥_buf
[128] = {0};

2196 
»t
 = 0;

2197 
Ën
 = 0;

2199 if(!
ndis_¡©us
.
fPack‘HªdË
)

2201 
	`mem£t
(
commªd_buf
, 0, (command_buf));

2202 
	`mem£t
(
»¥_buf
, 0, (resp_buf));

2203 
Ën
 = 
	`QC_WDS_DiscÚÃù
(
commªd_buf
,(commªd_buf),&
ndis_¡©us
,0);

2204 if(
Ën
>0)

2206 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_DISCONNECT
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2209 ià(!
ndis_¡©us
.
fPack‘HªdË1
)

2211 
	`mem£t
(
commªd_buf
, 0, (command_buf));

2212 
	`mem£t
(
»¥_buf
, 0, (resp_buf));

2213 
Ën
 = 
	`QC_WDS_DiscÚÃù
(
commªd_buf
,(commªd_buf),&
ndis_¡©us
,1);

2214 if(
Ën
>0)

2216 
»t
 = 
	`lc_£nd_qmi_»que¡
(
dev
->
štf
,
QMI_DISCONNECT
,
commªd_buf
, 
Ën
, 
»¥_buf
, (resp_buf));

2225 
	}
}

2227 
	$lc_cdc_check_¡©us_wÜk
()

2231 
lc_cdc_Ãt
 *
dev
 = 
g_cdc_dev
;

2233 
»t
 = 0;

2240 
»t
 = 
	`ndis_g‘_v”siÚ_šfo
(
dev
);

2241 if(-1 =ğ
»t
)

2243 
çed
;

2245 
	`m¦“p
(80);

2247 
»t
 = 
	`ndis_£t_š¡ªû_ID
(
dev
);

2248 if(-1 =ğ
»t
)

2250 
çed
;

2252 
	`m¦“p
(80);

2254 
»t
 = 
	`ndis_£t_d©a_fÜm©
(
dev
);

2255 if(-1 =ğ
»t
)

2257 
çed
;

2259 
	`m¦“p
(80);

2261 
»t
 = 
	`ndis_g‘_ş›Á_ID
(
dev
);

2262 if(-1 =ğ
»t
)

2264 
çed
;

2268 
çed
:

2270 
dev
->
qmi_sync
 = 1;

2273 
	}
}

2275 
	$lc_g‘_qmi_¡©us
(
usb_š‹rçû
 *
štf
)

2277 
UIÁ8
 
»ad_»¥
[128];

2278 
»¥_Ën
 = (
»ad_»¥
);

2279 
usb_deviû
 *
udev
 = 
	`š‹rçû_to_usbdev
(
štf
);

2280 
»t
 = -1;

2281 
šdex
 = 0;

2283 
šdex
++ < 3)

2285 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2286 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2287 
»ad_»¥
, 
»¥_Ën
, 1000);

2288 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2290 ià(
»t
 <= 0)

2292 
	`m¦“p
(10);

2295 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2296 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2297 ià(
QMI_CONNECT
 =ğ
»t
)

2299 ifĞ0 =ğ
ndis_¡©us
.
fCÚÃùiÚE¼Ü
)

2301 
	`devdbg
(
g_cdc_dev
,"connecto internet success.");

2302 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_GETTING_IP
;

2303 
	`ndis_g‘__addr
(
g_cdc_dev
);

2306 
	`devdbg
(
g_cdc_dev
,"connectingo internet failed.");

2307 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_DISCONNECTED
;

2310 ià(
QMI_DISCONNECT
 =ğ
»t
)

2312 
	`devdbg
(
g_cdc_dev
,"disconnected from internet success.");

2313 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_DISCONNECTED
;

2314  
»t
;

2316 if(
QMI_GET_IP_ADDR
 =ğ
»t
)

2318 ifĞ0 =ğ
ndis_¡©us
.
fCÚÃùiÚE¼Ü
 && 0 !ğndis_¡©us.
fIPAdd»ss
)

2320 
	`devdbg
(
g_cdc_dev
,"connecto internet success.");

2321 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_IP_GETTED
;

2324 
	`devdbg
(
g_cdc_dev
,"connectingo internet failed.");

2325 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_DISCONNECTED
;

2328 
»t
 = 0;

2331 if(
šdex
==3)

2332 
	`devdbg
(
g_cdc_dev
,"%s:‚Ùhšg qm˜»¥Ú£ ...\n", 
__func__
);

2334  
»t
;

2335 
	}
}

2337 
	$lc_£nd_qmi_»que¡
(
usb_š‹rçû
 *
štf
, 
UIÁ8
 
»qesy_ty³
,

2338 
UIÁ8
 *
¢d_»q
, 
¢d_Ën
,

2339 
UIÁ8
 *
»ad_»¥
, 
»¥_Ën
)

2341 
»t
;

2342 
šdex
 = 0;

2344 
æags
;

2345 
usb_deviû
 *
udev
 = 
	`š‹rçû_to_usbdev
(
štf
);

2348 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_¢dù¾pe
(udev, 0), 0x00,

2349 0x21, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2350 
¢d_»q
, 
¢d_Ën
, 5000);

2351 
	`devdbg
(
g_cdc_dev
,"£nd qm˜»que¡: %d ",
»t
);

2352 
	`´štk_hex
(
¢d_»q
,
¢d_Ën
);

2353 ià(
»t
 < 0){

2354 
	`´štk
(
KERN_ERR
"%s: s’dhqm˜»que¡ faed\n", 
__FUNCTION__
);

2356  
»t
;

2358 
	`m¦“p
(80);

2359 
»qesy_ty³
)

2361 
QMI_GET_CLIENT_ID
:

2362 
šdex
++ < 10)

2364 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2365 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2366 
»ad_»¥
, 
»¥_Ën
, 1000);

2367 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2369 ià(
»t
 <= 0)

2372 
	`m¦“p
(10);

2375 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2376 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2377 ià(
QMI_GET_CLIENT_ID
 =ğ
»t
)

2379 
	`devdbg
(
g_cdc_dev
,"g‘ qm˜Cl›ÁID„e¥Ú£ sucûss.ş›Áid=%u:\n",
ndis_¡©us
.
fCl›ÁID
);

2381  
»t
;

2385 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2386 
»t
 = -2;

2388 
QMI_RELEASE_CLIENT_ID
:

2389 
šdex
++ < 10)

2391 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2392 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2393 
»ad_»¥
, 
»¥_Ën
, 1000);

2394 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2396 ià(
»t
 <= 0)

2399 
	`m¦“p
(10);

2403 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2404 ià(
QMI_RELEASE_CLIENT_ID
 =ğ
»t
)

2406 
	`devdbg
(
g_cdc_dev
,"R–—£ qm˜Cl›ÁID sucûss.ş›Áid=%u:",
ndis_¡©us
.
fCl›ÁID
);

2408  
»t
;

2412 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2413 
»t
 = -2;

2415 
QMI_CONNECT
:

2416 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_CONNECTING
;

2417 
šdex
++ < 50)

2419 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2420 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2421 
»ad_»¥
, 
»¥_Ën
, 1000);

2422 
	`devdbg
(
g_cdc_dev
,"g‘ QMI_CONNECT„e¥Ú£,šdex=%d:",
šdex
);

2424 ià(
»t
 <= 0)

2427 
	`m¦“p
(100);

2430 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2431 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2432 ià(
QMI_CONNECT
 =ğ
»t
)

2435 ifĞ0 =ğ
ndis_¡©us
.
fCÚÃùiÚE¼Ü
)

2437 
	`devdbg
(
g_cdc_dev
,"connecto internet success.");

2438 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_GETTING_IP
;

2442 
	`devdbg
(
g_cdc_dev
,"connecto internet failed.");

2443 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_DISCONNECTED
;

2449 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2450 
»t
 = -2;

2452 
QMI_DISCONNECT
:

2453 
šdex
++ < 10)

2455 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2456 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2457 
»ad_»¥
, 
»¥_Ën
, 1000);

2458 
	`´štk
("g‘ QMI_DISCONNECT„e¥Ú£,šdex=%d:\n",
šdex
);

2460 ià(
»t
 <= 0)

2462 
	`´štk
(
KERN_ERR
"%s: G‘ QMI_DISCONNECT„e¥Ú£ faed\n", 
__func__
);

2463 
	`m¦“p
(10);

2466 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2467 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2468 
	`¥š_uÆock_œq»¡Üe
 (&
qmi_»que¡_lock
, 
æags
);

2469 ià(
QMI_DISCONNECT
 =ğ
»t
)

2471 
	`´štk
("call QMI_DISCONNECT success.\n");

2472  
»t
;

2476 
ndis_¡©us
.
fCÚÃùiÚStus
 = 
LC_DISCONNECTING
;

2477 
»t
 = -2;

2479 
QMI_GET_IP_ADDR
:

2481 
šdex
++ < 20)

2483 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2484 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2485 
»ad_»¥
, 
»¥_Ën
, 3000);

2488 ià(
»t
 <= 0)

2491 
	`m¦“p
(100);

2495 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2496 ià(
QMI_GET_IP_ADDR
 =ğ
»t
 )

2499 if(0 =ğ
ndis_¡©us
.
fCÚÃùiÚE¼Ü
)

2514 
»t
 = -2;

2517 
QMI_SET_DATA_FORMAT
:

2518 
šdex
++ < 10)

2520 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2521 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2522 
»ad_»¥
, 
»¥_Ën
, 1000);

2523 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2524 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2525 ià(
»t
 <= 0)

2527 
	`m¦“p
(10);

2530 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2531 ià(
QMI_SET_DATA_FORMAT
 =ğ
»t
)

2533 
	`devdbg
(
g_cdc_dev
,"get Set data format success.");

2535  
»t
;

2539 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2540 
»t
 = -2;

2542 
QMI_MODIFY_PRO
:

2543 
šdex
++ < 10)

2545 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2546 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2547 
»ad_»¥
, 
»¥_Ën
, 1000);

2548 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2551 ià(
»t
 < 0)

2553 
	`´štk
(
KERN_ERR
"%s: S‘ In¡ªû faed. %d", 
__func__
,
»t
);

2554 
	`m¦“p
(10);

2557 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2558 ià(
QMI_MODIFY_PRO
 =ğ
»t
)

2560 
	`devdbg
(
g_cdc_dev
,"get QMI_MODIFY_PRO success.");

2562  
»t
;

2566 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2567 
»t
 = -2;

2570 
QMI_SET_INSTANCE
:

2571 
šdex
++ < 10)

2573 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2574 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2575 
»ad_»¥
, 
»¥_Ën
, 1000);

2576 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2577 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2578 ià(
»t
 <= 0)

2581 
	`m¦“p
(10);

2584 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2585 ià(
QMI_SET_INSTANCE
 =ğ
»t
)

2587 
	`devdbg
(
g_cdc_dev
,"get Set Instance„esponse success.");

2589  
»t
;

2593 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2594 
»t
 = -2;

2596 
QMI_GET_VERSION
:

2597 
šdex
++ < 10)

2600 
»t
 = 
	`usb_cÚŒŞ_msg
(
udev
, 
	`usb_rcvù¾pe
(udev, 0), 0x01,

2601 0xA1, 0x00, 
štf
->
cur_®t£‰šg
->
desc
.
bIÁ”çûNumb”
,

2602 
»ad_»¥
, 
»¥_Ën
, 1000);

2603 
	`devdbg
(
g_cdc_dev
,"get qmi„esponse:");

2604 
	`´štk_hex
(
»ad_»¥
,
»¥_Ën
);

2605 ià(
»t
 <= 0)

2608 
	`m¦“p
(10);

2611 
»t
 = 
	`´oûssQMIRe¥Ú£
((*)
»ad_»¥
,&
ndis_¡©us
);

2612 ià(
QMI_GET_VERSION
 =ğ
»t
)

2614 
	`devdbg
(
g_cdc_dev
,"g‘ qm˜v”siÚ sucûss.v”siÚ:%s.",
ndis_¡©us
.
fV”siÚ
);

2616  
»t
;

2620 
	`devdbg
(
g_cdc_dev
,"%s: G‘„e¥Ú£imeout.", 
__func__
);

2621 
»t
 = -2;

2624 
	`devdbg
(
g_cdc_dev
,"unknown qmi„equestype:");

2629  
»t
;

2630 
	}
}

2632 
__ex™
 
	$lc_cdc_ex™
()

2634 
	`usb_d”egi¡”
(&
lc_‘h”_driv”
);

2635 
	}
}

2636 
moduË_ex™
(
lc_cdc_ex™
);

2639 
MODULE_AUTHOR
(
DRIVER_AUTHOR
);

2640 
MODULE_DESCRIPTION
(
DRIVER_DESC
);

2641 
MODULE_VERSION
(
DRIVER_VERSION
);

2642 
MODULE_LICENSE
("GPL");

	@driver/ndis/src/qmi_header.h

22 #iâdeà
__QMI_HEADER_H__


23 
	#__QMI_HEADER_H__


	)

24 
	~<lšux/ùy³.h
>

26 
	tUIÁ16
;

27 
	tUIÁ8
;

28 
	tUIÁ32
;

29 
	tUIÁ64
;

31 
	#LDEBUG
 0

32 
	#USE_ELG
 0

33 
	#USE_IOL
 0

34 
	#LOG_DATA
 0

35 
	#DUMPALL
 0

36 

	)

37 
	#SË•_Time
 20

	)

41 
	mkD©aIn
 = 0,

42 
	mkD©aOut
,

43 
	mkD©aOth”
,

44 
	mkD©aNÚe


51 
	mkRe£tNÜm®
 = 0,

52 
	mkRe£tN“ded
,

53 
	mkRe£tDÚe


57 
	mIPv4
 = 0,

58 
	mIPv6
,

59 
	mIPv4v6


64 
	mLC_DISCONNECTED
 = 0,

65 
	mLC_CONNECTING
,

66 
	mLC_GETTING_IP
,

67 
	mLC_IP_GETTED
,

68 
	mLC_CONNECTED
 = 
LC_IP_GETTED
,

69 
	mLC_DISCONNECTING
,

72 
	s_QCQMI_HDR


74 
UIÁ8
 
	mIFTy³
;

75 
UIÁ16
 
	mL’gth
;

76 
UIÁ8
 
	mCFÏgs
;

77 
UIÁ8
 
	mQMITy³
;

78 
UIÁ8
 
	mCl›ÁId
;

79 }
	t__©Œibu‹__
((
	t·cked
)è
	tQCQMI_HDR
 ;

81 
	s_QCQMI


83 
UIÁ8
 
	mIFTy³
;

84 
UIÁ16
 
	mL’gth
;

85 
UIÁ8
 
	mCFÏgs
;

86 
UIÁ8
 
	mQMITy³
;

87 
UIÁ8
 
	mCl›ÁId
;

88 
UIÁ8
 
	mSDU
;

89 }
	t__©Œibu‹__
((
	t·cked
)è
	tQCQMI
 ;

91 
	s_QCQMUX_HDR


93 
UIÁ8
 
	mCFÏgs
;

94 
UIÁ16
 
	mT¿n§ùiÚId
;

95 }
	t__©Œibu‹__
((
	t·cked
)è
	tQCQMUX_HDR
 ;

97 
	s_QCQMUX


99 
UIÁ8
 
	mCFÏgs
;

100 
UIÁ16
 
	mT¿n§ùiÚId
;

101 
UIÁ8
 
	mMes§ge
;

102 }
	t__©Œibu‹__
((
	t·cked
)è
	tQCQMUX
;

104 
	s_QCQMUX_MSG_HDR


106 
UIÁ16
 
	mTy³
;

107 
UIÁ16
 
	mL’gth
;

108 }
	t__©Œibu‹__
((
	t·cked
)è
	tQCQMUX_MSG_HDR
, *
	tPQCQMUX_MSG_HDR
;

110 
	s_QCQMICTL_MSG_HDR


112 
UIÁ8
 
	mCFÏg
;

113 
UIÁ8
 
	mT¿n§ùiÚId
;

114 
UIÁ16
 
	mQMICTLTy³
;

115 
UIÁ16
 
	mL’gth
;

116 }
	t__©Œibu‹__
((
	t·cked
)è
	tQCQMICTL_MSG_HDR
;

118 
	#QMUX_BROADCAST_CID
 0xFF

	)

122 
	mQMUX_TYPE_CTL
 = 0x00,

123 
	mQMUX_TYPE_WDS
 = 0x01,

124 
	mQMUX_TYPE_DMS
 = 0x02,

125 
	mQMUX_TYPE_NAS
 = 0x03,

126 
	mQMUX_TYPE_QOS
 = 0x04,

127 
	mQMUX_TYPE_MAX
,

128 
	mQMUX_TYPE_ALL
 = 0xFF

132 
	#QCQMI_CTL_FLAG_SERVICE
 0x80

	)

133 
	#USB_CTL_MSG_TYPE_QMI
 0x01

	)

136 
	#QMICTL_CTL_FLAG_CMD
 0x00

	)

137 
	#QMICTL_CTL_FLAG_RSP
 0x01

	)

138 
	#QMICTL_CTL_FLAG_IND
 0x02

	)

140 
	#QMICTL_SET_INSTANCE_ID_REQ
 0x0020

	)

141 
	#QMICTL_SET_INSTANCE_ID_RESP
 0x0020

	)

142 
	#QMICTL_GET_CLIENT_ID_REQ
 0x0022

	)

143 
	#QMICTL_GET_CLIENT_ID_RESP
 0x0022

	)

144 
	#QMICTL_RELEASE_CLIENT_ID_REQ
 0x0023

	)

145 
	#QMICTL_RELEASE_CLIENT_ID_RESP
 0x0023

	)

146 
	#QMICTL_REVOKE_CLIENT_IDIND
 0x0024

	)

147 
	#QMICTL_INVALID_CLIENT_ID_IND
 0x0025

	)

148 
	#QMICTL_GET_VERSION_REQ
 0x0021

	)

149 
	#QMICTL_GET_VERSION_RESP
 0x0021

	)

150 
	#QMICTL_SET_DATA_FORMAT_REQ
 0x0026

	)

151 
	#QMICTL_SET_DATA_FORMAT_RESP
 0x0026

	)

156 
	#QMI_WDS_MODIFY_PROFILE_SETTINGS_REQ
 0x0028

	)

157 
	#QMI_WDS_MODIFY_PROFILE_SETTINGS_RESP
 0x0028

	)

158 
	#QMIWDS_START_NETWORK_INTERFACE_REQ
 0x0020

	)

159 
	#QMIWDS_START_NETWORK_INTERFACE_RESP
 0x0020

	)

160 
	#QMIWDS_STOP_NETWORK_INTERFACE_REQ
 0x0021

	)

161 
	#QMIWDS_STOP_NETWORK_INTERFACE_RESP
 0x0021

	)

162 
	#QMIWDS_GET_RUNTIME_SETTINGS_REQ
 0x002D

	)

163 
	#QMIWDS_GET_RUNTIME_SETTINGS_RESP
 0x002D

	)

166 
	#QMIWDS_GET_PKT_SRVC_STATUS_IND
 0x0022

	)

169 
	#QMICTL_CTL_FLAG_REQUEST
 0x00

	)

171 
	#QMI_RESULT_SUCCESS
 0x0000

	)

172 
	#QMI_RESULT_FAILURE
 0x0001

	)

174 
	#QMUX_CTL_FLAG_SINGLE_MSG
 0x00

	)

175 
	#QMUX_CTL_FLAG_TYPE_CMD
 0x00

	)

176 
	#QMUX_CTL_FLAG_MASK_TYPE
 0x06

	)

177 
	#QMUX_CTL_FLAG_MASK_COMPOUND
 0x01

	)

178 
	#QMUX_CTL_FLAG_TYPE_RSP
 0x02

	)

179 
	#QMUX_CTL_FLAG_TYPE_IND
 0x04

	)

181 
	s_QMICTL_GET_CLIENT_ID_REQ_MSG


183 
UIÁ8
 
	mCFÏgs
;

184 
UIÁ8
 
	mT¿n§ùiÚId
;

185 
UIÁ16
 
	mQMICTLTy³
;

186 
UIÁ16
 
	mL’gth
;

187 
UIÁ8
 
	mTLVTy³
;

188 
UIÁ16
 
	mTLVL’gth
;

189 
UIÁ8
 
	mQMITy³
;

190 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_GET_CLIENT_ID_REQ_MSG
;

192 
	s_QMICTL_GET_CLIENT_ID_RESP_MSG


194 
UIÁ8
 
	mCFÏgs
;

195 
UIÁ8
 
	mT¿n§ùiÚId
;

196 
UIÁ16
 
	mQMICTLTy³
;

197 
UIÁ16
 
	mL’gth
;

198 
UIÁ8
 
	mTLVTy³
;

199 
UIÁ16
 
	mTLVL’gth
;

200 
UIÁ16
 
	mQMIResuÉ
;

201 
UIÁ16
 
	mQMIE¼Ü
;

202 
UIÁ8
 
	mTLV2Ty³
;

203 
UIÁ16
 
	mTLV2L’gth
;

204 
UIÁ8
 
	mQMITy³
;

205 
UIÁ8
 
	mCl›ÁId
;

206 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_GET_CLIENT_ID_RESP_MSG
;

208 
	s_QMICTL_RELEASE_CLIENT_ID_REQ_MSG


210 
UIÁ8
 
	mCFÏgs
;

211 
UIÁ8
 
	mT¿n§ùiÚId
;

212 
UIÁ16
 
	mQMICTLTy³
;

213 
UIÁ16
 
	mL’gth
;

214 
UIÁ8
 
	mTLVTy³
;

215 
UIÁ16
 
	mTLVL’gth
;

216 
UIÁ8
 
	mQMITy³
;

217 
UIÁ8
 
	mCl›ÁId
;

218 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_RELEASE_CLIENT_ID_REQ_MSG
;

220 
	s_QMICTL_RELEASE_CLIENT_ID_RESP_MSG


222 
UIÁ8
 
	mCFÏgs
;

223 
UIÁ8
 
	mT¿n§ùiÚId
;

224 
UIÁ16
 
	mQMICTLTy³
;

225 
UIÁ16
 
	mL’gth
;

226 
UIÁ8
 
	mTLVTy³
;

227 
UIÁ16
 
	mTLVL’gth
;

228 
UIÁ16
 
	mQMIResuÉ
;

229 
UIÁ16
 
	mQMIE¼Ü
;

230 
UIÁ8
 
	mTLV2Ty³
;

231 
UIÁ16
 
	mTLV2L’gth
;

232 
UIÁ8
 
	mQMITy³
;

233 
UIÁ8
 
	mCl›ÁId
;

234 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_RELEASE_CLIENT_ID_RESP_MSG
;

236 
	s_QMICTL_GET_VERSION_REQ_MSG


238 
UIÁ8
 
	mCFÏgs
;

239 
UIÁ8
 
	mT¿n§ùiÚId
;

240 
UIÁ16
 
	mQMICTLTy³
;

241 
UIÁ16
 
	mL’gth
;

242 
UIÁ8
 
	mTLVTy³
;

243 
UIÁ16
 
	mTLVL’gth
;

244 
UIÁ8
 
	mQMITy³
;

245 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_GET_VERSION_REQ_MSG
;

247 
	s_QMUX_TYPE_VERSION_STRUCT


249 
UIÁ8
 
	mQMUXTy³
;

250 
UIÁ16
 
	mMajÜV”siÚ
;

251 
UIÁ16
 
	mMšÜV”siÚ
;

252 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMUX_TYPE_VERSION_STRUCT
;

254 
	s_QMICTL_GET_VERSION_RESP_MSG


256 
UIÁ8
 
	mCFÏgs
;

257 
UIÁ8
 
	mT¿n§ùiÚId
;

258 
UIÁ16
 
	mQMICTLTy³
;

259 
UIÁ16
 
	mL’gth
;

260 
UIÁ8
 
	mTLVTy³
;

261 
UIÁ16
 
	mTLVL’gth
;

262 
UIÁ16
 
	mQMIResuÉ
;

263 
UIÁ16
 
	mQMIE¼Ü
;

264 
UIÁ8
 
	mTLV2Ty³
;

265 
UIÁ16
 
	mTLV2L’gth
;

266 
UIÁ8
 
	mNumEËm’ts
;

267 
QMUX_TYPE_VERSION_STRUCT
 
	mTy³V”siÚ
;

268 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_GET_VERSION_RESP_MSG
;

270 
	s_QMI_TLV_HDR


272 
UIÁ8
 
	mTLVTy³
;

273 
UIÁ16
 
	mTLVL’gth
;

274 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMI_TLV_HDR
;

277 
	s_QMICTL_SET_DATA_FORMAT_TLV_LINK_PROT


279 
UIÁ8
 
	mTLVTy³
;

280 
UIÁ16
 
	mTLVL’gth
;

281 
UIÁ16
 
	mLškPrÙ
;

282 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_SET_DATA_FORMAT_TLV_LINK_PROT
;

284 
	s_QMICTL_SET_DATA_FORMAT_REQ_MSG


286 
UIÁ8
 
	mCFÏgs
;

287 
UIÁ8
 
	mT¿n§ùiÚId
;

288 
UIÁ16
 
	mQMICTLTy³
;

289 
UIÁ16
 
	mL’gth
;

290 
UIÁ8
 
	mTLVTy³
;

291 
UIÁ16
 
	mTLVL’gth
;

292 
UIÁ8
 
	mD©aFÜm©
;

293 
QMICTL_SET_DATA_FORMAT_TLV_LINK_PROT
 
	mPrÙo
;

294 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_SET_DATA_FORMAT_REQ_MSG
;

296 
	s_QMICTL_SET_DATA_FORMAT_RESP_MSG


298 
UIÁ8
 
	mCFÏgs
;

299 
UIÁ8
 
	mT¿n§ùiÚId
;

300 
UIÁ16
 
	mQMICTLTy³
;

301 
UIÁ16
 
	mL’gth
;

302 
UIÁ8
 
	mTLVTy³
;

303 
UIÁ16
 
	mTLVL’gth
;

304 
UIÁ16
 
	mQMIResuÉ
;

305 
UIÁ16
 
	mQMIE¼Ü
;

306 
QMICTL_SET_DATA_FORMAT_TLV_LINK_PROT
 
	mPrÙo
;

307 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_SET_DATA_FORMAT_RESP_MSG
;

309 
	s_QMICTL_SET_INSTANCE_ID_REQ_MSG


311 
UIÁ8
 
	mCFÏgs
;

312 
UIÁ8
 
	mT¿n§ùiÚId
;

313 
UIÁ16
 
	mQMICTLTy³
;

314 
UIÁ16
 
	mL’gth
;

315 
UIÁ8
 
	mTLVTy³
;

316 
UIÁ16
 
	mTLVL’gth
;

317 
UIÁ8
 
	mV®ue
;

318 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_SET_INSTANCE_ID_REQ_MSG
;

320 
	s_QMICTL_SET_INSTANCE_ID_RESP_MSG


322 
UIÁ8
 
	mCFÏgs
;

323 
UIÁ8
 
	mT¿n§ùiÚId
;

324 
UIÁ16
 
	mQMICTLTy³
;

325 
UIÁ16
 
	mL’gth
;

326 
UIÁ8
 
	mTLVTy³
;

327 
UIÁ16
 
	mTLVL’gth
;

328 
UIÁ16
 
	mQMIResuÉ
;

329 
UIÁ16
 
	mQMIE¼Ü
;

330 
UIÁ8
 
	mTLV2Ty³
;

331 
UIÁ16
 
	mTLV2L’gth
;

332 
UIÁ16
 
	mQMI_ID
;

333 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMICTL_SET_INSTANCE_ID_RESP_MSG
;

336 
	#QCTLV_TYPE_REQUIRED_PARAMETER
 0x01

	)

337 
	#QMICTL_GETVERSION_RSP_TLV_TYPE_ADD_VERSION
 0x10

	)

339 
	#SET_DATA_FORMAT_TLV_TYPE_LINK_PROTO
 0x10

	)

340 
	#SET_DATA_FORMAT_LINK_PROTO_ETH
 0x0001

	)

341 
	#SET_DATA_FORMAT_LINK_PROTO_IP
 0x0002

	)

343 
	#MP_INVALID_QMI_ID
 0xF0000000

	)

345 
	#QCTLV_TYPE_APN
 0x14

	)

346 
	#QCTLV_TYPE_AUTH_TYPE
 0x16

	)

347 
	#QCTLV_TYPE_USER_NAME
 0x17

	)

348 
	#QCTLV_TYPE_PASSWORD
 0x18

	)

350 
	s_QMIWDS_RESP_MSG_HEADER


352 
UIÁ16
 
	mTy³
;

353 
UIÁ16
 
	mL’gth
;

354 
UIÁ8
 
	mTLVTy³
;

355 
UIÁ16
 
	mTLVL’gth
;

356 
UIÁ16
 
	mQMUXResuÉ
;

357 
UIÁ16
 
	mQMUXE¼Ü
;

358 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_RESP_MSG_HEADER
, *
	tPQMIWDS_RESP_MSG_HEADER
;

360 
	s_QMIWDS_START_NETWORK_INTERFACE_RESP_MSG


362 
UIÁ16
 
	mTy³
;

363 
UIÁ16
 
	mL’gth
;

364 
UIÁ8
 
	mTLVTy³
;

365 
UIÁ16
 
	mTLVL’gth
;

366 
UIÁ16
 
	mQMUXResuÉ
;

367 
UIÁ16
 
	mQMUXE¼Ü
;

368 
UIÁ8
 
	mTLVTy³2
;

369 
UIÁ16
 
	mTLVL’gth2
;

370 
UIÁ32
 
	mPkt_D©a_HªdË
;

371 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_START_NETWORK_INTERFACE_RESP_MSG
;

373 
	s_QMIWDS_GET_PKT_SRVC_STATUS_IND_MSG


375 
UIÁ16
 
	mTy³
;

376 
UIÁ16
 
	mL’gth
;

377 
UIÁ8
 
	mTLVTy³
;

378 
UIÁ16
 
	mTLVL’gth
;

379 
UIÁ8
 
	mCÚÃùiÚStus
;

380 
UIÁ8
 
	mRecÚfigRequœed
;

381 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_GET_PKT_SRVC_STATUS_IND_MSG
;

383 
	s_QMIWDS_STOP_NETWORK_INTERFACE_REQ_MSG


385 
UIÁ16
 
	mTy³
;

386 
UIÁ16
 
	mL’gth
;

387 
UIÁ8
 
	mTLVTy³
;

388 
UIÁ16
 
	mTLVL’gth
;

389 
UIÁ32
 
	mPack‘_HªdË
;

390 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_STOP_NETWORK_INTERFACE_REQ_MSG
;

392 
	s_QMIWDS_GET_RUNTIME_SETTINGS_REQ_MSG


394 
UIÁ16
 
	mTy³
;

395 
UIÁ16
 
	mL’gth
;

396 
UIÁ8
 
	mTLVTy³
;

397 
UIÁ16
 
	mTLVL’gth
;

398 
UIÁ32
 
	mMask
;

399 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_GET_RUNTIME_SETTINGS_REQ_MSG
;

401 
	s_QMIWDS_GET_RUNTIME_SETTINGS_TLV_IPV4_ADDR


403 
UIÁ8
 
	mTLVTy³
;

404 
UIÁ16
 
	mTLVL’gth
;

405 
UIÁ32
 
	mIPV4Add»ss
;

406 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_GET_RUNTIME_SETTINGS_TLV_IPV4_ADDR
;

408 
	s_QMIWDS_GET_RUNTIME_SETTINGS_RESP_MSG


410 
UIÁ16
 
	mTy³
;

411 
UIÁ16
 
	mL’gth
;

412 
UIÁ8
 
	mTLVTy³
;

413 
UIÁ16
 
	mTLVL’gth
;

414 
UIÁ16
 
	mQMUXResuÉ
;

415 
UIÁ16
 
	mQMUXE¼Ü
;

416 }
	t__©Œibu‹__
((
	t·cked
)è
	tQMIWDS_GET_RUNTIME_SETTINGS_RESP_MSG
;

418 
	#QMIWDS_GET_RUNTIME_SETTINGS_TLV_TYPE_IPV4
 0x1E

	)

419 
	#QMIWDS_GET_RUNTIME_SETTINGS_TLV_TYPE_IPV6
 0x25

	)

421 
	#QMIWDS_GET_RUNTIME_SETTINGS_MASK_IPV4_ADDR
 0x0100

	)

425 
	#QMI_ERR_CALL_FAILED
 0x0E

	)

426 
	#QMI_ERR_AUTHENTICATION_FAILED
 0x22

	)

427 
	#QMI_ERR_NO_NETWORK_FOUND
 0x0D

	)

428 
	#QMI_ERR_IP_FAILED
 0xFF01

	)

432 
	#ETH_TYPE_ARP
 0x0806

	)

433 
	#ETH_TYPE_IPV4
 0x0800

	)

434 
	#ETH_TYPE_IPV6
 0x86DD

	)

436 
	#ETH_LENGTH_OF_ADDRESS
 6

	)

438 
	s_QC_ETH_HDR


440 
UIÁ8
 
	mD¡MacAdd»ss
[
ETH_LENGTH_OF_ADDRESS
];

441 
UIÁ8
 
	mSrcMacAdd»ss
[
ETH_LENGTH_OF_ADDRESS
];

442 
UIÁ16
 
	mEth”Ty³
;

443 }
	t__©Œibu‹__
((
	t·cked
)è
	tQC_ETH_HDR
;

445 
	s_QC_ARP_HDR


447 
UIÁ16
 
	mH¬dw¬eTy³
;

448 
UIÁ16
 
	mPrÙocŞTy³
;

449 
UIÁ8
 
	mHLEN
;

450 
UIÁ8
 
	mPLEN
;

451 
UIÁ16
 
	mO³¿tiÚ
;

452 
UIÁ8
 
	mS’d”HA
[
ETH_LENGTH_OF_ADDRESS
];

453 
UIÁ32
 
	mS’d”IP
;

454 
UIÁ8
 
	mT¬g‘HA
[
ETH_LENGTH_OF_ADDRESS
];

455 
UIÁ32
 
	mT¬g‘IP
;

456 }
	t__©Œibu‹__
((
	t·cked
)è
	tQC_ARP_HDR
;

458 
	#kUSBModem_O³r_FÏg
 "ModemO³r"

	)

459 
	#kUSBModem_CÚÃù_APN
 "APN"

	)

460 
	#kUSBModem_CÚÃù_U£rName
 "U£rName"

	)

461 
	#kUSBModem_CÚÃù_PasswÜd
 "PassWÜd"

	)

462 
	#kUSBModem_CÚÃù_Com´essiÚ
 "Com´essiÚ"

	)

463 
	#kUSBModem_CÚÃù_E¼Ü
 "ModemCÚÃùiÚE¼Ü"

	)

465 
	#QWDS_PKT_DATA_DISCONNECTED
 0x01

	)

466 
	#QWDS_PKT_DATA_CONNECTED
 0x02

	)

467 
	#QWDS_PKT_DATA_SUSPENDED
 0x03

	)

471 
	mWwªAuthPrÙocŞNÚe
 = 0x00,

472 
	mWwªAuthPrÙocŞP­
 = 0x01,

473 
	mWwªAuthPrÙocŞCh­
 = 0x02,

474 
	mWwªAuthPrÙocŞMax
 = 0xFF

479 
	mWwªO³¿tiÚQu”yR—dy
 = 0x00,

480 
	mWwªO³¿tiÚCÚÃù
 = 0x01,

481 
	mWwªO³¿tiÚDiscÚÃù
 = 0x02,

482 
	mWwªO³¿tiÚS‹
 = 0x03,

483 
	mWwªO³¿tiÚCouÁ
 = 0x04,

484 
	mWwªO³¿tiÚMax
 = 0xFF

489 
	mWwªS‹DiscÚÃùed
 = 0,

490 
	mWwªS‹CÚÃùšg
 = 1,

491 
	mWwªS‹CÚÃùed
 = 2,

492 
	mWwªS‹DiscÚÃùšg
 = 3

495 
	#WWAN_STRING_LEN
 64

	)

500 
	mAcûssSŒšg
[
WWAN_STRING_LEN
];

501 
	mU£rName
[
WWAN_STRING_LEN
];

502 
	mPasswÜd
[
WWAN_STRING_LEN
];

503 
UIÁ32
 
	mComm´essiÚ
;

504 
UIÁ32
 
	mCÚÃùIpMode
;

505 }
	t__©Œibu‹__
((
	t·cked
)è
	tWWAN_CONNECT_PARAMS
;

507 
	s_WWAN_FLOW_STATS


509 
UIÁ32
 
	mCÚÃùS‹
;

510 
UIÁ64
 
	mUpLškBy‹s
;

511 
UIÁ64
 
	mDownLškBy‹s
;

512 }
	t__©Œibu‹__
((
	t·cked
)è
	tWWAN_FLOW_STATS
;

	@driver/ndis/src/qmi_oper.c

21 
	~<lšux/moduË.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/ùy³.h
>

24 
	~<lšux/k”Ãl.h
>

25 
	~"qmi_İ”.h
"

26 
	~"qmi_h—d”.h
"

27 
	#bz”o
(
b
,
Ën
è
	`mem£t
((b),0,Ö’))

	)

29 
UIÁ8
 
	gfQMIT¿n§ùiÚId
 = 0;

31 #ifdeà
DEBUG


32 
	#lc_kdbg
(
fmt
, 
¬g
...èdo{ \

	)

33 
´štk
(
KERN_ERR
 "######: " 
fmt
 , ## 
¬g
); \

36 
	#lc_kdbg
(
fmt
, 
¬g
...èdo{ \

	)

37 
	}

	$}whe
(0)

48 
	$´štk_hex
(
UIÁ8
 *
buf
,
buf_size
)

50 #ifdeà
HEX_DEBUG


51 
i
,
j
;

52 
tÙ®_size
 = 0;

53 
lše_cout
 = 
buf_size
>>4;

54 if((
buf_size
&0x0000000f)!=0)

55 
lše_cout
++;

57 
i
=0;i<
lše_cout
;i++)

59 
	`´štk
("\n%d:",
tÙ®_size
);

60 
j
=0;j<16;j++)

62 
tÙ®_size
++;

63 
	`´štk
("%02X ",
buf
[(
i
<<4)+
j
]);

64 if(((
i
<<4)+1+
j
)==
buf_size
)

66 
	`´štk
("\n");

72 
	}
}

84 
	$QCTL_G‘Cl›ÁID
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,UIÁ8 
qmiTy³
)

86 
UIÁ16
 
msgL’gth
;

88 
QCQMI
* 
qmi
 = 
NULL
;

89 
QMICTL_GET_CLIENT_ID_REQ_MSG
* 
pReq
 = 
NULL
;

91 
	`lc_kdbg
("QCTL_GetClientID :ƒntry\n");

93 
msgL’gth
 = (
QCQMI_HDR
è+ (
QMICTL_GET_CLIENT_ID_REQ_MSG
);

94 
	`lc_kdbg
("%s:msgL’gth=%d,%d,%d\n",
__func__
, 
msgL’gth
,(
QCQMI_HDR
),(
QMICTL_GET_CLIENT_ID_REQ_MSG
) );

96 if(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

98 
	`lc_kdbg
("QCTL_G‘Cl›ÁID :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
msgL’gth
,
Ëngth
);

102 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

104 
qmi
 = (
QCQMI
*)
pMsgBuff
;

105 
pReq
 = (
QMICTL_GET_CLIENT_ID_REQ_MSG
*)&(
qmi
->
SDU
);

107 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

108 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

109 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

110 
qmi
->
QMITy³
 = 
QMUX_TYPE_CTL
;

111 
qmi
->
Cl›ÁId
 = 0x00;

113 
pReq
->
CFÏgs
 = 
QMICTL_CTL_FLAG_REQUEST
;

114 ++
fQMIT¿n§ùiÚId
;

115 
pReq
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

116 
pReq
->
QMICTLTy³
 = 
QMICTL_GET_CLIENT_ID_REQ
;

117 
pReq
->
L’gth
 = (
QMICTL_GET_CLIENT_ID_REQ_MSG
è- (
QCQMICTL_MSG_HDR
);

118 
pReq
->
TLVTy³
 = 
QCTLV_TYPE_REQUIRED_PARAMETER
;

119 
pReq
->
TLVL’gth
 = 1;

120 
pReq
->
QMITy³
 = 
qmiTy³
;

123 
	`lc_kdbg
("% :†—ve\n",
__func__
);

124  
msgL’gth
;

125 
	}
}

137 
	$QCTL_R–—£Cl›ÁID
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

139 
UIÁ16
 
msgL’gth
;

141 
QCQMI
* 
qmi
 = 
NULL
;

142 
QMICTL_RELEASE_CLIENT_ID_REQ_MSG
* 
pReq
 = 
NULL
;

144 
	`lc_kdbg
("QCTL_ReleaseClientID :ƒntry\n");

145 
msgL’gth
 = (
QCQMI_HDR
è+ (
QMICTL_RELEASE_CLIENT_ID_REQ_MSG
);

147 if(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

149 
	`lc_kdbg
("QCTL_R–—£Cl›ÁID :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
msgL’gth
,
Ëngth
);

152 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

154 
qmi
 = (
QCQMI
*)
pMsgBuff
;

155 
pReq
 = (
QMICTL_RELEASE_CLIENT_ID_REQ_MSG
*)&(
qmi
->
SDU
);

157 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

158 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

159 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

160 
qmi
->
QMITy³
 = 
QMUX_TYPE_CTL
;

161 
qmi
->
Cl›ÁId
 = 0x00;

163 
pReq
->
CFÏgs
 = 
QMICTL_CTL_FLAG_REQUEST
;

164 ++
fQMIT¿n§ùiÚId
;

165 
pReq
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

166 
pReq
->
QMICTLTy³
 = 
QMICTL_RELEASE_CLIENT_ID_REQ
;

167 
pReq
->
L’gth
 = (
QMICTL_RELEASE_CLIENT_ID_REQ_MSG
è- (
QCQMICTL_MSG_HDR
);

168 
pReq
->
TLVTy³
 = 
QCTLV_TYPE_REQUIRED_PARAMETER
;

169 
pReq
->
TLVL’gth
 = 2;

170 
pReq
->
QMITy³
 = 
²dis_¡©us
->
fQMITy³
;

171 
pReq
->
Cl›ÁId
 = 
²dis_¡©us
->
fCl›ÁID
;

174 
	`lc_kdbg
("% :†—ve\n",
__func__
);

175  
msgL’gth
;

176 
	}
}

187 
	$QCTL_G‘V”siÚReq
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
)

189 
UIÁ16
 
msgL’gth
;

191 
QCQMI
* 
qmi
 = 
NULL
;

192 
QMICTL_GET_VERSION_REQ_MSG
* 
pReq
 = 
NULL
;

194 
	`lc_kdbg
("QCTL_GetVersionReq :ƒntry\n");

196 
msgL’gth
 = (
QCQMI_HDR
è+ (
QMICTL_GET_VERSION_REQ_MSG
);

198 ià(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

200 
	`lc_kdbg
("QCTL_G‘V”siÚReq :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
msgL’gth
,
Ëngth
);

204 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

206 
qmi
 = (
QCQMI
*)
pMsgBuff
;

207 
pReq
 = (
QMICTL_GET_VERSION_REQ_MSG
*)&(
qmi
->
SDU
);

209 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

210 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

211 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

212 
qmi
->
QMITy³
 = 
QMUX_TYPE_CTL
;

213 
qmi
->
Cl›ÁId
 = 0x00;

215 
pReq
->
CFÏgs
 = 
QMICTL_CTL_FLAG_REQUEST
;

216 ++
fQMIT¿n§ùiÚId
;

217 
pReq
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

218 
pReq
->
QMICTLTy³
 = 
QMICTL_GET_VERSION_REQ
;

219 
pReq
->
L’gth
 = (
QMICTL_GET_VERSION_REQ_MSG
è- (
QCQMICTL_MSG_HDR
);

220 
pReq
->
TLVTy³
 = 
QCTLV_TYPE_REQUIRED_PARAMETER
;

221 
pReq
->
TLVL’gth
 = 0x0001;

222 
pReq
->
QMITy³
 = 
QMUX_TYPE_ALL
;

225 
	`lc_kdbg
("% :†—ve\n",
__func__
);

226  
msgL’gth
;

227 
	}
}

238 
	$QCTL_S‘D©aFÜm©Req
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
)

240 
UIÁ16
 
msgL’gth
;

242 
QCQMI
* 
qmi
 = 
NULL
;

243 
QMICTL_SET_DATA_FORMAT_REQ_MSG
* 
pReq
 = 
NULL
;

245 
	`lc_kdbg
("QCTL_SetDataFormatReq :ƒntry\n");

247 
msgL’gth
 = (
QCQMI_HDR
è+ (
QMICTL_SET_DATA_FORMAT_REQ_MSG
);

251 ià(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

253 
	`lc_kdbg
("QCTL_S‘D©aFÜm©Req :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
msgL’gth
,
Ëngth
);

257 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

259 
qmi
 = (
QCQMI
*)
pMsgBuff
;

260 
pReq
 = (
QMICTL_SET_DATA_FORMAT_REQ_MSG
*)&(
qmi
->
SDU
);

262 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

263 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

264 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

265 
qmi
->
QMITy³
 = 
QMUX_TYPE_CTL
;

266 
qmi
->
Cl›ÁId
 = 0x00;

268 
pReq
->
CFÏgs
 = 
QMICTL_CTL_FLAG_REQUEST
;

269 ++
fQMIT¿n§ùiÚId
;

270 
pReq
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

271 
pReq
->
QMICTLTy³
 = 
QMICTL_SET_DATA_FORMAT_REQ
;

272 
pReq
->
L’gth
 = (
QMICTL_SET_DATA_FORMAT_REQ_MSG
è- (
QCQMICTL_MSG_HDR
);

273 
pReq
->
TLVTy³
 = 
QCTLV_TYPE_REQUIRED_PARAMETER
;

274 
pReq
->
TLVL’gth
 = 0x0001;

275 
pReq
->
D©aFÜm©
 = 0;

276 
pReq
->
PrÙo
.
TLVTy³
 = 
SET_DATA_FORMAT_TLV_TYPE_LINK_PROTO
;

277 
pReq
->
PrÙo
.
TLVL’gth
 = 0x0002;

278 
pReq
->
PrÙo
.
LškPrÙ
 = (
SET_DATA_FORMAT_LINK_PROTO_ETH
 | 
SET_DATA_FORMAT_LINK_PROTO_IP
);

281 
	`lc_kdbg
("% :†—ve\n",
__func__
);

282  
msgL’gth
;

283 
	}
}

294 
	$QCTL_S‘In¡ªûId
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
)

296 
UIÁ16
 
msgL’gth
;

298 
QCQMI
* 
qmi
 = 
NULL
;

299 
QMICTL_SET_INSTANCE_ID_REQ_MSG
* 
pS‘
 = 
NULL
;

302 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

304 
msgL’gth
 = (
QCQMI_HDR
è+ (
QMICTL_SET_INSTANCE_ID_REQ_MSG
);

307 ià(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

309 
	`lc_kdbg
("% :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
__func__
,
msgL’gth
,
Ëngth
);

313 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

315 
qmi
 = (
QCQMI
*)
pMsgBuff
;

316 
pS‘
 = (
QMICTL_SET_INSTANCE_ID_REQ_MSG
*)&(
qmi
->
SDU
);

318 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

319 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

320 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

321 
qmi
->
QMITy³
 = 
QMUX_TYPE_CTL
;

322 
qmi
->
Cl›ÁId
 = 0x00;

324 
pS‘
->
CFÏgs
 = 
QMICTL_CTL_FLAG_REQUEST
;

325 ++
fQMIT¿n§ùiÚId
;

326 
pS‘
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

327 
pS‘
->
QMICTLTy³
 = 
QMICTL_SET_INSTANCE_ID_REQ
;

328 
pS‘
->
L’gth
 = (
QMICTL_SET_INSTANCE_ID_REQ_MSG
è- (
QCQMICTL_MSG_HDR
);

329 
pS‘
->
TLVTy³
 = 
QCTLV_TYPE_REQUIRED_PARAMETER
;

330 
pS‘
->
TLVL’gth
 = 1;

331 
pS‘
->
V®ue
 = 1;

333 
	`lc_kdbg
("% :†—ve\n",
__func__
);

335  
msgL’gth
;

336 
	}
}

348 
	$QC_WDS_G‘IPAdd»ss
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,UIÁ8 
fCl›ÁID
)

350 
UIÁ16
 
msgL’gth
;

351 
QCQMI
* 
qmi
 = 
NULL
;

352 
QCQMUX
* 
pQCQMUX
 = 
NULL
;

353 
QMIWDS_GET_RUNTIME_SETTINGS_REQ_MSG
* 
pG‘Msg
 = 
NULL
;

355 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

356 
msgL’gth
 = (
QCQMI_HDR
è+ (
QCQMUX_HDR
è+ (
QMIWDS_GET_RUNTIME_SETTINGS_REQ_MSG
);

357 ià(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

359 
	`lc_kdbg
("% :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
__func__
,
msgL’gth
,
Ëngth
);

362 
qmi
 = (
QCQMI
*)
pMsgBuff
;

363 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

365 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

366 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

367 
qmi
->
QMITy³
 = 
QMUX_TYPE_WDS
;

368 
qmi
->
Cl›ÁId
 = 
fCl›ÁID
;

369 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

371 
pQCQMUX
 = (
QCQMUX
*)&(
qmi
->
SDU
);

373 
pQCQMUX
->
CFÏgs
 = 
QMUX_CTL_FLAG_SINGLE_MSG
 | 
QMUX_CTL_FLAG_TYPE_CMD
;

374 ++
fQMIT¿n§ùiÚId
;

375 
pQCQMUX
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

377 
pG‘Msg
 = (
QMIWDS_GET_RUNTIME_SETTINGS_REQ_MSG
*)&(
pQCQMUX
->
Mes§ge
);

378 
pG‘Msg
->
Ty³
 = 
QMIWDS_GET_RUNTIME_SETTINGS_REQ
;

379 
pG‘Msg
->
L’gth
 = (
QMIWDS_GET_RUNTIME_SETTINGS_REQ_MSG
è- (
QCQMUX_MSG_HDR
);

380 
pG‘Msg
->
TLVTy³
 = 0x10;

381 
pG‘Msg
->
TLVL’gth
 = 0x04;

382 
pG‘Msg
->
Mask
 = 
QMIWDS_GET_RUNTIME_SETTINGS_MASK_IPV4_ADDR
;

384 
	`lc_kdbg
("% :†—ve\n",
__func__
);

386  
msgL’gth
;

387 
	}
}

404 
	$QC_WDS_ModifyProfe
(
UIÁ8
* 
pMsgBuff
,

405 
UIÁ32
 
Ëngth
,

406 
NDIS_QMI_STATUS
* 
²dis_¡©us
,

407 *
acûssSŒšg
,

408 *
u£rName
,

409 *
·ssWÜd
,

410 
UIÁ8
 
com´essiÚ
,

411 
UIÁ32
 
CÚÃùIpMode
)

413 
UIÁ16
 
msgL’gth
;

414 
QCQMI
* 
qmi
 = 
NULL
;

415 
UIÁ8
 *
pMsg
 = 
NULL
;

416 
QCQMUX
* 
pQCQMUX
 = 
NULL
;

417 
QCQMUX_MSG_HDR
* 
qmuxMsg
 = 
NULL
;

421 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

422 
qmi
 = (
QCQMI
*)
pMsgBuff
;

424 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

426 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

427 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

428 
qmi
->
QMITy³
 = 
QMUX_TYPE_WDS
;

429 
qmi
->
Cl›ÁId
 = 
²dis_¡©us
->
fCl›ÁID
;

431 
msgL’gth
 = (
QCQMI_HDR
);

432 
pMsg
 = (
UIÁ8
 *)
pMsgBuff
;

434 
pMsg
 +ğ
msgL’gth
;

436 
pQCQMUX
 = (
QCQMUX
*)&(
qmi
->
SDU
);

440 
pQCQMUX
->
CFÏgs
 = 
QMUX_CTL_FLAG_SINGLE_MSG
 | 
QMUX_CTL_FLAG_TYPE_CMD
;

441 ++
fQMIT¿n§ùiÚId
;

442 
pQCQMUX
->
T¿n§ùiÚId
 = 
	`ıu_to_Ë16
(
fQMIT¿n§ùiÚId
);

449 
qmuxMsg
 = (
QCQMUX_MSG_HDR
*)&(
pQCQMUX
->
Mes§ge
);

450 
qmuxMsg
->
Ty³
 = 
	`ıu_to_Ë16
(
QMI_WDS_MODIFY_PROFILE_SETTINGS_REQ
);

452 
pMsg
 = (
UIÁ8
 *)&(
qmuxMsg
->
L’gth
);

454 
pMsg
 +ğ(
qmuxMsg
->
L’gth
);

459 *
pMsg
 = 
QCTLV_TYPE_APN
;

460 ++
pMsg
;

462 *(
UIÁ16
 *)
pMsg
 = 
	`ıu_to_Ë16
(
	`¡¾’
(
acûssSŒšg
));

463 
pMsg
 +ğ(
UIÁ16
);

465 
	`¡rıy
((*)
pMsg
, 
acûssSŒšg
);

467 
pMsg
 +ğ
	`¡¾’
(
acûssSŒšg
);

471 
com´essiÚ
)

473 
WwªAuthPrÙocŞNÚe
:

478 
WwªAuthPrÙocŞP­
:

480 *
pMsg
 = 0x1d;

481 ++
pMsg
;

482 *(
UIÁ16
 *)
pMsg
 = 1;

483 
pMsg
 +ğ(
UIÁ16
);

484 *
pMsg
 = 1;

485 ++
pMsg
;

489 
WwªAuthPrÙocŞCh­
:

490 
WwªAuthPrÙocŞMax
:

492 *
pMsg
 = 0x1d;

493 ++
pMsg
;

494 *(
UIÁ16
 *)
pMsg
 = 1;

495 
pMsg
 +ğ(
UIÁ16
);

496 *
pMsg
 = 2;

497 ++
pMsg
;

508 ià(
u£rName
)

510 ià(
	`¡¾’
(
u£rName
) > 0)

512 *
pMsg
 = 0x1b;

513 ++
pMsg
;

514 *(
UIÁ16
 *)
pMsg
 = 
	`¡¾’
(
u£rName
);

515 
pMsg
 +ğ(
UIÁ16
);

516 
	`¡rıy
((*)
pMsg
, 
u£rName
);

517 
pMsg
 +ğ
	`¡¾’
(
u£rName
);

522 ià(
·ssWÜd
)

524 ià(
	`¡¾’
(
·ssWÜd
) > 0)

526 *
pMsg
 = 0x1c;

527 ++
pMsg
;

528 *(
UIÁ16
 *)
pMsg
 = 
	`¡¾’
(
·ssWÜd
);

529 
pMsg
 +ğ(
UIÁ16
);

530 
	`¡rıy
((*)
pMsg
, 
·ssWÜd
);

531 
pMsg
 +ğ
	`¡¾’
(
·ssWÜd
);

535 
CÚÃùIpMode
)

537 
IPv4
:

539 *
pMsg
 = 0x1d;

540 ++
pMsg
;

542 *(
UIÁ16
 *)
pMsg
 = 1;

543 
pMsg
 +ğ(
UIÁ16
);

545 *(*)
pMsg
 = 4;

546 
pMsg
 +ğ(
UIÁ8
);

549 
IPv6
:

551 *
pMsg
 = 0x1d;

552 ++
pMsg
;

554 *(
UIÁ16
 *)
pMsg
 = 1;

555 
pMsg
 +ğ(
UIÁ16
);

557 *(*)
pMsg
 = 6;

558 
pMsg
 +ğ(
UIÁ8
);

567 *
pMsg
 = 0x01;

568 ++
pMsg
;

570 *(
UIÁ16
 *)
pMsg
 = 2;

571 
pMsg
 +ğ(
UIÁ16
);

573 if(
CÚÃùIpMode
 =ğ
IPv6
)

575 *(*)
pMsg
 = 0;

576 
pMsg
 +ğ(
UIÁ8
);

577 *(*)
pMsg
 = 2;

579 ià(
CÚÃùIpMode
 =ğ
IPv4v6
)

581 *(*)
pMsg
 = 0;

582 
pMsg
 +ğ(
UIÁ8
);

583 *(*)
pMsg
 = 2;

586 
pMsg
 +ğ(
UIÁ8
);

591 *
pMsg
 = 0x11;

592 ++
pMsg
;

594 *(
UIÁ16
 *)
pMsg
 = 1;

595 
pMsg
 +ğ(
UIÁ16
);

597 if(
CÚÃùIpMode
 =ğ
IPv6
)

599 *(*)
pMsg
 = 2;

601 if(
CÚÃùIpMode
 =ğ
IPv4v6
)

603 *(*)
pMsg
 = 3;

606 
pMsg
 +ğ(
UIÁ8
);

613 
qmuxMsg
->
L’gth
 = 
	`ıu_to_Ë16
((
UIÁ8
 *)
pMsg
 - (UIÁ8 *)&(qmuxMsg->L’gthè- (
UIÁ16
));

614 
qmi
->
L’gth
 = 
	`ıu_to_Ë16
((
UIÁ8
 *)
pMsg
 - (UInt8 *)&(qmi->Length));

615 
msgL’gth
 = (
UIÁ8
 *)
pMsg
 - (UIÁ8 *)
qmi
;

617 
	`lc_kdbg
("%s: CÚÃù dum°d©a:\n",
__func__
);

618 
	`´štk_hex
(
pMsgBuff
,
msgL’gth
);

620 
	`lc_kdbg
("% :†—ve\n",
__func__
);

622  
msgL’gth
;

623 
	}
}

640 
	$QC_WDS_CÚÃù
(
UIÁ8
* 
pMsgBuff
,

641 
UIÁ32
 
Ëngth
,

642 
UIÁ8
 
fCl›ÁID
,

643 *
acûssSŒšg
,

644 *
u£rName
,

645 *
·ssWÜd
,

646 
UIÁ8
 
com´essiÚ
,

647 
UIÁ32
 
CÚÃùIpMode
)

649 
UIÁ16
 
msgL’gth
;

650 
QCQMI
* 
qmi
 = 
NULL
;

651 
UIÁ8
 *
pMsg
 = 
NULL
;

652 
QCQMUX
* 
pQCQMUX
 = 
NULL
;

653 
QCQMUX_MSG_HDR
* 
qmuxMsg
 = 
NULL
;

655 if(
CÚÃùIpMode
 == 2)

657 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

658 
qmi
 = (
QCQMI
*)
pMsgBuff
;

660 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

662 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

663 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

664 
qmi
->
QMITy³
 = 
QMUX_TYPE_WDS
;

665 
qmi
->
Cl›ÁId
 = 
fCl›ÁID
;

667 
msgL’gth
 = (
QCQMI_HDR
);

668 
pMsg
 = (
UIÁ8
 *)
pMsgBuff
;

670 
pMsg
 +ğ
msgL’gth
;

672 
pQCQMUX
 = (
QCQMUX
*)&(
qmi
->
SDU
);

676 
pQCQMUX
->
CFÏgs
 = 
QMUX_CTL_FLAG_SINGLE_MSG
 | 
QMUX_CTL_FLAG_TYPE_CMD
;

677 ++
fQMIT¿n§ùiÚId
;

678 
pQCQMUX
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

684 
qmuxMsg
 = (
QCQMUX_MSG_HDR
*)&(
pQCQMUX
->
Mes§ge
);

685 
qmuxMsg
->
Ty³
 = 
QMIWDS_START_NETWORK_INTERFACE_REQ
;

687 
pMsg
 = (
UIÁ8
 *)&(
qmuxMsg
->
L’gth
);

689 
pMsg
 +ğ(
qmuxMsg
->
L’gth
);

694 *
pMsg
 = 
QCTLV_TYPE_APN
;

695 ++
pMsg
;

697 *(
UIÁ16
 *)
pMsg
 = 
	`¡¾’
(
acûssSŒšg
);

698 
pMsg
 +ğ(
UIÁ16
);

700 
	`¡rıy
((*)
pMsg
, 
acûssSŒšg
);

702 
pMsg
 +ğ
	`¡¾’
(
acûssSŒšg
);

706 
com´essiÚ
)

708 
WwªAuthPrÙocŞNÚe
:

713 
WwªAuthPrÙocŞP­
:

715 *
pMsg
 = 
QCTLV_TYPE_AUTH_TYPE
;

716 ++
pMsg
;

717 *(
UIÁ16
 *)
pMsg
 = 1;

718 
pMsg
 +ğ(
UIÁ16
);

719 *
pMsg
 = 1;

720 ++
pMsg
;

724 
WwªAuthPrÙocŞCh­
:

726 *
pMsg
 = 
QCTLV_TYPE_AUTH_TYPE
;

727 ++
pMsg
;

728 *(
UIÁ16
 *)
pMsg
 = 1;

729 
pMsg
 +ğ(
UIÁ16
);

730 *
pMsg
 = 2;

731 ++
pMsg
;

742 ià(
u£rName
)

744 ià(
	`¡¾’
(
u£rName
) > 0)

746 *
pMsg
 = 
QCTLV_TYPE_USER_NAME
;

747 ++
pMsg
;

748 *(
UIÁ16
 *)
pMsg
 = 
	`¡¾’
(
u£rName
);

749 
pMsg
 +ğ(
UIÁ16
);

750 
	`¡rıy
((*)
pMsg
, 
u£rName
);

751 
pMsg
 +ğ
	`¡¾’
(
u£rName
);

756 ià(
·ssWÜd
)

758 ià(
	`¡¾’
(
·ssWÜd
) > 0)

760 *
pMsg
 = 
QCTLV_TYPE_PASSWORD
;

761 ++
pMsg
;

762 *(
UIÁ16
 *)
pMsg
 = 
	`¡¾’
(
·ssWÜd
);

763 
pMsg
 +ğ(
UIÁ16
);

764 
	`¡rıy
((*)
pMsg
, 
·ssWÜd
);

765 
pMsg
 +ğ
	`¡¾’
(
·ssWÜd
);

769 
CÚÃùIpMode
)

771 
IPv4
:

773 *
pMsg
 = 0x19;

774 ++
pMsg
;

776 *(
UIÁ16
 *)
pMsg
 = 1;

777 
pMsg
 +ğ(
UIÁ16
);

779 *(*)
pMsg
 = 4;

780 
pMsg
 +ğ(
UIÁ8
);

783 
IPv6
:

785 *
pMsg
 = 0x19;

786 ++
pMsg
;

788 *(
UIÁ16
 *)
pMsg
 = 1;

789 
pMsg
 +ğ(
UIÁ16
);

791 *(*)
pMsg
 = 6;

792 
pMsg
 +ğ(
UIÁ8
);

794 *
pMsg
 = 0x31;

795 ++
pMsg
;

797 *(
UIÁ16
 *)
pMsg
 = 1;

798 
pMsg
 +ğ(
UIÁ16
);

800 *(*)
pMsg
 = 2;

801 
pMsg
 +ğ(
UIÁ8
);

808 
qmuxMsg
->
L’gth
 = (
UIÁ8
 *)
pMsg
 - (UIÁ8 *)&(qmuxMsg->L’gthè- (
UIÁ16
);

809 
qmi
->
L’gth
 = (
UIÁ8
 *)
pMsg
 - (UInt8 *)&(qmi->Length);

810 
msgL’gth
 = (
UIÁ8
 *)
pMsg
 - (UIÁ8 *)
qmi
;

812 
	`lc_kdbg
("%s: CÚÃù dum°d©a:\n",
__func__
);

813 
	`´štk_hex
(
pMsgBuff
,
msgL’gth
);

815 
	`lc_kdbg
("% :†—ve\n",
__func__
);

817  
msgL’gth
;

818 
	}
}

830 
	$QC_WDS_DiscÚÃù
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,
NDIS_QMI_STATUS
* 
²dis_¡©us
,UIÁ8 
æag
)

832 
UIÁ16
 
msgL’gth
;

833 
QCQMI
* 
qmi
 = 
NULL
;

834 
QCQMUX
* 
pQCQMUX
 = 
NULL
;

835 
QMIWDS_STOP_NETWORK_INTERFACE_REQ_MSG
* 
pStİMsg
 = 
NULL
;

837 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

839 
msgL’gth
 = (
QCQMI_HDR
è+ (
QCQMUX_HDR
è+ (
QMIWDS_STOP_NETWORK_INTERFACE_REQ_MSG
);

840 ià(
msgL’gth
>
Ëngth
||
pMsgBuff
==
NULL
)

842 
	`lc_kdbg
("% :†’gth=%d < msgL’gth=%d OR…MsgBuff==NULL\n",
__func__
,
msgL’gth
,
Ëngth
);

846 
qmi
 = (
QCQMI
*)
pMsgBuff
;

848 
	`bz”o
(
pMsgBuff
, 
Ëngth
);

850 
qmi
->
IFTy³
 = 
USB_CTL_MSG_TYPE_QMI
;

851 
qmi
->
CFÏgs
 = 
QMICTL_CTL_FLAG_CMD
;

852 
qmi
->
QMITy³
 = 
QMUX_TYPE_WDS
;

853 
qmi
->
Cl›ÁId
 = 
²dis_¡©us
->
fCl›ÁID
;

854 
qmi
->
L’gth
 = 
msgL’gth
 - (qmi->
IFTy³
);

856 
pQCQMUX
 = (
QCQMUX
*)&(
qmi
->
SDU
);

858 
pQCQMUX
->
CFÏgs
 = 
QMUX_CTL_FLAG_SINGLE_MSG
 | 
QMUX_CTL_FLAG_TYPE_CMD
;

859 ++
fQMIT¿n§ùiÚId
;

860 
pQCQMUX
->
T¿n§ùiÚId
 = 
fQMIT¿n§ùiÚId
;

862 
pStİMsg
 = (
QMIWDS_STOP_NETWORK_INTERFACE_REQ_MSG
*)&(
pQCQMUX
->
Mes§ge
);

863 
pStİMsg
->
Ty³
 = 
QMIWDS_STOP_NETWORK_INTERFACE_REQ
;

864 
pStİMsg
->
L’gth
 = (
QMIWDS_STOP_NETWORK_INTERFACE_REQ_MSG
è- (
QCQMUX_MSG_HDR
);

865 
pStİMsg
->
TLVTy³
 = 
QCTLV_TYPE_REQUIRED_PARAMETER
;

866 
pStİMsg
->
TLVL’gth
 = 0x04;

867 if(
æag
)

868 
pStİMsg
->
Pack‘_HªdË
 = 
	`ıu_to_Ë32
(
²dis_¡©us
->
fPack‘HªdË
);

870 
pStİMsg
->
Pack‘_HªdË
 = 
	`ıu_to_Ë32
(
²dis_¡©us
->
fPack‘HªdË1
);

872 
	`lc_kdbg
("% :†—ve\n",
__func__
);

874  
msgL’gth
;

876 
	`lc_kdbg
("% :†—ve\n",
__func__
);

878  
msgL’gth
;

879 
	}
}

891 
	$QCTL_Proûûss_G‘Cl›Á_ID_Re¥Ú£
(
QCQMI
* 
pQmi
,
UIÁ8
* 
fCl›ÁID
,UIÁ8* 
fQMITy³
)

893 
QMICTL_GET_CLIENT_ID_RESP_MSG
* 
pMsg
 = (QMICTL_GET_CLIENT_ID_RESP_MSG*)&(
pQmi
->
SDU
);

895 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

897 ià(
pMsg
->
QMIResuÉ
 =ğ
QMI_RESULT_SUCCESS
)

899 *
fCl›ÁID
 = 
pMsg
->
Cl›ÁId
;

900 *
fQMITy³
 = 
pMsg
->
QMITy³
;

902 
	`lc_kdbg
("%s: g‘ cl›Á id.\n",
__func__
);

906 *
fCl›ÁID
 = 0;

907 *
fQMITy³
 = 0;

908 
	`lc_kdbg
("%s: faedØg‘ cl›Á id.\n",
__func__
);

912 
	`lc_kdbg
("% :†—ve\n",
__func__
);

915 
	}
}

926 
	$QCTL_Proûûss_S‘D©aFÜm©_Re¥Ú£
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

928 
QMICTL_SET_DATA_FORMAT_RESP_MSG
* 
pMsg
 = (QMICTL_SET_DATA_FORMAT_RESP_MSG*)&(
pQmi
->
SDU
);

930 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

932 ià(
pMsg
->
QMIResuÉ
 =ğ
QMI_RESULT_SUCCESS
)

934 ià(
²dis_¡©us
->
fIPPack‘SuµÜt
)

936 
UIÁ8
 *
pMsgS¹
 = (UIÁ8 *è&(
pMsg
->
TLVTy³
);

937 
UIÁ8
 *
pMsgPŒ
 = (UIÁ8 *)&(
pMsg
->
QMIE¼Ü
);

938 
UIÁ32
 
»mªšgBy‹s
;

939 
pMsgPŒ
 +ğ(
UIÁ16
);

941 
»mªšgBy‹s
 = 
pMsg
->
L’gth
 - (
pMsgPŒ
 -
pMsgS¹
);

943 ià(
»mªšgBy‹s
 >ğ(
QMICTL_SET_DATA_FORMAT_TLV_LINK_PROT
))

945 ià(
pMsg
->
PrÙo
.
TLVTy³
 =ğ
SET_DATA_FORMAT_TLV_TYPE_LINK_PROTO
)

947 
	`lc_kdbg
("%s:†šk…rÙocŞ„eûived.pMsg->PrÙo.LškPrÙ=%u\n",
__func__
,
pMsg
->
PrÙo
.
LškPrÙ
);

948 
²dis_¡©us
->
fIPModeEÇbËd
 = (
pMsg
->
PrÙo
.
LškPrÙ
 =ğ
SET_DATA_FORMAT_LINK_PROTO_IP
);

949 ià(
²dis_¡©us
->
fIPModeEÇbËd
)

951 
	`lc_kdbg
("IP Mode isƒnabled!\n");

959 
	`lc_kdbg
("%s: faedØ£ˆd©¨fÜm©.QMIE¼Ü=%u,QMIResuÉ=%u\n",
__func__
, 
pMsg
->
QMIE¼Ü
,…Msg->
QMIResuÉ
);

969 
	`lc_kdbg
("% :†—ve\n",
__func__
);

972 
	}
}

984 
	$QCTL_Proûûss_S‘In¡ªûId_Re¥Ú£
(
QCQMI
* 
pQmi
,* 
fS‘In¡ªûIdFa
,
UIÁ32
* 
fQMI_ID
)

986 
QMICTL_SET_INSTANCE_ID_RESP_MSG
* 
pMsg
 = (QMICTL_SET_INSTANCE_ID_RESP_MSG*)&(
pQmi
->
SDU
);

988 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

990 ià(
pMsg
->
QMIResuÉ
 =ğ
QMI_RESULT_SUCCESS
)

992 *
fQMI_ID
 = 
pMsg
->
QMI_ID
;

993 *
fS‘In¡ªûIdFa
 = -1;

994 
	`lc_kdbg
("%s: g‘ qm˜id,QMI_ID=%u\n",
__func__
,
pMsg
->
QMI_ID
);

998 *
fS‘In¡ªûIdFa
 = 1;

999 *
fQMI_ID
 = 
MP_INVALID_QMI_ID
;

1000 
	`lc_kdbg
("%s: failedo get qmi id,QMIResult=%u,QMIError=%u.\n",

1001 
__func__
,
pMsg
->
QMIResuÉ
,…Msg->
QMIE¼Ü
);

1011 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1014 
	}
}

1026 
	$QCTL_Proûûss_R–—£Cl›Á_ID_Re¥Ú£
(
QCQMI
* 
pQmi
,
UIÁ8
* 
fCl›ÁID
,UIÁ8* 
fQMITy³
)

1028 
QMICTL_RELEASE_CLIENT_ID_RESP_MSG
* 
pMsg
 = (QMICTL_RELEASE_CLIENT_ID_RESP_MSG*)&(
pQmi
->
SDU
);

1030 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

1032 ià(
pMsg
->
QMIResuÉ
 =ğ
QMI_RESULT_SUCCESS
)

1034 
	`lc_kdbg
Ğ"%s:„–—£ cl›Á id.Cl›ÁId=%u,QMITy³=%u.\n", 
__func__
,
pMsg
->
Cl›ÁId
,…Msg->
QMITy³
);

1036 ià(*
fCl›ÁID
 =ğ
pMsg
->
Cl›ÁId
 && *
fQMITy³
 =ğpMsg->
QMITy³
)

1038 *
fCl›ÁID
 = 0;

1039 *
fQMITy³
 = 0;

1044 
	`lc_kdbg
Ğ"%s: faedØ»Ëa£ cl›Á id,QMIE¼Ü=%u,QMIResuÉ=%u.\n",
__func__
,
pMsg
->
QMIE¼Ü
,…Msg->
QMIResuÉ
);

1054 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1057 
	}
}

1068 
	$QCTL_Proûûss_G‘V”siÚ_Re¥Ús
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

1070 
QMICTL_GET_VERSION_RESP_MSG
* 
pMsg
 = (QMICTL_GET_VERSION_RESP_MSG*è&(
pQmi
->
SDU
);

1071 
QMUX_TYPE_VERSION_STRUCT
* 
pV”siÚ
 = 
NULL
;

1072 
UIÁ32
 
msgL’
;

1073 
UIÁ8
 *
pMsgS¹
;

1074 
i
;

1075 
msgL’
 = 
pMsg
->
L’gth
;

1076 
pMsgS¹
 = (
UIÁ8
 *è&(
pMsg
->
TLVTy³
);

1079 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

1081 ià(
pMsg
->
QMIResuÉ
 !ğ
QMI_RESULT_SUCCESS
)

1083 
	`lc_kdbg
Ğ"%s: faedØg‘ v”siÚ.QMIE¼Ü=%u,QMIResuÉ=%u.\n",
__func__
,
pMsg
->
QMIE¼Ü
,…Msg->
QMIResuÉ
);

1089 
msgL’
 -ğ(
QMI_TLV_HDR
);

1090 
pMsgS¹
 +ğ(
QMI_TLV_HDR
);

1091 
msgL’
 -ğ
pMsg
->
TLVL’gth
;

1092 
pMsgS¹
 +ğ
pMsg
->
TLVL’gth
;

1093 
msgL’
 -ğ(
QMI_TLV_HDR
);

1094 
pMsgS¹
 +ğ(
QMI_TLV_HDR
);

1095 
msgL’
 -ğ
pMsg
->
TLV2L’gth
;

1096 
pMsgS¹
 +ğ
pMsg
->
TLV2L’gth
;

1098 
pV”siÚ
 = (
QMUX_TYPE_VERSION_STRUCT
*è&(
pMsg
->
Ty³V”siÚ
);

1100  
i
 = 0; i < 
pMsg
->
NumEËm’ts
; ++i)

1102 ià(
pV”siÚ
->
QMUXTy³
 =ğ
QMUX_TYPE_CTL
)

1104 
	`lc_kdbg
( "%s: get qmi control version,MajorVersion=%u,MinorVersion=%u.\n",

1105 
__func__
,
pV”siÚ
->
MajÜV”siÚ
,pV”siÚ->
MšÜV”siÚ
);

1107 ià(
pV”siÚ
->
MajÜV”siÚ
 >ğ1 &&…V”siÚ->
MšÜV”siÚ
 >= 3)

1109 
²dis_¡©us
->
fIPPack‘SuµÜt
 = 
Œue
;

1110 
	`lc_kdbg
("%s: IP Supported,MajorVersion=%u,MinorVersion=%u.\n",

1111 
__func__
,
pV”siÚ
->
MajÜV”siÚ
,…V”siÚ->
MšÜV”siÚ
);

1112 
	`¥rštf
(
²dis_¡©us
->
fV”siÚ
,"%u.%u",
pV”siÚ
->
MajÜV”siÚ
,…V”siÚ->
MšÜV”siÚ
);

1116 ++
pV”siÚ
;

1120 
msgL’
 >ğ(
QMI_TLV_HDR
))

1122 
QMI_TLV_HDR
* 
pHdr
 = (QMI_TLV_HDR*è
pMsgS¹
;

1123 
UIÁ8
 *
pCurMsg
 = 
NULL
;

1124 
UIÁ8
 
numIn¡ªûs
;

1126 
	`lc_kdbg
("%s:ƒxŒ¨v…roûss.",
__func__
);

1127 
msgL’
 -ğ(
QMI_TLV_HDR
);

1128 
pMsgS¹
 +ğ(
QMI_TLV_HDR
);

1129 
pCurMsg
 = 
pMsgS¹
;

1130 
msgL’
 -ğ
pHdr
->
TLVL’gth
;

1131 
pMsgS¹
 +ğ
pHdr
->
TLVL’gth
;

1133 ià(
msgL’
 < 0)

1138 
pHdr
->
TLVTy³
)

1140 
QMICTL_GETVERSION_RSP_TLV_TYPE_ADD_VERSION
:

1143 
pCurMsg
 += *pCurMsg;

1144 
pCurMsg
 += 1;

1146 
numIn¡ªûs
 = *
pCurMsg
;

1147 
pCurMsg
 += 1;

1149 
pV”siÚ
 = (
QMUX_TYPE_VERSION_STRUCT
*è&(
pCurMsg
);

1151  
i
 = 0; i < 
numIn¡ªûs
; ++i)

1153 ià(
pV”siÚ
->
QMUXTy³
 =ğ
QMUX_TYPE_CTL
)

1155 
	`lc_kdbg
( "%s: get qmi control version,MajorVersion=%u,MinorVersion=%u.\n",

1156 
__func__
,
pV”siÚ
->
MajÜV”siÚ
,…V”siÚ->
MšÜV”siÚ
);

1158 ià(
pV”siÚ
->
MajÜV”siÚ
 >ğ1 &&…V”siÚ->
MšÜV”siÚ
 >= 3)

1160 
²dis_¡©us
->
fIPPack‘SuµÜt
 = 
Œue
;

1161 
	`lc_kdbg
( "%s: IP Supported,MajorVersion=%u,MinorVersion=%u.\n",

1162 
__func__
, 
pV”siÚ
->
MajÜV”siÚ
,…V”siÚ->
MšÜV”siÚ
);

1163 
	`¥rštf
(
²dis_¡©us
->
fV”siÚ
,"%u.%u",
pV”siÚ
->
MajÜV”siÚ
,…V”siÚ->
MšÜV”siÚ
);

1167 ++
pV”siÚ
;

1186 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1189 
	}
}

1200 
	$QCQMI_ProûssQMUXWDSRe¥Ú£
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

1202 
QCQMUX
* 
pQmux
 = 
NULL
;

1203 
QCQMUX_MSG_HDR
* 
pQmuxMsg
 = 
NULL
;

1204 
UIÁ16
 
tÙ®L’gth
 = 0;

1205 
boŞ
 
bCompound
 = 
çl£
;

1206 
boŞ
 
bDÚe
 = 
çl£
;

1207 
»t
 = -1;

1209 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

1211 
pQmux
 = (
QCQMUX
*)&(
pQmi
->
SDU
);

1212 
pQmuxMsg
 = (
QCQMUX_MSG_HDR
*)&(
pQmux
->
Mes§ge
);

1215 
tÙ®L’gth
 = 
pQmi
->
L’gth
;

1217 
tÙ®L’gth
 -ğ(
QCQMI_HDR
);

1218 
tÙ®L’gth
 +ğ(
pQmi
->
IFTy³
);

1220 
tÙ®L’gth
 -=(
QCQMUX
);

1221 
tÙ®L’gth
 +ğ(
pQmux
->
Mes§ge
);

1223 ià(
pQmux
->
CFÏgs
 & 
QMUX_CTL_FLAG_MASK_COMPOUND
)

1225 
bCompound
 = 
Œue
;

1226 
	`lc_kdbg
("%s:compounded mes§ge.\n",
__func__
);

1229 
bDÚe
 =ğ
çl£
)

1231 
pQmuxMsg
->
Ty³
)

1233 
QMIWDS_START_NETWORK_INTERFACE_RESP
:

1235 
QMIWDS_START_NETWORK_INTERFACE_RESP_MSG
* 
pS¹Msg
 = (QMIWDS_START_NETWORK_INTERFACE_RESP_MSG*)
pQmuxMsg
;

1237 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMIWDS_START_NETWORK_INTERFACE_RESP.\n");

1238 
»t
 = 
QMI_CONNECT
;

1239 ià(
pS¹Msg
->
QMUXResuÉ
 !ğ
QMI_RESULT_SUCCESS
)

1242 
	`lc_kdbg
("QCQMI_ProûssQMUXWDSRe¥Ú£:CÚÃùiÚ Faed,QMUXE¼Ü=%u.\n",
pS¹Msg
->
QMUXE¼Ü
);

1243 
²dis_¡©us
->
fPack‘HªdË
 = 0;

1245 if(
²dis_¡©us
->
fCÚÃùšg
)

1247 
²dis_¡©us
->
fCÚÃùiÚE¼Ü
 = 
pS¹Msg
->
QMUXE¼Ü
;

1248 
	`lc_kdbg
("kaibo : QCQMI_ProcessQMUXWDSResponse:No connect has ok.\n");

1252 
	`lc_kdbg
("kaibo : QCQMI_ProcessQMUXWDSResponse:One connect has ok.Iogren it\n");

1255 ià(
²dis_¡©us
->
fCÚÃùšg
)

1257 
²dis_¡©us
->
fCÚÃùšg
 = 
çl£
;

1259 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMIWDS_START_NETWORK_INTERFACE_RESP command wake up.\n");

1264 if(
²dis_¡©us
->
fPack‘HªdË
)

1265 
²dis_¡©us
->
fPack‘HªdË
 = 
	`Ë32_to_ıu
(
pS¹Msg
->
Pkt_D©a_HªdË
);

1266 if(!
²dis_¡©us
->
fPack‘HªdË
)

1267 
²dis_¡©us
->
fPack‘HªdË1
 = 
	`Ë32_to_ıu
(
pS¹Msg
->
Pkt_D©a_HªdË
);

1268 
²dis_¡©us
->
fCÚÃùiÚE¼Ü
 = 0;

1269 
	`lc_kdbg
("QCQMI_ProûssQMUXWDSRe¥Ú£:CÚÃùiÚ Sucûeded,Pkt_D©a_HªdË=%u!\n", 
pS¹Msg
->
Pkt_D©a_HªdË
);

1272 ià(
²dis_¡©us
->
fCÚÃùšg
 && !²dis_¡©us->
fIPModeEÇbËd
)

1274 
²dis_¡©us
->
fCÚÃùšg
 = 
çl£
;

1276 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMIWDS_START_NETWORK_INTERFACE_RESP command wake up.\n");

1281 
QMIWDS_STOP_NETWORK_INTERFACE_RESP
:

1283 
QMIWDS_RESP_MSG_HEADER
* 
pMsgH—d”
 = (QMIWDS_RESP_MSG_HEADER*è
pQmuxMsg
;

1285 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMIWDS_STOP_NETWORK_INTERFACE_RESP");

1286 
»t
 = 
QMI_DISCONNECT
;

1287 ià(
pMsgH—d”
->
QMUXResuÉ
 !ğ
QMI_RESULT_SUCCESS
)

1289 
²dis_¡©us
->
fCÚÃùiÚE¼Ü
 = 
pMsgH—d”
->
QMUXE¼Ü
;

1290 
	`lc_kdbg
("QCQMI_ProûssQMUXWDSRe¥Ú£:DiscÚÃùiÚ Faed,QMUXE¼Ü=%u.\n",
pMsgH—d”
->
QMUXE¼Ü
);

1294 
²dis_¡©us
->
fPack‘HªdË
 = 0;

1295 
²dis_¡©us
->
fCÚÃùiÚE¼Ü
 = 0;

1298 ià(
²dis_¡©us
->
fDiscÚÃùšg
)

1300 
²dis_¡©us
->
fDiscÚÃùšg
 = 
çl£
;

1302 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMIWDS_STOP_NETWORK_INTERFACE_RESP command wake up.\n");

1308 
QMIWDS_GET_RUNTIME_SETTINGS_RESP
:

1310 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMIWDS_GET_RUNTIME_SETTINGS_RESP.\n");

1311 
	`QC_WDS_Proûss_G‘RunTimeS‘tšgs_Re¥Ús
(
pQmuxMsg
,
²dis_¡©us
);

1312 
»t
 = 
QMI_GET_IP_ADDR
;

1317 
QMI_WDS_MODIFY_PROFILE_SETTINGS_RESP
:

1319 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSResponse:QMI_WDS_MODIFY_PROFILE_SETTINGS_RESP.\n");

1320 
»t
 = 
QMI_MODIFY_PRO
;

1330 ià(!
bCompound
)

1335 
tÙ®L’gth
 -ğ(
QCQMUX_MSG_HDR
);

1336 
tÙ®L’gth
 -ğ
pQmuxMsg
->
L’gth
;

1338 ià(
tÙ®L’gth
 > (
PQCQMUX_MSG_HDR
))

1340 
bDÚe
 = 
çl£
;

1344 
bDÚe
 = 
Œue
;

1348 
pQmuxMsg
 = (
PQCQMUX_MSG_HDR
)((
UIÁ8
 *íQmuxMsg + (
QCQMUX_MSG_HDR
è+…QmuxMsg->
L’gth
);

1350 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1352  
»t
;

1353 
	}
}

1364 
	$QC_WDS_Proûss_G‘RunTimeS‘tšgs_Re¥Ús
(
QCQMUX_MSG_HDR
* 
pQMuxMsg
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

1366 
QMIWDS_GET_RUNTIME_SETTINGS_RESP_MSG
* 
pG‘Msg
 = (QMIWDS_GET_RUNTIME_SETTINGS_RESP_MSG*)
pQMuxMsg
;

1367 
»t
 = 0;

1369 
	`lc_kdbg
("% :ƒÁry\n",
__func__
);

1371 ià(
pG‘Msg
->
QMUXResuÉ
 !ğ
QMI_RESULT_SUCCESS
)

1373 
²dis_¡©us
->
fIPAdd»ss
 = 0;

1374 
²dis_¡©us
->
fCÚÃùiÚE¼Ü
 = 
pG‘Msg
->
QMUXE¼Ü
;

1375 
	`lc_kdbg
("%s: faedØg‘ i°add»ss,QMUXE¼Ü=%u,QMUXResuÉ=%u.\n",
__func__
,

1376 
pG‘Msg
->
QMUXE¼Ü
,…G‘Msg->
QMUXResuÉ
);

1377 
»t
 = -1;

1381 
UIÁ32
 
»maššgBy‹s
 = 0;

1382 
UIÁ8
 *
pMsgS¹
 = (UIÁ8 *)&(
pG‘Msg
->
TLVTy³
);

1383 
UIÁ8
 *
pMsgPŒ
 = (UIÁ8 *)&(
pG‘Msg
->
QMUXE¼Ü
);

1384 
pMsgPŒ
 +ğ(
UIÁ16
);

1386 
»maššgBy‹s
 = 
pQMuxMsg
->
L’gth
 - (
pMsgS¹
 - 
pMsgPŒ
);

1388 ià(
»maššgBy‹s
 >ğ(
QMIWDS_GET_RUNTIME_SETTINGS_TLV_IPV4_ADDR
))

1390 
QMIWDS_GET_RUNTIME_SETTINGS_TLV_IPV4_ADDR
* 
pAddr
 = (QMIWDS_GET_RUNTIME_SETTINGS_TLV_IPV4_ADDR*)
pMsgPŒ
;

1392 ià(
pAddr
->
TLVTy³
 =ğ
QMIWDS_GET_RUNTIME_SETTINGS_TLV_TYPE_IPV4
)

1394 
²dis_¡©us
->
fIPAdd»ss
 = 
	`Áohl
(
pAddr
->
IPV4Add»ss
);

1397 ià(
²dis_¡©us
->
fIPPack‘SuµÜt
 &&…ndis_¡©us->
fIPModeEÇbËd
 &&…ndis_¡©us->
fPack‘HªdË
 != 0)

1403 
²dis_¡©us
->
fLškStus
 = 1;

1406 
	`lc_kdbg
("%s: sucûssfuÎy g‘ i°add»ss:IPV4Add»ss=%u,fIPAdd»ss=%u.\n",
__func__
,

1407 
pAddr
->
IPV4Add»ss
, 
²dis_¡©us
->
fIPAdd»ss
);

1408 
»t
 = 0;

1412 
	`lc_kdbg
("QC_WDS_Proûss_G‘RunTimeS‘tšgs_Re¥Ús: inv®idlvy³=%u.\n",
pAddr
->
TLVTy³
);

1413 
»t
 = -1;

1418 ià(
fG‘IpAdd»ssšg
)

1420 
fG‘IpAdd»ssšg
 = 
çl£
;

1421 
fCommªdG©e
->
	`commªdWakeup
(
NULL
, 
çl£
);

1422 
	`XTRACE
(
this
, 0, 0, "QC_WDS_Process_GetRunTimeSettings_Respons:‚ow wake up command gate");

1425 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1427  
»t
;

1428 
	}
}

1439 
	$´oûssQMIRe¥Ú£
(*
bufãr
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

1441 
QCQMI
* 
qmi
 = (QCQMI*)
bufãr
;

1442 
»t
 = -1;

1444 
	`lc_kdbg
("% :ƒÁry.\n",
__func__
);

1445 
	`lc_kdbg
("qm˜bufã¸i %02x, %04x, %02x, %02x, %02x\n", 
qmi
->
IFTy³
, qmi->
L’gth
, qmi->
CFÏgs
, qmi->
QMITy³
, qmi->
Cl›ÁId
);

1447 ià(
qmi
->
CFÏgs
 !ğ
QCQMI_CTL_FLAG_SERVICE
)

1449 
	`lc_kdbg
("%s:UÃx³ùed QMI cÚŒŞ fÏgs,IFTy³=%u,CFÏgs=%u.\n",
__func__
,
qmi
->
IFTy³
, qmi->
CFÏgs
);

1453 ià(
QMUX_TYPE_CTL
 =ğ
qmi
->
QMITy³
)

1456 
QCQMICTL_MSG_HDR
* 
pCMsgHdr
 = (QCQMICTL_MSG_HDR*)&(
qmi
->
SDU
);

1457 
UIÁ8
 
cÚŒŞFÏg
;

1459 
cÚŒŞFÏg
 = 
pCMsgHdr
->
CFÏg
 & 0x03;

1461 
cÚŒŞFÏg
)

1464 
QMICTL_CTL_FLAG_RSP
:

1466 
pCMsgHdr
->
QMICTLTy³
)

1468 
QMICTL_SET_INSTANCE_ID_RESP
:

1470 
	`lc_kdbg
("processQMIResponse:QMICTL_SET_INSTANCE_ID_RESP.\n");

1471 
	`QCTL_Proûûss_S‘In¡ªûId_Re¥Ú£
(
qmi
,&(
²dis_¡©us
->
fS‘In¡ªûIdFa
),&Õndis_¡©us->
fQMI_ID
));

1472 
»t
 = 
QMI_SET_INSTANCE
;

1476 
QMICTL_GET_CLIENT_ID_RESP
:

1478 
	`lc_kdbg
("processQMIResponse:QMICTL_GET_CLIENT_ID_RESP.\n");

1479 
	`QCTL_Proûûss_G‘Cl›Á_ID_Re¥Ú£
(
qmi
,&(
²dis_¡©us
->
fCl›ÁID
),&Õndis_¡©us->
fQMITy³
));

1480 
»t
 = 
QMI_GET_CLIENT_ID
;

1484 
QMICTL_RELEASE_CLIENT_ID_RESP
:

1486 
	`lc_kdbg
("processQMIResponse:QMICTL_RELEASE_CLIENT_ID_RESP.\n");

1487 
	`QCTL_Proûûss_R–—£Cl›Á_ID_Re¥Ú£
(
qmi
,&(
²dis_¡©us
->
fCl›ÁID
),&Õndis_¡©us->
fQMITy³
));

1488 
»t
 = 
QMI_RELEASE_CLIENT_ID
;

1491 
QMICTL_GET_VERSION_RESP
:

1493 
	`lc_kdbg
("processQMIResponse:QMICTL_GET_VERSION_RESP.\n");

1494 
	`QCTL_Proûûss_G‘V”siÚ_Re¥Ús
(
qmi
,
²dis_¡©us
);

1495 
»t
 = 
QMI_GET_VERSION
;

1498 
QMICTL_SET_DATA_FORMAT_RESP
:

1500 
	`lc_kdbg
("processQMIResponse:QMICTL_SET_DATA_FORMAT_RESP.\n");

1501 
	`QCTL_Proûûss_S‘D©aFÜm©_Re¥Ú£
(
qmi
,
²dis_¡©us
);

1502 
»t
 = 
QMI_SET_DATA_FORMAT
;

1507 
	`lc_kdbg
("´oûssQMIRe¥Ú£:unkowÀcÚŒŞ mes§ge,QMICTLTy³=%u.\n",
pCMsgHdr
->
QMICTLTy³
);

1516 
QMICTL_CTL_FLAG_IND
:

1518 
pCMsgHdr
->
QMICTLTy³
)

1520 
QMICTL_REVOKE_CLIENT_IDIND
:

1522 
	`lc_kdbg
("processQMIResponse:QMICTL_REVOKE_CLIENT_IDIND.\n");

1524 
²dis_¡©us
->
fCl›ÁID
 = 0;

1525 
²dis_¡©us
->
fQMITy³
 = 0;

1528 
QMICTL_INVALID_CLIENT_ID_IND
:

1530 
	`lc_kdbg
("processQMIResponse:QMICTL_INVALID_CLIENT_ID_IND.\n");

1535 
	`lc_kdbg
("%s:unkowÀQMICTLTy³=%u.\n",
__func__
,
pCMsgHdr
->
QMICTLTy³
);

1543 
	`lc_kdbg
("%s:unkowÀcÚŒŞFÏg=%u.\n",
__func__
,
cÚŒŞFÏg
);

1550 
UIÁ8
 
cÚŒŞFÏg
 = 0;

1551 
QCQMUX
* 
pQmux
 = 
NULL
;

1552 
QCQMUX_MSG_HDR
* 
pQmuxMsg
 = 
NULL
;

1554 
pQmux
 = (
QCQMUX
*)&(
qmi
->
SDU
);

1555 
pQmuxMsg
 = (
QCQMUX_MSG_HDR
*)&(
pQmux
->
Mes§ge
);

1557 
cÚŒŞFÏg
 = 
pQmux
->
CFÏgs
 & 
QMUX_CTL_FLAG_MASK_TYPE
;

1559 
cÚŒŞFÏg
)

1561 
QMUX_CTL_FLAG_TYPE_RSP
:

1563 
qmi
->
QMITy³
)

1565 
QMUX_TYPE_WDS
:

1567 
	`lc_kdbg
("processQMIResponse:QMUX_CTL_FLAG_TYPE_RSP-QMUX_TYPE_WDS.\n");

1568 
»t
 = 
	`QCQMI_ProûssQMUXWDSRe¥Ú£
(
qmi
, 
²dis_¡©us
);

1571 
QMUX_TYPE_DMS
:

1573 
	`lc_kdbg
("processQMIResponse:QMUX_CTL_FLAG_TYPE_RSP-QMUX_TYPE_DMS.\n");

1578 
	`lc_kdbg
("´oûssQMIRe¥Ú£:QMUX_CTL_FLAG_TYPE_RSP-QMUXUnknown,QMITy³=%u.\n", 
qmi
->
QMITy³
);

1585 
QMUX_CTL_FLAG_TYPE_IND
:

1587 
qmi
->
QMITy³
)

1589 
QMUX_TYPE_WDS
:

1591 
	`lc_kdbg
("processQMIResponse:QMUX_CTL_FLAG_TYPE_IND-QMUX_TYPE_WDS.\n");

1592 
»t
 = 
	`QCQMI_ProûssQMUXWDSIndiÿtiÚ
(
qmi
, 
²dis_¡©us
);

1597 
	`lc_kdbg
("´oûssQMIRe¥Ú£:QMUX_CTL_FLAG_TYPE_IND-QMUXUnknown,QMITy³=%u.\n", 
qmi
->
QMITy³
);

1606 
	`lc_kdbg
("%s:unkowÀcÚŒŞFÏg=%u.\n",
__func__
,
cÚŒŞFÏg
);

1612 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1614  
»t
;

1615 
	}
}

1626 
	$QCQMI_ProûssQMUXWDSIndiÿtiÚ
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
)

1628 
QCQMUX
* 
pQmux
 = 
NULL
;

1629 
QCQMUX_MSG_HDR
* 
pQmuxMsg
 = 
NULL
;

1630 
UIÁ16
 
tÙ®L’gth
 = 0;

1631 
boŞ
 
bCompound
 = 
çl£
;

1632 
boŞ
 
bDÚe
 = 
çl£
;

1634 
	`lc_kdbg
("% :ƒÁry.\n",
__func__
);

1636 
pQmux
 = (
QCQMUX
*)&(
pQmi
->
SDU
);

1637 
pQmuxMsg
 = (
QCQMUX_MSG_HDR
*)&(
pQmux
->
Mes§ge
);

1640 
tÙ®L’gth
 = 
pQmi
->
L’gth
;

1642 
tÙ®L’gth
 -ğ(
QCQMI_HDR
);

1643 
tÙ®L’gth
 +ğ(
pQmi
->
IFTy³
);

1645 
tÙ®L’gth
 -=(
QCQMUX
);

1646 
tÙ®L’gth
 +ğ(
pQmux
->
Mes§ge
);

1650 ià(
pQmux
->
CFÏgs
 & 
QMUX_CTL_FLAG_MASK_COMPOUND
)

1652 
bCompound
 = 
Œue
;

1655 
bDÚe
 =ğ
çl£
)

1657 
pQmuxMsg
->
Ty³
)

1659 
QMIWDS_GET_PKT_SRVC_STATUS_IND
:

1661 
QMIWDS_GET_PKT_SRVC_STATUS_IND_MSG
* 
pPktInd
 = (QMIWDS_GET_PKT_SRVC_STATUS_IND_MSG*)
pQmuxMsg
;

1663 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSIndication:QMIWDS_GET_PKT_SRVC_STATUS_IND.\n");

1665 ià(
pPktInd
->
CÚÃùiÚStus
 =ğ
QWDS_PKT_DATA_CONNECTED
)

1667 ià(
pPktInd
->
RecÚfigRequœed
 == 0)

1669 ià(!
²dis_¡©us
->
fIPModeEÇbËd
)

1675 
²dis_¡©us
->
fLškStus
 = 1;

1677 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSIndication:QMIWDS_GET_PKT_SRVC_STATUS_IND connected.\n");

1684 
²dis_¡©us
->
fLškStus
 = 0;

1685 
²dis_¡©us
->
fPack‘HªdË
 = 0;

1686 
²dis_¡©us
->
fIPAdd»ss
 = 0;

1687 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSIndication:QMIWDS_GET_PKT_SRVC_STATUS_IND disconnected.\n");

1695 
²dis_¡©us
->
fLškStus
 = 0;

1696 
²dis_¡©us
->
fPack‘HªdË
 = 0;

1697 
²dis_¡©us
->
fIPAdd»ss
 = 0;

1698 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSIndication:QMIWDS_GET_PKT_SRVC_STATUS_IND disconnected.\n");

1700 
²dis_¡©us
->
fLškStus
 = 0;

1705 ià(
²dis_¡©us
->
fCÚÃùšg
)

1707 
²dis_¡©us
->
fCÚÃùšg
 = 
çl£
;

1709 
	`lc_kdbg
("QCQMI_ProcessQMUXWDSIndication:QMIWDS_GET_PKT_SRVC_STATUS_IND command wake up.\n");

1721 ià(!
bCompound
)

1726 
tÙ®L’gth
 -ğ(
QCQMUX_MSG_HDR
);

1727 
tÙ®L’gth
 -ğ
pQmuxMsg
->
L’gth
;

1729 ià(
tÙ®L’gth
 > (
PQCQMUX_MSG_HDR
))

1731 
bDÚe
 = 
çl£
;

1735 
bDÚe
 = 
Œue
;

1739 
pQmuxMsg
 = (
PQCQMUX_MSG_HDR
)((
UIÁ8
 *íQmuxMsg + (
QCQMUX_MSG_HDR
è+…QmuxMsg->
L’gth
);

1742 
	`lc_kdbg
("% :†—ve\n",
__func__
);

1745 
	}
}

	@driver/ndis/src/qmi_oper.h

1 #iâdeà
__QMI_OPER_H__


2 
	#__QMI_OPER_H__


	)

4 
	~"qmi_h—d”.h
"

5 
	#DEBUG


	)

9 
	mQMI_GET_CLIENT_ID
 = 0,

10 
	mQMI_RELEASE_CLIENT_ID
,

11 
	mQMI_CONNECT
,

12 
	mQMI_DISCONNECT
,

13 
	mQMI_GET_IP_ADDR
,

14 
	mQMI_SET_DATA_FORMAT
,

15 
	mQMI_SET_INSTANCE
,

16 
	mQMI_GET_VERSION
,

17 
	mQMI_MODIFY_PRO
,

20 
	s_NDIS_QMI_STATUS
{

21 
UIÁ32
 
	mfPack‘HªdË
;

22 
UIÁ32
 
	mfPack‘HªdË1
;

23 
boŞ
 
	mfIPPack‘SuµÜt
;

24 
boŞ
 
	mfDiscÚÃùšg
;

25 
boŞ
 
	mfCÚÃùšg
;

26 
boŞ
 
	mfG‘V”siÚšg
;

27 
boŞ
 
	mfIPModeEÇbËd
;

28 
	mfCÚÃùiÚStus
;

29 
	mfS‘In¡ªûIdFa
;

30 
UIÁ32
 
	mfQMI_ID
;

31 
UIÁ32
 
	mfIPAdd»ss
;

32 
UIÁ16
 
	mfCÚÃùiÚE¼Ü
;

33 
UIÁ8
 
	mfQMITy³
;

34 
UIÁ8
 
	mfCl›ÁID
;

35 
UIÁ8
 
	mfLškStus
;

36 
	mfV”siÚ
[64];

37 } 
	tNDIS_QMI_STATUS
;

47 
´štk_hex
(
UIÁ8
 *
buf
,
buf_size
);

59 
QCTL_G‘Cl›ÁID
(
UIÁ8
 * 
pMsgBuff
,
UIÁ32
 
Ëngth
,UIÁ8 
qmiTy³
);

71 
QCTL_R–—£Cl›ÁID
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

82 
QCTL_G‘V”siÚReq
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
);

93 
QCTL_S‘D©aFÜm©Req
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
);

104 
QCTL_S‘In¡ªûId
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
);

116 
QC_WDS_G‘IPAdd»ss
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,UIÁ8 
fCl›ÁID
);

131 
QC_WDS_ModifyProfe
(
UIÁ8
* 
pMsgBuff
,

132 
UIÁ32
 
Ëngth
,

133 
NDIS_QMI_STATUS
* 
²dis_¡©us
,

134 *
acûssSŒšg
,

135 *
u£rName
,

136 *
·ssWÜd
,

137 
UIÁ8
 
com´essiÚ
,

138 
UIÁ32
 
CÚÃùIpMode
);

156 
QC_WDS_CÚÃù
(
UIÁ8
* 
pMsgBuff
,

157 
UIÁ32
 
Ëngth
,

158 
UIÁ8
 
fCl›ÁID
,

159 *
acûssSŒšg
,

160 *
u£rName
,

161 *
·ssWÜd
,

162 
UIÁ8
 
com´essiÚ
,

163 
UIÁ32
 
CÚÃùIpMode
);

175 
QC_WDS_DiscÚÃù
(
UIÁ8
* 
pMsgBuff
,
UIÁ32
 
Ëngth
,
NDIS_QMI_STATUS
* 
²dis_¡©us
,UIÁ8 
æag
);

187 
QCTL_Proûûss_G‘Cl›Á_ID_Re¥Ú£
(
QCQMI
 * 
pQmi
,
UIÁ8
* 
fCl›ÁID
,UIÁ8* 
fQMITy³
);

198 
QCTL_Proûûss_S‘D©aFÜm©_Re¥Ú£
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

210 
QCTL_Proûûss_S‘In¡ªûId_Re¥Ú£
(
QCQMI
* 
pQmi
,* 
fS‘In¡ªûIdFa
,
UIÁ32
* 
fQMI_ID
);

222 
QCTL_Proûûss_R–—£Cl›Á_ID_Re¥Ú£
(
QCQMI
* 
pQmi
,
UIÁ8
* 
fCl›ÁID
,UIÁ8* 
fQMITy³
);

233 
QCTL_Proûûss_G‘V”siÚ_Re¥Ús
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

243 
QCQMI_ProûssQMUXWDSRe¥Ú£
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

254 
QC_WDS_Proûss_G‘RunTimeS‘tšgs_Re¥Ús
(
QCQMUX_MSG_HDR
* 
pQMuxMsg
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

265 
´oûssQMIRe¥Ú£
(*
bufãr
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

276 
QCQMI_ProûssQMUXWDSIndiÿtiÚ
(
QCQMI
* 
pQmi
,
NDIS_QMI_STATUS
* 
²dis_¡©us
);

	@
1
.
0
7
187
driver/doshift/lcdoshift.c
driver/doshift/lcdoshift.h
driver/lctserial.c
driver/ndis/src/lc_cdc_ether.c
driver/ndis/src/qmi_header.h
driver/ndis/src/qmi_oper.c
driver/ndis/src/qmi_oper.h
